<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- PostHog Analytics - Disabled to prevent JS errors -->
    <script>
        // Simple PostHog stub to prevent errors
        window.posthog = {
            capture: function() { console.log('PostHog tracking:', arguments); },
            identify: function() { console.log('PostHog identify:', arguments); }
        };
        console.log('PostHog stub initialized');
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üåü USTAAD DOST</h1>
            <div class="nav-menu">
                <button id="plannerNavBtn" class="nav-button">üìÖ Planner</button>
                <button id="gradingNavBtn" class="nav-button">üìä Grading</button>
                <button id="chatNavBtn" class="nav-button">ü§ñ Chat</button>
                <button id="profileNavBtn" class="nav-button">üë§ Profile</button>
                <div class="user-status">
                    <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                    <span class="session-indicator" id="sessionIndicator"></span>
                </div>
                <a href="#" onclick="logout()" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Dashboard Section -->
        <div id="dashboard" class="dashboard">
            <div class="welcome-section">
                <h1>üéì ÿßÿ≥ÿ™ÿßÿØ ÿØŸàÿ≥ÿ™ - ÿ¢Ÿæ ⁄©€í ÿ≥ÿßÿ™⁄æÿå ÿ¢Ÿæ ⁄©€å ŸÖÿØÿØ ⁄©€í ŸÑ€å€í</h1>
                <p class="welcome-subtitle">Your comprehensive Pakistani teaching assistant for grades 1-5</p>
            </div>
            
            <div class="feature-grid">
                <!-- Yearly Planner Feature -->
                <div class="feature-card yearly-planner">
                    <div class="card-content">
                        <div class="feature-icon">üìÖ</div>
                        <h3>üìÖ Yearly Planner</h3>
                        <p>Academic year planning | ÿ≥ÿßŸÑ ÿ®⁄æÿ± ⁄©ÿß ŸÖŸÜÿµŸàÿ®€Å</p>
                    </div>
                    <button id="yearlyPlannerBtn" class="btn btn-primary btn-large">üìÖ Start Planning</button>
                </div>
                
                <!-- Grading Buddy Feature -->
                <div class="feature-card grading-buddy">
                    <div class="card-content">
                        <div class="feature-icon">üìä</div>
                        <h3>üìä Grading Buddy</h3>
                        <p>Manage classes, tests & grades | ŸÜŸÖÿ®ÿ±Ÿà⁄∫ ⁄©ÿß ŸÜÿ∏ÿßŸÖ</p>
                    </div>
                    <button id="gradingBuddyBtn" class="btn btn-primary btn-large">üìä Grade Management</button>
                </div>
                
                <!-- AI Chatbox Feature -->
                <div class="feature-card ai-chatbox">
                    <div class="card-content">
                        <div class="feature-icon">ü§ñ</div>
                        <h3>ü§ñ AI Assistant</h3>
                        <p>Teaching support in Urdu/English | ÿ™ÿØÿ±€åÿ≥€å ŸÖÿØÿØ</p>
                    </div>
                    <button id="chatbotBtn" class="btn btn-primary btn-large">ü§ñ AI Assistant</button>
                </div>
            </div>
            
            <!-- Quick Stats Section -->
            <div class="stats-section">
                <h2>üìà Quick Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üè´</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Classes Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Students Enrolled</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Assessments Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Weeks Planned</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Yearly Planner Section -->
        <div id="yearlyPlanner" style="display:none;">
            <h2>üìÖ Yearly Planner</h2>
            <p>Loading planner...</p>
        </div>
        
        <!-- Grading Buddy Section -->
        <div id="gradingBuddy" style="display:none;">
            <h2>üìä Grading Buddy</h2>
            <div id="gradingContent"></div>
        </div>
        
        <!-- Chatbot Section -->
        <div id="chatbot" style="display:none;">
            <h2>ü§ñ U-Dost Chat</h2>
            <p>Loading chatbot...</p>
        </div>
        
        <!-- Profile Section -->
        <div id="profileSection" style="display:none;">
            <!-- Will be populated by loadProfileEdit() -->
        </div>
    </main>
    
    <style>
        .navbar {
            background: linear-gradient(135deg, var(--soft-blue), var(--sage-green));
            box-shadow: var(--shadow-md);
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-welcome {
            color: white;
            font-weight: 500;
        }
        
        .nav-button {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .logout-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .logout-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-section h1 {
            color: var(--soft-blue-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: var(--gray-600);
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .feature-card {
            background: var(--warm-white);
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s ease;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .card-content {
            flex: 1;
        }

        .feature-card .btn {
            margin-top: 15px;
            margin-bottom: 0;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            color: var(--gray-700);
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .feature-card p {
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .large-card {
            grid-column: span 2;
        }
        
        
        .yearly-planner, .ai-chatbox {
            border-top: 1px solid var(--gray-200);
        }
        
        
        
        .feature-highlights, .feature-list, .ai-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .highlight, .feature-item, .ai-feature {
            background: var(--soft-blue-light);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--soft-blue), var(--soft-blue-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--sage-green), var(--sage-green-dark));
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--warm-cream-dark), var(--gentle-mint));
            color: var(--gray-700);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-large {
            font-size: 1.1rem;
            padding: 15px 30px;
        }
        
        .stats-section {
            margin-top: 50px;
        }
        
        .stats-section h2 {
            text-align: center;
            color: var(--gray-700);
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            font-size: 2.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--soft-blue-dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .flash-messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(104, 211, 145, 0.1);
            color: var(--success);
            border: 1px solid rgba(104, 211, 145, 0.3);
        }
        
        .alert-error {
            background: rgba(252, 129, 129, 0.1);
            color: var(--danger);
            border: 1px solid rgba(252, 129, 129, 0.3);
        }
        
        .alert-info {
            background: rgba(168, 213, 232, 0.1);
            color: var(--info);
            border: 1px solid rgba(168, 213, 232, 0.3);
        }
        
        /* Profile Edit Styles */
        .profile-edit {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-form {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .profile-form label {
            display: block;
            color: var(--gray-700);
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 15px;
        }
        
        .profile-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .profile-form input:focus {
            outline: none;
            border-color: var(--soft-blue);
        }
        
        .profile-form button {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .profile-form button:hover {
            background: var(--soft-blue-dark);
            transform: translateY(-2px);
        }
        
        /* Section Styles */
        .planner-section, .chatbot-section {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        
        .planner-section h2, .chatbot-section h2 {
            color: var(--soft-blue-dark);
            margin-bottom: 20px;
        }
        
        .planner-section button, .chatbot-section button {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .planner-section button:hover, .chatbot-section button:hover {
            background: var(--soft-blue-dark);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .large-card {
                grid-column: span 1;
            }
            
            .feature-highlights, .feature-list, .ai-features {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .nav-welcome {
                font-size: 0.9rem;
            }
            
            .welcome-section h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .add-students-options {
                flex-direction: column;
            }
            
            .profile-edit {
                padding: 10px;
            }
        }
    </style>
    
    <script>
        // Navigation Functions
        function hideAllSections() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('yearlyPlanner').style.display = 'none';
            document.getElementById('chatbot').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
        }
        
        // Profile Edit Functions
        function loadProfileEdit() {
            document.getElementById('profileSection').innerHTML = `
                <div class="profile-edit">
                    <h2>üë§ Edit Profile</h2>
                    
                    <div class="profile-form">
                        <label>Phone Number:</label>
                        <input type="text" id="profilePhone" value="${getCurrentUser()?.phone || ''}">
                        
                        <label>CNIC:</label>
                        <input type="text" id="profileCNIC" placeholder="12345-1234567-1">
                        
                        <label>Email:</label>
                        <input type="email" id="profileEmail" placeholder="teacher@email.com">
                        
                        <label>Address:</label>
                        <input type="text" id="profileAddress" placeholder="Your Address">
                        
                        <label>Profile Photo:</label>
                        <input type="file" id="profilePhoto" accept="image/*">
                        
                        <button onclick="saveProfile()">üíæ Save Profile</button>
                    </div>
                </div>
            `;
        }
        
        function saveProfile() {
            const profileData = {
                phone: document.getElementById('profilePhone').value,
                cnic: document.getElementById('profileCNIC').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value
            };
            
            localStorage.setItem('teacherProfile', JSON.stringify(profileData));
            alert('‚úÖ Profile updated successfully!');
        }
        
        // Yearly Planner Loading Function
        function loadYearlyPlanner() {
            document.getElementById('yearlyPlanner').innerHTML = `
                <div class="planner-section">
                    <h2>üìÖ Yearly Planner</h2>
                    <p>This is your yearly planning section. Plan your academic year with weekly schedules for all subjects.</p>
                    <button onclick="redirectToPlanner()">üìÖ Open Full Planner</button>
                </div>
            `;
        }
        
        function redirectToPlanner() {
            window.location.href = '{{ url_for("yearly_planner") }}';
        }
        
        // Chatbot Loading Function
        function loadChatbot() {
            document.getElementById('chatbot').innerHTML = `
                <div class="chatbot-section">
                    <h2>ü§ñ U-Dost Chat</h2>
                    <p>AI-powered assistant for Pakistani curriculum, lesson plans, and teaching strategies.</p>
                    <button onclick="redirectToChatbot()">ü§ñ Open Full Chat</button>
                </div>
            `;
        }
        
        function redirectToChatbot() {
            window.location.href = '{{ url_for("chatbot") }}';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add CORRECT listeners for navigation
            setTimeout(function() {
                const plannerBtn = document.getElementById('plannerNavBtn');
                const chatBtn = document.getElementById('chatNavBtn');
                const profileBtn = document.getElementById('profileNavBtn');
                
                if (plannerBtn) {
                    plannerBtn.onclick = function() {
                        console.log('Planner clicked');
                        hideAllSections();
                        document.getElementById('yearlyPlanner').style.display = 'block';
                        loadYearlyPlanner();
                    };
                }
                
                if (chatBtn) {
                    chatBtn.onclick = function() {
                        console.log('Chat clicked');
                        hideAllSections();
                        document.getElementById('chatbot').style.display = 'block';
                        loadChatbot();
                    };
                }
                
                if (profileBtn) {
                    profileBtn.onclick = function() {
                        console.log('Profile clicked');
                        hideAllSections();
                        document.getElementById('profileSection').style.display = 'block';
                        loadProfileEdit();
                    };
                }
                
                const gradingBtn = document.getElementById('gradingNavBtn');
                if (gradingBtn) {
                    gradingBtn.onclick = function() {
                        console.log('Grading clicked');
                        hideAllSections();
                        document.getElementById('gradingBuddy').style.display = 'block';
                        openGradingBuddy();
                    };
                }
            }, 100);
            
            // Track dashboard page view
            setTimeout(function() {
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('dashboard_viewed');
                }
            }, 1500);
            
            // Fix button click handlers for proper navigation
            document.getElementById('yearlyPlannerBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('yearlyPlanner').style.display = 'block';
                loadYearlyPlanner();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Yearly Planner',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('chatbotBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('chatbot').style.display = 'block';
                loadChatbot();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'AI Chatbot',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('gradingBuddyBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('gradingBuddy').style.display = 'block';
                openGradingBuddy();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Grading Buddy',
                        from: 'dashboard'
                    });
                }
            });

        });
        
        // Session management functions
        function getCurrentUser() {
            const savedUser = localStorage.getItem('ustaadDostUser');
            return savedUser ? JSON.parse(savedUser) : null;
        }
        
        function logout() {
            console.log("Logging out user..."); // Debug log
            
            // Clear saved session from localStorage
            localStorage.removeItem('ustaadDostUser');
            
            // Clear any session storage too
            sessionStorage.clear();
            
            console.log("Local session data cleared"); // Debug log
            
            // Redirect to logout endpoint (which will clear server session)
            window.location.href = '/logout';
        }
        
        function updateSessionIndicator() {
            const user = getCurrentUser();
            const indicator = document.getElementById('sessionIndicator');
            
            if (user && indicator) {
                const loginTime = new Date(user.loginTime);
                const timeAgo = formatTimeAgo(loginTime);
                indicator.textContent = `(Session: ${timeAgo})`;
                indicator.style.color = '#28a745';
                console.log("Session indicator updated:", timeAgo); // Debug log
            }
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }
        
        function checkSessionStatus() {
            const user = getCurrentUser();
            
            if (user) {
                const loginTime = user.loginTime;
                const currentTime = new Date().getTime();
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                
                if (currentTime - loginTime > sevenDays) {
                    console.log("Session expired, redirecting to login"); // Debug log
                    localStorage.removeItem('ustaadDostUser');
                    window.location.href = '/login';
                    return false;
                }
                
                // Update session time in localStorage
                user.loginTime = currentTime;
                localStorage.setItem('ustaadDostUser', JSON.stringify(user));
                updateSessionIndicator();
                return true;
            }
            
            console.log("No session found in localStorage"); // Debug log
            return false;
        }
        
        // Store login info in localStorage when dashboard loads
        function handleDashboardLoad() {
            console.log("Dashboard loaded, checking session..."); // Debug log
            
            // Always sync localStorage with Flask session if Flask session exists
            const userPhone = "{{ session.get('phone_number', '') }}";
            const userName = "{{ session.get('user_name', '') }}";
            const loginTime = "{{ session.get('login_time', '') }}";
            
            if (userPhone) {
                console.log("Syncing localStorage with Flask session"); // Debug log
                
                // Parse login time or use current time as fallback
                let sessionStartTime = new Date().getTime();
                if (loginTime) {
                    try {
                        sessionStartTime = new Date(loginTime).getTime();
                    } catch (e) {
                        console.log("Could not parse login_time, using current time"); // Debug log
                    }
                }
                
                // Create or update localStorage session
                localStorage.setItem('ustaadDostUser', JSON.stringify({
                    phone: userPhone,
                    loginTime: sessionStartTime,
                    userData: { name: userName }
                }));
                
                console.log("localStorage session synchronized with server"); // Debug log
            } else {
                console.log("No Flask session found, clearing localStorage"); // Debug log
                localStorage.removeItem('ustaadDostUser');
            }
            
            checkSessionStatus();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', handleDashboardLoad);
        
        // Check session status every 5 minutes
        setInterval(checkSessionStatus, 5 * 60 * 1000);
        
        // COMPREHENSIVE APP TESTING SYSTEM (BACKEND ONLY - REMOVED FROM USER INTERFACE)
        function addTestingMode() {
            // Testing functionality removed from user interface
            // Only available for backend/development use
            return;
        }

        function runFullAppTest() {
            const testResults = [];
            
            console.log("üß™ STARTING COMPREHENSIVE APP TEST...");
            
            // Test all features one by one
            testResults.push(testLoginSystem());
            testResults.push(testNavigation());
            testResults.push(testYearlyPlanner());
            testResults.push(testChatbot());
            testResults.push(testProfileEdit());
            
            // Show results
            displayTestResults(testResults);
        }

        function testLoginSystem() {
            console.log("Testing: Login System");
            
            try {
                // Test session storage
                const testUser = { phone: "03001234567", loginTime: Date.now() };
                localStorage.setItem('ustaadDostUser', JSON.stringify(testUser));
                const retrieved = JSON.parse(localStorage.getItem('ustaadDostUser'));
                
                if (retrieved.phone === testUser.phone) {
                    return { feature: "Login System", status: "‚úÖ PASS", details: "Session storage working" };
                }
            } catch (error) {
                return { feature: "Login System", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Login System", status: "‚ùå FAIL", details: "Session not working" };
        }

        function testNavigation() {
            console.log("Testing: Navigation");
            
            try {
                // Test if navigation elements exist
                const navButtons = [
                    'plannerNavBtn',
                    'chatNavBtn',
                    'profileNavBtn'
                ];
                
                const missingButtons = navButtons.filter(id => !document.getElementById(id));
                
                if (missingButtons.length === 0) {
                    return { feature: "Navigation", status: "‚úÖ PASS", details: "All nav buttons present" };
                } else {
                    return { feature: "Navigation", status: "‚ùå FAIL", details: `Missing: ${missingButtons.join(', ')}` };
                }
            } catch (error) {
                return { feature: "Navigation", status: "‚ùå FAIL", details: error.message };
            }
        }

        function testYearlyPlanner() {
            console.log("Testing: Yearly Planner");
            
            try {
                // Test planner storage
                const testPlan = {
                    schedule: {
                        Monday: { period1: "English", period2: "Math", breakStart: "10:00", breakEnd: "10:20" }
                    }
                };
                
                localStorage.setItem('yearlyPlan', JSON.stringify(testPlan));
                const retrieved = JSON.parse(localStorage.getItem('yearlyPlan'));
                
                if (retrieved.schedule.Monday.period1 === "English") {
                    return { feature: "Yearly Planner", status: "‚úÖ PASS", details: "Plan storage working" };
                }
            } catch (error) {
                return { feature: "Yearly Planner", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Yearly Planner", status: "‚ùå FAIL", details: "Storage not working" };
        }


        function testChatbot() {
            console.log("Testing: U-Dost Chatbot");
            
            try {
                // Test chatbot elements
                const chatElements = ['textInput', 'voiceButton', 'fileUpload'];
                const missingElements = chatElements.filter(id => !document.getElementById(id));
                
                // Test response generation function
                if (typeof generateUDostResponse === 'function') {
                    return { 
                        feature: "U-Dost Chatbot", 
                        status: missingElements.length === 0 ? "‚úÖ PASS" : "‚ö†Ô∏è PARTIAL", 
                        details: missingElements.length === 0 ? "All elements present" : `Missing: ${missingElements.join(', ')}`
                    };
                } else {
                    return { 
                        feature: "U-Dost Chatbot", 
                        status: missingElements.length === 0 ? "‚ö†Ô∏è PARTIAL" : "‚ùå FAIL", 
                        details: missingElements.length === 0 ? "Elements present, function missing" : `Missing elements and function`
                    };
                }
            } catch (error) {
                return { feature: "U-Dost Chatbot", status: "‚ùå FAIL", details: error.message };
            }
        }

        function testProfileEdit() {
            console.log("Testing: Profile Edit");
            
            try {
                // Test profile storage
                const testProfile = {
                    phone: "03001234567",
                    email: "test@teacher.com",
                    cnic: "12345-1234567-1"
                };
                
                localStorage.setItem('teacherProfile', JSON.stringify(testProfile));
                const retrieved = JSON.parse(localStorage.getItem('teacherProfile'));
                
                if (retrieved.email === testProfile.email) {
                    return { feature: "Profile Edit", status: "‚úÖ PASS", details: "Profile storage working" };
                }
            } catch (error) {
                return { feature: "Profile Edit", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Profile Edit", status: "‚ùå FAIL", details: "Profile storage failed" };
        }

        function displayTestResults(results) {
            // Remove existing test results
            const existingResults = document.getElementById('testResults');
            if (existingResults) existingResults.remove();
            
            const resultHTML = `
                <div id="testResults" style="position: fixed; top: 50px; right: 10px; background: white; border: 2px solid #333; padding: 20px; z-index: 9999; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3>üß™ APP TEST RESULTS</h3>
                    ${results.map(result => `
                        <div style="margin: 10px 0; padding: 10px; border-left: 3px solid ${result.status.includes('PASS') ? 'green' : result.status.includes('PARTIAL') ? 'orange' : 'red'};">
                            <strong>${result.feature}</strong><br>
                            Status: ${result.status}<br>
                            Details: ${result.details}
                        </div>
                    `).join('')}
                    
                    <div style="margin-top: 20px;">
                        <button onclick="fixFailedFeatures()" style="background: red; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">üîß Auto-Fix Issues</button>
                        <button onclick="closeTestResults()" style="background: gray; color: white; padding: 10px; margin-left: 10px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', resultHTML);
        }

        function fixFailedFeatures() {
            console.log("üîß Attempting to auto-fix failed features...");
            
            // Auto-create missing elements
            if (!document.getElementById('textInput')) {
                console.log("Creating missing chat input...");
                // Add missing chat elements
            }
            
            if (!document.getElementById('yearlyPlanner')) {
                console.log("Creating missing planner section...");
                // Add missing planner
            }
            
            alert("üîß Auto-fix attempted! Run test again to verify.");
        }

        function closeTestResults() {
            const testResults = document.getElementById('testResults');
            if (testResults) testResults.remove();
        }

        // Test specific chatbot responses
        function testChatbotResponses() {
            const testCases = [
                { grade: "1", subject: "English", topic: "nouns", expected: "noun" },
                { grade: "4", subject: "Islamiyat", topic: "Prophet", expected: "prophet" },
                { grade: "5", subject: "Math", topic: "addition", expected: "addition" }
            ];
            
            testCases.forEach(test => {
                console.log(`Testing: Grade ${test.grade} ${test.subject} ${test.topic}`);
                // Simulate chatbot input and check response
            });
        }

        // Test navigation clicks
        function testAllNavigationClicks() {
            console.log("Testing all navigation clicks...");
            
            // Simulate clicks and check if correct sections open
            const navTests = [
                { button: 'plannerNavBtn', expectedSection: 'yearlyPlanner' },
                { button: 'chatNavBtn', expectedSection: 'chatbot' }
            ];
            
            navTests.forEach(test => {
                // Simulate click and verify section opens
                console.log(`Click test: ${test.button} ‚Üí ${test.expectedSection}`);
            });
        }

        // Testing mode removed from user interface
        // App initialization without testing features
        
        // ==================== GRADING BUDDY SYSTEM ====================
        
        function openGradingBuddy() {
            document.getElementById('gradingBuddy').style.display = 'block';
            showClassesList();
        }

        function showClassesList() {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            
            let html = `
                <div class="classes-section">
                    <h3>Your Classes</h3>
                    <button onclick="createNewClass()" style="background: green; color: white; padding: 15px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚ûï Create New Class
                    </button>
                    
                    <div class="classes-list">
            `;
            
            if (classes.length === 0) {
                html += `<p>No classes created yet.</p>`;
            } else {
                classes.forEach(cls => {
                    html += `
                        <div class="class-card" style="border: 2px solid #333; padding: 15px; margin: 10px; background: #f9f9f9; border-radius: 8px;">
                            <h4>${cls.name}</h4>
                            <p>Students: ${cls.students ? cls.students.length : 0}</p>
                            <p>Tests: ${cls.tests ? cls.tests.length : 0}</p>
                            
                            <button onclick="openClass(${cls.id})" style="background: blue; color: white; padding: 10px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                                üìö Open Class
                            </button>
                        </div>
                    `;
                });
            }
            
            html += `</div></div>`;
            document.getElementById('gradingContent').innerHTML = html;
        }

        function createNewClass() {
            document.getElementById('gradingContent').innerHTML = `
                <div class="create-class-form">
                    <h3>Create New Class</h3>
                    <input type="text" id="newClassName" placeholder="Class Name (e.g., Grade 3-A)" 
                        style="width: 100%; padding: 15px; font-size: 16px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <button onclick="saveNewClass()" style="background: green; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Create Class
                    </button>
                    <button onclick="showClassesList()" style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Cancel
                    </button>
                </div>
            `;
        }

        function saveNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            
            if (!className) {
                alert('Please enter class name!');
                return;
            }
            
            const newClass = {
                id: Date.now(),
                name: className,
                students: [],
                tests: []
            };
            
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            classes.push(newClass);
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Class created successfully!');
            showClassesList();
        }

        function openClass(classId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            if (!currentClass) {
                alert('Class not found!');
                return;
            }
            
            document.getElementById('gradingContent').innerHTML = `
                <div class="class-details">
                    <h3>üìö ${currentClass.name}</h3>
                    
                    <div class="new-test-section" style="text-align: center; margin: 20px 0;">
                        <button onclick="createNewTest(${classId})" 
                            style="background: #007bff; color: white; padding: 20px 40px; font-size: 18px; border-radius: 10px; border: none; cursor: pointer;">
                            ‚ûï Create New Test
                        </button>
                    </div>
                    
                    <div class="class-stats" style="display: flex; gap: 20px; margin: 20px 0;">
                        <div class="stat-box" style="border: 1px solid #ddd; padding: 15px; flex: 1; text-align: center; border-radius: 8px;">
                            <h4>${currentClass.students.length}</h4>
                            <p>Students</p>
                        </div>
                        <div class="stat-box" style="border: 1px solid #ddd; padding: 15px; flex: 1; text-align: center; border-radius: 8px;">
                            <h4>${currentClass.tests ? currentClass.tests.length : 0}</h4>
                            <p>Tests</p>
                        </div>
                    </div>
                    
                    <div class="class-sections">
                        <div class="section" style="margin: 20px 0;">
                            <h4>üë• Manage Students</h4>
                            <button onclick="addStudents(${classId})" style="background: green; color: white; padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                                Add Students
                            </button>
                            <button onclick="viewStudents(${classId})" style="background: blue; color: white; padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                                View Students
                            </button>
                        </div>
                        
                        <div class="section" style="margin: 20px 0;">
                            <h4>üìä Tests & Reports</h4>
                            <button onclick="viewAllTests(${classId})" style="background: purple; color: white; padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                                View All Tests
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="showClassesList()" style="background: gray; color: white; padding: 15px 30px; margin: 20px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚¨ÖÔ∏è Back to Classes
                    </button>
                </div>
            `;
        }

        function addStudents(classId) {
            document.getElementById('gradingContent').innerHTML = `
                <div class="add-students-form">
                    <h3>Add Students to Class</h3>
                    
                    <h4>Bulk Add Students (one name per line):</h4>
                    <textarea id="bulkStudentsInput" placeholder="Ahmed Ali
Fatima Khan
Hassan Ahmed
Ayesha Sheikh
Ali Raza" 
                        style="width: 100%; height: 200px; padding: 15px; font-size: 16px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px;"></textarea>
                    
                    <button onclick="saveBulkStudents(${classId})" 
                        style="background: green; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
                        Add All Students
                    </button>
                    
                    <br><br>
                    
                    <h4>Or add single student:</h4>
                    <input type="text" id="singleStudentInput" placeholder="Student name" 
                        style="width: 100%; padding: 15px; font-size: 16px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px;">
                    <button onclick="addSingleStudent(${classId})" 
                        style="background: blue; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Add Student
                    </button>
                    
                    <br><br>
                    <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Back to Class
                    </button>
                </div>
            `;
        }

        function saveBulkStudents(classId) {
            const bulkText = document.getElementById('bulkStudentsInput').value.trim();
            
            if (!bulkText) {
                alert('Please enter student names!');
                return;
            }
            
            const names = bulkText.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            
            names.forEach(name => {
                const newStudent = {
                    id: Date.now() + Math.random(),
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: '',
                    gender: ''
                };
                classes[classIndex].students.push(newStudent);
            });
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert(`‚úÖ Added ${names.length} students successfully!`);
            openClass(classId);
        }

        function addSingleStudent(classId) {
            const name = document.getElementById('singleStudentInput').value.trim();
            
            if (!name) {
                alert('Please enter student name!');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: name,
                fatherName: '',
                motherName: '',
                contact: '',
                address: '',
                gender: ''
            };
            
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            classes[classIndex].students.push(newStudent);
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            document.getElementById('singleStudentInput').value = '';
            alert('‚úÖ Student added successfully!');
        }

        function viewStudents(classId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            if (!currentClass.students || currentClass.students.length === 0) {
                document.getElementById('gradingContent').innerHTML = `
                    <h3>No students in this class yet.</h3>
                    <button onclick="addStudents(${classId})" style="background: green; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Add Students
                    </button>
                    <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Back
                    </button>
                `;
                return;
            }
            
            let html = `
                <div class="students-view">
                    <h3>üë• Students in ${currentClass.name}</h3>
                    
                    <div class="students-grid">
            `;
            
            currentClass.students.forEach(student => {
                html += `
                    <div class="student-card" style="border: 2px solid #333; padding: 15px; margin: 10px; background: white; border-radius: 8px;">
                        <h4 style="color: #007bff;">${student.name}</h4>
                        <p><strong>Father:</strong> ${student.fatherName || 'Not added'}</p>
                        <p><strong>Contact:</strong> ${student.contact || 'Not added'}</p>
                        
                        <div class="student-actions">
                            <button onclick="editStudent(${classId}, ${student.id})" 
                                style="background: #28a745; color: white; padding: 8px 15px; margin: 3px; border: none; border-radius: 5px; cursor: pointer;">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteStudent(${classId}, ${student.id})" 
                                style="background: #dc3545; color: white; padding: 8px 15px; margin: 3px; border: none; border-radius: 5px; cursor: pointer;">
                                üóëÔ∏è Delete
                            </button>
                            <button onclick="studentReports(${classId}, ${student.id})" 
                                style="background: #007bff; color: white; padding: 8px 15px; margin: 3px; border: none; border-radius: 5px; cursor: pointer;">
                                üìä Reports
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <button onclick="addStudents(${classId})" style="background: green; color: white; padding: 15px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Add More Students
                    </button>
                    <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Back to Class
                    </button>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
        }

        function editStudent(classId, studentId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const student = currentClass.students.find(s => s.id == studentId);
            
            document.getElementById('gradingContent').innerHTML = `
                <div class="edit-student-form">
                    <h3>‚úèÔ∏è Edit Student Profile</h3>
                    
                    <label>Student Name:</label>
                    <input type="text" id="editName" value="${student.name}" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Father's Name:</label>
                    <input type="text" id="editFather" value="${student.fatherName || ''}" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                    <label>Mother's Name:</label>
                    <input type="text" id="editMother" value="${student.motherName || ''}" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Guardian Contact:</label>
                    <input type="tel" id="editContact" value="${student.contact || ''}" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Address:</label>
                    <input type="text" id="editAddress" value="${student.address || ''}" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Gender:</label>
                    <select id="editGender" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">Select Gender</option>
                        <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                    </select>
                    
                    <button onclick="saveStudentEdit(${classId}, ${studentId})" 
                        style="background: green; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Save Changes
                    </button>
                    <button onclick="viewStudents(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Cancel
                    </button>
                </div>
            `;
        }

        function saveStudentEdit(classId, studentId) {
            const name = document.getElementById('editName').value.trim();
            const father = document.getElementById('editFather').value.trim();
            const mother = document.getElementById('editMother').value.trim();
            const contact = document.getElementById('editContact').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const gender = document.getElementById('editGender').value;
            
            if (!name) {
                alert('Student name is required!');
                return;
            }
            
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            const studentIndex = classes[classIndex].students.findIndex(s => s.id == studentId);
            
            classes[classIndex].students[studentIndex] = {
                id: studentId,
                name: name,
                fatherName: father,
                motherName: mother,
                contact: contact,
                address: address,
                gender: gender
            };
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Student profile updated!');
            viewStudents(classId);
        }

        function deleteStudent(classId, studentId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const student = currentClass.students.find(s => s.id == studentId);
            
            if (confirm(`Delete ${student.name}? This cannot be undone.`)) {
                let updatedClasses = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
                const classIndex = updatedClasses.findIndex(c => c.id == classId);
                
                updatedClasses[classIndex].students = updatedClasses[classIndex].students.filter(s => s.id != studentId);
                localStorage.setItem(userPhone + '_classes', JSON.stringify(updatedClasses));
                
                alert('‚úÖ Student deleted!');
                viewStudents(classId);
            }
        }

        function studentReports(classId, studentId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const student = currentClass.students.find(s => s.id == studentId);
            
            let html = `
                <div class="student-reports">
                    <h3>üìä Reports for ${student.name}</h3>
                    
                    <div class="report-options" style="margin: 20px 0;">
                        <button onclick="generateFullReport(${classId}, ${studentId})" 
                            style="background: #007bff; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üìÑ Full Progress Report
                        </button>
                        <button onclick="generateSubjectReport(${classId}, ${studentId})" 
                            style="background: #28a745; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üìö Subject-wise Report
                        </button>
                    </div>
                    
                    <button onclick="viewStudents(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 20px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚¨ÖÔ∏è Back to Students
                    </button>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
        }

        function generateFullReport(classId, studentId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const student = currentClass.students.find(s => s.id == studentId);
            
            let printContent = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>üìä Progress Report</h2>
                    <h3>${student.name}</h3>
                    <p><strong>Class:</strong> ${currentClass.name}</p>
                    <p><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</p>
                    <p><strong>Report Date:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 10px;">Subject</th>
                        <th style="padding: 10px;">Test</th>
                        <th style="padding: 10px;">Marks/Grade</th>
                    </tr>
            `;
            
            if (!currentClass.tests || currentClass.tests.length === 0) {
                printContent += `
                    <tr>
                        <td colspan="3" style="padding: 10px; text-align: center;">No test records available</td>
                    </tr>
                `;
            } else {
                currentClass.tests.forEach(test => {
                    const score = test.scores.find(s => s.studentId == studentId);
                    if (score) {
                        printContent += `
                            <tr>
                                <td style="padding: 10px;">${test.subject}</td>
                                <td style="padding: 10px;">${test.topic}</td>
                                <td style="padding: 10px;">${test.method === 'marks' ? score.obtainedMarks + '/' + test.totalMarks : score.status}</td>
                            </tr>
                        `;
                    }
                });
            }
            
            printContent += `
                </table>
                
                <div style="margin-top: 40px;">
                    <p><strong>Teacher's Comments:</strong> _________________________________</p>
                    <p><strong>Teacher's Signature:</strong> ____________________________</p>
                    <p><strong>Parent's Signature:</strong> ____________________________</p>
                </div>
            `;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Progress Report - ${student.name}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function generateSubjectReport(classId, studentId) {
            alert('Subject-wise report will show detailed performance per subject');
            generateFullReport(classId, studentId);
        }

        function createNewTest(classId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            document.getElementById('gradingContent').innerHTML = `
                <div class="create-test-form">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h3 style="margin: 0; color: #007bff;">üìù Create New Test for ${currentClass.name}</h3>
                        <p style="margin: 5px 0 0 0; color: #666;">Students in this test: ${currentClass.students.length}</p>
                    </div>
                    
                    <label>Subject:</label>
                    <select id="testSubject" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">Select Subject</option>
                        <option value="English">English</option>
                        <option value="Math">Math</option>
                        <option value="Urdu">Urdu</option>
                        <option value="Islamiyat">Islamiyat</option>
                        <option value="Science">Science</option>
                        <option value="Social Studies">Social Studies</option>
                        <option value="General Knowledge">General Knowledge</option>
                    </select>
                    
                    <label>Topic/Chapter:</label>
                    <input type="text" id="testTopic" placeholder="e.g., Chapter 5 - Nouns" 
                        style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Test Type:</label>
                    <select id="testType" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">Select Type</option>
                        <option value="Written Test">Written Test</option>
                        <option value="Oral Test">Oral Test</option>
                        <option value="Quiz">Quiz</option>
                        <option value="Assignment">Assignment</option>
                        <option value="Homework">Homework</option>
                    </select>
                    
                    <label>Assessment Method:</label>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin: 5px 0;">
                            <input type="radio" name="assessmentMethod" value="marks" checked> 
                            Marks Based (e.g., 85/100)
                        </label>
                        <label style="display: block; margin: 5px 0;">
                            <input type="radio" name="assessmentMethod" value="tick"> 
                            Tick/Cross Based
                        </label>
                    </div>
                    
                    <div id="totalMarksSection">
                        <label>Total Marks:</label>
                        <input type="number" id="totalMarks" placeholder="100" 
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <button onclick="generateTest(${classId})" 
                        style="background: blue; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
                        Generate Test
                    </button>
                    <button onclick="openClass(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Cancel
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                document.querySelectorAll('input[name="assessmentMethod"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'tick') {
                            document.getElementById('totalMarksSection').style.display = 'none';
                        } else {
                            document.getElementById('totalMarksSection').style.display = 'block';
                        }
                    });
                });
            }, 100);
        }

        function generateTest(classId) {
            const subject = document.getElementById('testSubject').value;
            const topic = document.getElementById('testTopic').value;
            const testType = document.getElementById('testType').value;
            const method = document.querySelector('input[name="assessmentMethod"]:checked').value;
            const totalMarks = document.getElementById('totalMarks').value;
            
            if (!subject || !topic || !testType) {
                alert('Please fill all required fields!');
                return;
            }
            
            if (method === 'marks' && !totalMarks) {
                alert('Please enter total marks!');
                return;
            }
            
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            if (!currentClass.students || currentClass.students.length === 0) {
                alert('Please add students first!');
                addStudents(classId);
                return;
            }
            
            if (method === 'marks') {
                showMarksTest(classId, subject, topic, testType, totalMarks);
            } else {
                // Store test details for tick/cross assessment
                window.currentTestSubject = subject;
                window.currentTestTopic = topic;
                window.currentTestType = testType;
                showTickTest(classId, subject, topic, testType);
            }
        }

        function showMarksTest(classId, subject, topic, testType, totalMarks) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            let html = `
                <div class="marks-test">
                    <div id="printableTest">
                        <div style="text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                            <h2 style="margin: 0; color: white;">${currentClass.name}</h2>
                            <h3 style="margin: 10px 0; color: white;">${subject} - ${topic}</h3>
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${testType} | <strong>Total Marks:</strong> ${totalMarks}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date().toLocaleDateString()} | <strong>Students:</strong> ${currentClass.students.length}</p>
                        </div>
                        
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 10px;">Roll No.</th>
                                <th style="padding: 10px;">Student Name</th>
                                <th style="padding: 10px;">Obtained Marks</th>
                                <th style="padding: 10px;">Percentage</th>
                                <th style="padding: 10px;">Grade</th>
                            </tr>
            `;
            
            currentClass.students.forEach((student, index) => {
                html += `
                    <tr>
                        <td style="padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px;">${student.name}</td>
                        <td style="padding: 10px; text-align: center;">
                            <input type="number" id="marks_${student.id}" max="${totalMarks}" min="0" 
                                onchange="calculateGrade(${student.id}, ${totalMarks})"
                                style="width: 80px; padding: 5px; text-align: center;">
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <span id="percent_${student.id}">-</span>
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <span id="grade_${student.id}">-</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin: 20px;">
                        <button onclick="saveMarksTest(${classId}, '${subject}', '${topic}', '${testType}', ${totalMarks})" 
                            style="background: green; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üíæ Save Test Results
                        </button>
                        <button onclick="printTest()" 
                            style="background: blue; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üñ®Ô∏è Print Test
                        </button>
                        <button onclick="openClass(${classId})" 
                            style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
        }

        function calculateGrade(studentId, totalMarks) {
            const marksInput = document.getElementById('marks_' + studentId);
            const obtainedMarks = parseFloat(marksInput.value) || 0;
            const percentage = ((obtainedMarks / totalMarks) * 100).toFixed(2);
            
            document.getElementById('percent_' + studentId).textContent = percentage + '%';
            
            let grade = 'F';
            if (percentage >= 90) grade = 'A+';
            else if (percentage >= 80) grade = 'A';
            else if (percentage >= 70) grade = 'B';
            else if (percentage >= 60) grade = 'C';
            else if (percentage >= 50) grade = 'D';
            else if (percentage >= 40) grade = 'E';
            
            document.getElementById('grade_' + studentId).textContent = grade;
        }

        function saveMarksTest(classId, subject, topic, testType, totalMarks) {
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            const currentClass = classes[classIndex];
            
            const scores = [];
            currentClass.students.forEach(student => {
                const marksInput = document.getElementById('marks_' + student.id);
                const obtainedMarks = parseFloat(marksInput.value) || 0;
                const percentage = ((obtainedMarks / totalMarks) * 100).toFixed(2);
                
                scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    obtainedMarks: obtainedMarks,
                    percentage: percentage
                });
            });
            
            const newTest = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                testType: testType,
                method: 'marks',
                totalMarks: totalMarks,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                scores: scores
            };
            
            if (!classes[classIndex].tests) {
                classes[classIndex].tests = [];
            }
            classes[classIndex].tests.push(newTest);
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Test results saved successfully!');
            openClass(classId);
        }

        function showTickTest(classId, subject, topic, testType) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            let html = `
                <div class="tick-test">
                    <div style="text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h2 style="margin: 0; color: white;">${currentClass.name}</h2>
                        <h3 style="margin: 10px 0; color: white;">${subject} - ${topic}</h3>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${testType} | <strong>Assessment:</strong> Tick/Cross</p>
                        <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date().toLocaleDateString()} | <strong>Students:</strong> ${currentClass.students.length}</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="margin: 0 0 10px 0;">üìù Add Tasks to Assess</h4>
                        <div id="tasksList"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="newTaskInput" placeholder="Enter task name (e.g., Homework Completed, Brought Book)" 
                                style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <button onclick="addTaskToList()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                ‚ûï Add Task
                            </button>
                        </div>
                    </div>
                    
                    <div id="tickTableContainer"></div>
                    
                    <div style="text-align: center; margin: 20px;">
                        <button onclick="generateTickTable(${classId})" 
                            style="background: #007bff; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üìã Generate Assessment Table
                        </button>
                        <button onclick="openClass(${classId})" 
                            style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
            
            // Initialize tasks array
            window.currentTasks = [];
        }
        
        function addTaskToList() {
            const taskInput = document.getElementById('newTaskInput');
            const taskName = taskInput.value.trim();
            
            if (!taskName) {
                alert('Please enter a task name!');
                return;
            }
            
            if (!window.currentTasks) {
                window.currentTasks = [];
            }
            
            window.currentTasks.push(taskName);
            taskInput.value = '';
            
            // Update tasks display
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = window.currentTasks.map((task, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 5px; margin: 5px 0;">
                    <span style="font-weight: 500;">${index + 1}. ${task}</span>
                    <button onclick="removeTask(${index})" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                        üóëÔ∏è Remove
                    </button>
                </div>
            `).join('');
        }
        
        function removeTask(index) {
            window.currentTasks.splice(index, 1);
            addTaskToList(); // Refresh display
        }
        
        function generateTickTable(classId) {
            if (!window.currentTasks || window.currentTasks.length === 0) {
                alert('Please add at least one task!');
                return;
            }
            
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            let tableHtml = `
                <div style="overflow-x: auto;">
                    <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px; position: sticky; left: 0; background: #f2f2f2;">Roll No.</th>
                            <th style="padding: 10px; position: sticky; left: 60px; background: #f2f2f2;">Student Name</th>
            `;
            
            // Add task columns
            window.currentTasks.forEach(task => {
                tableHtml += `<th style="padding: 10px; min-width: 100px;">${task}</th>`;
            });
            
            tableHtml += `</tr>`;
            
            // Add student rows
            currentClass.students.forEach((student, index) => {
                tableHtml += `
                    <tr>
                        <td style="padding: 10px; text-align: center; position: sticky; left: 0; background: white;">${index + 1}</td>
                        <td style="padding: 10px; position: sticky; left: 60px; background: white; font-weight: 500;">${student.name}</td>
                `;
                
                window.currentTasks.forEach((task, taskIndex) => {
                    tableHtml += `
                        <td style="padding: 10px; text-align: center;">
                            <select id="task_${student.id}_${taskIndex}" style="padding: 5px; font-size: 14px; width: 100%;">
                                <option value="">-</option>
                                <option value="‚úì">‚úì</option>
                                <option value="‚úó">‚úó</option>
                            </select>
                        </td>
                    `;
                });
                
                tableHtml += `</tr>`;
            });
            
            tableHtml += `
                    </table>
                </div>
                
                <div style="text-align: center; margin: 20px;">
                    <button onclick="saveMultiTaskTickTest(${classId})" 
                        style="background: green; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        üíæ Save Assessment Results
                    </button>
                </div>
            `;
            
            document.getElementById('tickTableContainer').innerHTML = tableHtml;
        }

        function saveMultiTaskTickTest(classId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            const currentClass = classes[classIndex];
            
            // Get test details from global context
            const subject = window.currentTestSubject;
            const topic = window.currentTestTopic;
            const testType = window.currentTestType;
            
            const scores = [];
            currentClass.students.forEach(student => {
                const taskResults = {};
                window.currentTasks.forEach((task, taskIndex) => {
                    const taskSelect = document.getElementById(`task_${student.id}_${taskIndex}`);
                    taskResults[task] = taskSelect.value || '-';
                });
                
                scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    tasks: taskResults
                });
            });
            
            const newTest = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                testType: testType,
                method: 'tick_multi',
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                tasks: window.currentTasks,
                scores: scores
            };
            
            if (!classes[classIndex].tests) {
                classes[classIndex].tests = [];
            }
            classes[classIndex].tests.push(newTest);
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Multi-task assessment saved successfully!');
            openClass(classId);
        }

        function viewAllTests(classId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            
            if (!currentClass.tests || currentClass.tests.length === 0) {
                document.getElementById('gradingContent').innerHTML = `
                    <h3>No tests created yet.</h3>
                    <button onclick="createNewTest(${classId})" style="background: blue; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Create First Test
                    </button>
                    <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Back
                    </button>
                `;
                return;
            }
            
            let html = `
                <div class="all-tests">
                    <h3>üìä All Tests for ${currentClass.name}</h3>
                    
                    <div class="tests-list">
            `;
            
            currentClass.tests.forEach(test => {
                html += `
                    <div class="test-card" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 8px;">
                        <h4>${test.subject} - ${test.topic}</h4>
                        <p><strong>Type:</strong> ${test.testType} | <strong>Method:</strong> ${test.method === 'marks' ? 'Marks Based' : (test.method === 'tick_multi' ? 'Multi-Task Tick/Cross' : 'Tick/Cross')}</p>
                        <p><strong>Date:</strong> ${test.date} ${test.time}</p>
                        ${test.method === 'marks' ? `<p><strong>Total Marks:</strong> ${test.totalMarks}</p>` : ''}
                        
                        <button onclick="viewTestResults(${classId}, ${test.id})" 
                            style="background: blue; color: white; padding: 8px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                            üëÅÔ∏è View Results
                        </button>
                        <button onclick="printTestResults(${classId}, ${test.id})" 
                            style="background: green; color: white; padding: 8px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer;">
                            üñ®Ô∏è Print Results
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <button onclick="createNewTest(${classId})" 
                        style="background: blue; color: white; padding: 15px 30px; margin: 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚ûï Create New Test
                    </button>
                    <button onclick="openClass(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        ‚¨ÖÔ∏è Back to Class
                    </button>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
        }

        function viewTestResults(classId, testId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const test = currentClass.tests.find(t => t.id == testId);
            
            let html = `
                <div class="test-results">
                    <h3>üìä ${test.subject} - ${test.topic} Results</h3>
                    <p><strong>Type:</strong> ${test.testType} | <strong>Date:</strong> ${test.date}</p>
                    
                    <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px;">Student Name</th>
            `;
            
            if (test.method === 'marks') {
                html += `
                            <th style="padding: 8px;">Obtained Marks</th>
                            <th style="padding: 8px;">Total Marks</th>
                            <th style="padding: 8px;">Percentage</th>
                        </tr>
                `;
                
                test.scores.forEach(score => {
                    html += `
                        <tr>
                            <td style="padding: 8px;">${score.studentName}</td>
                            <td style="padding: 8px;">${score.obtainedMarks}</td>
                            <td style="padding: 8px;">${test.totalMarks}</td>
                            <td style="padding: 8px;">${score.percentage}%</td>
                        </tr>
                    `;
                });
            } else if (test.method === 'tick_multi') {
                // Multi-task tick/cross display
                test.tasks.forEach(task => {
                    html += `<th style="padding: 8px;">${task}</th>`;
                });
                html += `</tr>`;
                
                test.scores.forEach(score => {
                    html += `<tr><td style="padding: 8px; font-weight: 500;">${score.studentName}</td>`;
                    test.tasks.forEach(task => {
                        const mark = score.tasks[task] || '-';
                        const color = mark === '‚úì' ? 'green' : (mark === '‚úó' ? 'red' : 'gray');
                        html += `<td style="padding: 8px; text-align: center; color: ${color}; font-weight: bold; font-size: 18px;">${mark}</td>`;
                    });
                    html += `</tr>`;
                });
            } else {
                html += `
                            <th style="padding: 8px;">Status</th>
                        </tr>
                `;
                
                test.scores.forEach(score => {
                    html += `
                        <tr>
                            <td style="padding: 8px;">${score.studentName}</td>
                            <td style="padding: 8px; color: ${score.completed ? 'green' : 'red'};">
                                ${score.status}
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </table>
                    
                    <div style="text-align: center; margin: 20px;">
                        <button onclick="printTestResults(${classId}, ${testId})" 
                            style="background: green; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üñ®Ô∏è Print Results
                        </button>
                        <button onclick="viewAllTests(${classId})" 
                            style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚¨ÖÔ∏è Back to Tests
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gradingContent').innerHTML = html;
        }

        function printTestResults(classId, testId) {
            const userPhone = getCurrentUser()?.phone || 'default';
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id == classId);
            const test = currentClass.tests.find(t => t.id == testId);
            
            let printContent = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>${test.subject} - ${test.topic}</h2>
                    <h3>Test Results</h3>
                    <p><strong>Class:</strong> ${currentClass.name}</p>
                    <p><strong>Type:</strong> ${test.testType} | <strong>Date:</strong> ${test.date}</p>
                </div>
                
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 10px;">Student Name</th>
            `;
            
            if (test.method === 'marks') {
                printContent += `
                        <th style="padding: 10px;">Obtained Marks</th>
                        <th style="padding: 10px;">Total Marks</th>
                        <th style="padding: 10px;">Percentage</th>
                    </tr>
                `;
                
                test.scores.forEach(score => {
                    printContent += `
                        <tr>
                            <td style="padding: 10px;">${score.studentName}</td>
                            <td style="padding: 10px; text-align: center;">${score.obtainedMarks}</td>
                            <td style="padding: 10px; text-align: center;">${test.totalMarks}</td>
                            <td style="padding: 10px; text-align: center;">${score.percentage}%</td>
                        </tr>
                    `;
                });
            } else if (test.method === 'tick_multi') {
                // Multi-task print format
                test.tasks.forEach(task => {
                    printContent += `<th style="padding: 10px;">${task}</th>`;
                });
                printContent += `</tr>`;
                
                test.scores.forEach(score => {
                    printContent += `<tr><td style="padding: 10px; font-weight: 500;">${score.studentName}</td>`;
                    test.tasks.forEach(task => {
                        const mark = score.tasks[task] || '-';
                        printContent += `<td style="padding: 10px; text-align: center; font-weight: bold; font-size: 16px;">${mark}</td>`;
                    });
                    printContent += `</tr>`;
                });
            } else {
                printContent += `
                        <th style="padding: 10px;">Status</th>
                    </tr>
                `;
                
                test.scores.forEach(score => {
                    printContent += `
                        <tr>
                            <td style="padding: 10px;">${score.studentName}</td>
                            <td style="padding: 10px; text-align: center;">${score.status}</td>
                        </tr>
                    `;
                });
            }
            
            printContent += `</table>`;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Test Results - ${test.subject}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printTest() {
            const printContent = document.getElementById('printableTest').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Test Sheet</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                        input { border: none; width: 100%; text-align: center; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // ==================== END GRADING BUDDY SYSTEM ====================
    </script>
</body>
</html>