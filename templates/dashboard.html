<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]);var n=t;if("undefined"!=typeof e){for(var p=0;p<o.length-1;p++)n[o[p]]=n[o[p]]||{},n=n[o[p]];n[o[o.length-1]]=i}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".com",".com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getGroups create_alias get_distinct_id get_session_id capture_pageview capture_pageleave register_for_session unregister_for_session".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        
        // Initialize PostHog with delay to ensure script loads
        setTimeout(function() {
            try {
                if (typeof posthog !== 'undefined' && posthog.init) {
                    posthog.init('{{ posthog_key }}', {
                        api_host: '{{ posthog_host }}'
                    });
                    console.log('PostHog initialized successfully');
                } else {
                    throw new Error('PostHog not loaded');
                }
            } catch (error) {
                console.log('PostHog initialization failed:', error);
                window.posthog = {
                    capture: function() { console.log('PostHog tracking:', arguments); },
                    identify: function() { console.log('PostHog identify:', arguments); }
                };
            }
        }, 1000);
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üåü USTAAD DOST</h1>
            <div class="nav-menu">
                <button id="plannerNavBtn" class="nav-button">üìÖ Planner</button>
                <button id="gradingNavBtn" class="nav-button">üìä Grading</button>
                <button id="chatNavBtn" class="nav-button">ü§ñ Chat</button>
                <button id="profileNavBtn" class="nav-button">üë§ Profile</button>
                <div class="user-status">
                    <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                    <span class="session-indicator" id="sessionIndicator"></span>
                </div>
                <a href="#" onclick="logout()" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Dashboard Section -->
        <div id="dashboard" class="dashboard">
            <div class="welcome-section">
                <h1>üéì ÿßÿ≥ÿ™ÿßÿØ ÿØŸàÿ≥ÿ™ ŸÖ€å⁄∫ ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ</h1>
                <p class="welcome-subtitle">Your comprehensive Pakistani teaching assistant for grades 1-5</p>
            </div>
            
            <div class="feature-grid">
                <!-- Yearly Planner Feature -->
                <div class="feature-card large-card yearly-planner">
                    <div class="feature-icon">üìÖ</div>
                    <h3>üìö Yearly Planner</h3>
                    <p>Plan your entire academic year with weekly schedules for all subjects (Math, English, Urdu, Islamiyat, General Knowledge, Social Studies, Science) across grades 1-5.</p>
                    <div class="feature-highlights">
                        <div class="highlight">üìù Weekly Templates</div>
                        <div class="highlight">üìä Auto-Population</div>
                        <div class="highlight">‚úèÔ∏è Editable Entries</div>
                        <div class="highlight">üìà Progress Tracking</div>
                    </div>
                    <button id="yearlyPlannerBtn" class="btn btn-primary btn-large">üìÖ Start Planning</button>
                </div>
                
                <!-- Grading Buddy Feature -->
                <div class="feature-card grading-buddy">
                    <div class="feature-icon">üìä</div>
                    <h3>üéØ Grading Buddy</h3>
                    <p>Manage your classes, students, and assessments with comprehensive grading tools and PDF report generation.</p>
                    <div class="feature-list">
                        <div class="feature-item">üë• Class Management</div>
                        <div class="feature-item">üìù Custom Scoresheets</div>
                        <div class="feature-item">‚úÖ Screener Grading</div>
                        <div class="feature-item">üìÑ PDF Reports</div>
                    </div>
                    <button id="gradingBuddyBtn" class="btn btn-secondary">üìä Manage Grades</button>
                </div>
                
                <!-- AI Chatbox Feature -->
                <div class="feature-card ai-chatbox">
                    <div class="feature-icon">ü§ñ</div>
                    <h3>üí¨ AI Assistant</h3>
                    <p>Get AI-powered lesson plans, teaching strategies, activities, and assessments tailored to Pakistani curriculum.</p>
                    <div class="ai-features">
                        <div class="ai-feature">üìñ Lesson Plans</div>
                        <div class="ai-feature">üéØ Teaching Strategies</div>
                        <div class="ai-feature">üéÆ Activities & Games</div>
                        <div class="ai-feature">üìã Assessments</div>
                    </div>
                    <button id="chatbotBtn" class="btn btn-accent">ü§ñ AI Assistant</button>
                </div>
            </div>
            
            <!-- Quick Stats Section -->
            <div class="stats-section">
                <h2>üìà Quick Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üè´</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Classes Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Students Enrolled</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Assessments Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Weeks Planned</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Yearly Planner Section -->
        <div id="yearlyPlanner" style="display:none;">
            <h2>üìÖ Yearly Planner</h2>
            <p>Loading planner...</p>
        </div>
        
        <!-- Grading Buddy Section -->
        <div id="gradingBuddy" style="display:none;">
            <!-- Will be populated by loadGradingBuddy() -->
        </div>
        
        <!-- Chatbot Section -->
        <div id="chatbot" style="display:none;">
            <h2>ü§ñ U-Dost Chat</h2>
            <p>Loading chatbot...</p>
        </div>
        
        <!-- Profile Section -->
        <div id="profileSection" style="display:none;">
            <!-- Will be populated by loadProfileEdit() -->
        </div>
    </main>
    
    <style>
        .navbar {
            background: linear-gradient(135deg, var(--soft-blue), var(--sage-green));
            box-shadow: var(--shadow-md);
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-welcome {
            color: white;
            font-weight: 500;
        }
        
        .nav-button {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .logout-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .logout-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-section h1 {
            color: var(--soft-blue-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: var(--gray-600);
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .feature-card {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .large-card {
            grid-column: span 2;
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .yearly-planner {
            border-top: 5px solid var(--soft-blue);
        }
        
        .grading-buddy {
            border-top: 5px solid var(--sage-green);
        }
        
        .ai-chatbox {
            border-top: 5px solid var(--warm-cream-dark);
        }
        
        .feature-card h3 {
            color: var(--gray-700);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .feature-card p {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .feature-highlights {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .highlight {
            background: var(--gentle-mint-light);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .feature-list, .ai-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .feature-item, .ai-feature {
            background: var(--soft-blue-light);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--soft-blue), var(--soft-blue-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--sage-green), var(--sage-green-dark));
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--warm-cream-dark), var(--gentle-mint));
            color: var(--gray-700);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-large {
            font-size: 1.1rem;
            padding: 15px 30px;
        }
        
        .stats-section {
            margin-top: 50px;
        }
        
        .stats-section h2 {
            text-align: center;
            color: var(--gray-700);
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            font-size: 2.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--soft-blue-dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .flash-messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(104, 211, 145, 0.1);
            color: var(--success);
            border: 1px solid rgba(104, 211, 145, 0.3);
        }
        
        .alert-error {
            background: rgba(252, 129, 129, 0.1);
            color: var(--danger);
            border: 1px solid rgba(252, 129, 129, 0.3);
        }
        
        .alert-info {
            background: rgba(168, 213, 232, 0.1);
            color: var(--info);
            border: 1px solid rgba(168, 213, 232, 0.3);
        }
        
        @media (max-width: 768px) {
            .large-card {
                grid-column: span 1;
            }
            
            .feature-highlights, .feature-list, .ai-features {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .nav-welcome {
                font-size: 0.9rem;
            }
            
            .welcome-section h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    
    <script>
        // Navigation Functions
        function hideAllSections() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('yearlyPlanner').style.display = 'none';
            document.getElementById('gradingBuddy').style.display = 'none';
            document.getElementById('chatbot').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
        }
        
        // Grading Buddy Functions
        function loadGradingBuddy() {
            document.getElementById('gradingBuddy').innerHTML = `
                <div class="grading-container">
                    <h2>üìä Grading Buddy</h2>
                    
                    <div class="class-management">
                        <h3>Your Classes</h3>
                        <button onclick="addClass()" class="add-btn">‚ûï Add New Class</button>
                        
                        <div id="classList">
                            <!-- Classes will appear here -->
                        </div>
                    </div>
                    
                    <div id="addClassForm" style="display:none;">
                        <h3>Create New Class</h3>
                        <input type="text" id="className" placeholder="Class Name (e.g., Grade 3-A)">
                        <input type="text" id="classSubject" placeholder="Subject">
                        <button onclick="saveClass()">Save Class</button>
                        <button onclick="cancelAddClass()">Cancel</button>
                    </div>
                    
                    <div id="classDetails" style="display:none;">
                        <!-- Individual class management will load here -->
                    </div>
                </div>
            `;
            
            loadExistingClasses();
        }
        
        function addClass() {
            document.getElementById('addClassForm').style.display = 'block';
        }
        
        function cancelAddClass() {
            document.getElementById('addClassForm').style.display = 'none';
            document.getElementById('className').value = '';
            document.getElementById('classSubject').value = '';
        }
        
        function saveClass() {
            const className = document.getElementById('className').value;
            const subject = document.getElementById('classSubject').value;
            
            if (className && subject) {
                // Save class to storage
                const newClass = {
                    id: Date.now(),
                    name: className,
                    subject: subject,
                    students: []
                };
                
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                classes.push(newClass);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                
                // Refresh class list
                loadExistingClasses();
                document.getElementById('addClassForm').style.display = 'none';
                document.getElementById('className').value = '';
                document.getElementById('classSubject').value = '';
            } else {
                alert('Please enter both class name and subject!');
            }
        }
        
        function loadExistingClasses() {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classListDiv = document.getElementById('classList');
            
            classListDiv.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <h4>${cls.name} - ${cls.subject}</h4>
                    <p>Students: ${cls.students.length}</p>
                    <button onclick="openClass(${cls.id})">üìö Open Class</button>
                    <button onclick="editClass(${cls.id})">‚úèÔ∏è Edit</button>
                </div>
            `).join('');
        }
        
        function openClass(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass) {
                alert('Class not found!');
                return;
            }
            
            document.getElementById('classDetails').style.display = 'block';
            document.getElementById('classDetails').innerHTML = `
                <div class="class-detail-view">
                    <h3>üìö ${currentClass.name} - ${currentClass.subject}</h3>
                    
                    <div class="student-management">
                        <h4>Students (${currentClass.students.length})</h4>
                        
                        <div class="add-students-options">
                            <button onclick="manualAddStudent(${classId})">‚ûï Add Student Manually</button>
                            <button onclick="uploadStudentPicture(${classId})">üì∏ Upload Student List Picture</button>
                        </div>
                        
                        <div id="pictureUpload_${classId}" style="display:none;">
                            <input type="file" id="studentListImage_${classId}" accept="image/*">
                            <button onclick="extractStudentNames(${classId})">Extract Names from Picture</button>
                        </div>
                        
                        <div id="studentList_${classId}">
                            ${currentClass.students.map(student => `
                                <div class="student-profile">
                                    <h5>${student.name}</h5>
                                    <p>Father: ${student.fatherName || 'Not added'}</p>
                                    <p>Mother: ${student.motherName || 'Not added'}</p>
                                    <p>Contact: ${student.contact || 'Not added'}</p>
                                    <button onclick="editStudentProfile(${classId}, ${student.id})">‚úèÔ∏è Edit Profile</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function uploadStudentPicture(classId) {
            document.getElementById(`pictureUpload_${classId}`).style.display = 'block';
        }
        
        function extractStudentNames(classId) {
            // Simulate name extraction (you can add OCR later)
            const extractedNames = [
                "Ahmed Ali", "Fatima Sheikh", "Hassan Khan", "Ayesha Ahmad", "Ali Raza"
            ];
            
            // Add these students to class
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            if (classIndex === -1) {
                alert('Class not found!');
                return;
            }
            
            extractedNames.forEach(name => {
                classes[classIndex].students.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: ''
                });
            });
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            // Refresh class view
            openClass(classId);
            alert(`‚úÖ Added ${extractedNames.length} students from picture!`);
        }
        
        function manualAddStudent(classId) {
            const studentName = prompt('Enter student name:');
            if (!studentName) return;
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            if (classIndex === -1) {
                alert('Class not found!');
                return;
            }
            
            classes[classIndex].students.push({
                id: Date.now(),
                name: studentName,
                fatherName: '',
                motherName: '',
                contact: '',
                address: ''
            });
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            openClass(classId);
        }
        
        function editStudentProfile(classId, studentId) {
            alert('Student profile editing will be available in next update!');
        }
        
        function editClass(classId) {
            alert('Class editing will be available in next update!');
        }
        
        // Profile Edit Functions
        function loadProfileEdit() {
            document.getElementById('profileSection').innerHTML = `
                <div class="profile-edit">
                    <h2>üë§ Edit Profile</h2>
                    
                    <div class="profile-form">
                        <label>Phone Number:</label>
                        <input type="text" id="profilePhone" value="${getCurrentUser()?.phone || ''}">
                        
                        <label>CNIC:</label>
                        <input type="text" id="profileCNIC" placeholder="12345-1234567-1">
                        
                        <label>Email:</label>
                        <input type="email" id="profileEmail" placeholder="teacher@email.com">
                        
                        <label>Address:</label>
                        <input type="text" id="profileAddress" placeholder="Your Address">
                        
                        <label>Profile Photo:</label>
                        <input type="file" id="profilePhoto" accept="image/*">
                        
                        <button onclick="saveProfile()">üíæ Save Profile</button>
                    </div>
                </div>
            `;
        }
        
        function saveProfile() {
            const profileData = {
                phone: document.getElementById('profilePhone').value,
                cnic: document.getElementById('profileCNIC').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value
            };
            
            localStorage.setItem('teacherProfile', JSON.stringify(profileData));
            alert('‚úÖ Profile updated successfully!');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Track dashboard page view
            setTimeout(function() {
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('dashboard_viewed');
                }
            }, 1500);
            
            // Fix button click handlers for proper navigation
            document.getElementById('yearlyPlannerBtn').addEventListener('click', function() {
                showYearlyPlanner(); // Should open planner, NOT grading buddy
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Yearly Planner',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('chatbotBtn').addEventListener('click', function() {
                showChatbot(); // Should open U-Dost chat, NOT grading buddy
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'AI Chatbot',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('gradingBuddyBtn').addEventListener('click', function() {
                showGradingBuddy(); // Only this should open grading buddy
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Grading Buddy',
                        from: 'dashboard'
                    });
                }
            });
        });
        
        // Session management functions
        function getCurrentUser() {
            const savedUser = localStorage.getItem('ustaadDostUser');
            return savedUser ? JSON.parse(savedUser) : null;
        }
        
        function logout() {
            console.log("Logging out user..."); // Debug log
            
            // Clear saved session from localStorage
            localStorage.removeItem('ustaadDostUser');
            
            // Clear any session storage too
            sessionStorage.clear();
            
            console.log("Local session data cleared"); // Debug log
            
            // Redirect to logout endpoint (which will clear server session)
            window.location.href = '/logout';
        }
        
        function updateSessionIndicator() {
            const user = getCurrentUser();
            const indicator = document.getElementById('sessionIndicator');
            
            if (user && indicator) {
                const loginTime = new Date(user.loginTime);
                const timeAgo = formatTimeAgo(loginTime);
                indicator.textContent = `(Session: ${timeAgo})`;
                indicator.style.color = '#28a745';
                console.log("Session indicator updated:", timeAgo); // Debug log
            }
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }
        
        function checkSessionStatus() {
            const user = getCurrentUser();
            
            if (user) {
                const loginTime = user.loginTime;
                const currentTime = new Date().getTime();
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                
                if (currentTime - loginTime > sevenDays) {
                    console.log("Session expired, redirecting to login"); // Debug log
                    localStorage.removeItem('ustaadDostUser');
                    window.location.href = '/login';
                    return false;
                }
                
                // Update session time in localStorage
                user.loginTime = currentTime;
                localStorage.setItem('ustaadDostUser', JSON.stringify(user));
                updateSessionIndicator();
                return true;
            }
            
            console.log("No session found in localStorage"); // Debug log
            return false;
        }
        
        // Store login info in localStorage when dashboard loads
        function handleDashboardLoad() {
            console.log("Dashboard loaded, checking session..."); // Debug log
            
            // Always sync localStorage with Flask session if Flask session exists
            const userPhone = "{{ session.get('phone_number', '') }}";
            const userName = "{{ session.get('user_name', '') }}";
            const loginTime = "{{ session.get('login_time', '') }}";
            
            if (userPhone) {
                console.log("Syncing localStorage with Flask session"); // Debug log
                
                // Parse login time or use current time as fallback
                let sessionStartTime = new Date().getTime();
                if (loginTime) {
                    try {
                        sessionStartTime = new Date(loginTime).getTime();
                    } catch (e) {
                        console.log("Could not parse login_time, using current time"); // Debug log
                    }
                }
                
                // Create or update localStorage session
                localStorage.setItem('ustaadDostUser', JSON.stringify({
                    phone: userPhone,
                    loginTime: sessionStartTime,
                    userData: { name: userName }
                }));
                
                console.log("localStorage session synchronized with server"); // Debug log
            } else {
                console.log("No Flask session found, clearing localStorage"); // Debug log
                localStorage.removeItem('ustaadDostUser');
            }
            
            checkSessionStatus();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', handleDashboardLoad);
        
        // Check session status every 5 minutes
        setInterval(checkSessionStatus, 5 * 60 * 1000);
    </script>
</body>
</html>