<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- PostHog Analytics - Disabled to prevent JS errors -->
    <script>
        // Simple PostHog stub to prevent errors
        window.posthog = {
            capture: function() { console.log('PostHog tracking:', arguments); },
            identify: function() { console.log('PostHog identify:', arguments); }
        };
        console.log('PostHog stub initialized');
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üåü USTAAD DOST</h1>
            <div class="nav-menu">
                <button id="plannerNavBtn" class="nav-button">üìÖ Planner</button>
                <button id="gradingNavBtn" class="nav-button">üìä Grading</button>
                <button id="chatNavBtn" class="nav-button">ü§ñ Chat</button>
                <button id="profileNavBtn" class="nav-button">üë§ Profile</button>
                <div class="user-status">
                    <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                    <span class="session-indicator" id="sessionIndicator"></span>
                </div>
                <a href="#" onclick="logout()" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Dashboard Section -->
        <div id="dashboard" class="dashboard">
            <div class="welcome-section">
                <h1>üéì ÿßÿ≥ÿ™ÿßÿØ ÿØŸàÿ≥ÿ™ ŸÖ€å⁄∫ ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ</h1>
                <p class="welcome-subtitle">Your comprehensive Pakistani teaching assistant for grades 1-5</p>
            </div>
            
            <div class="feature-grid">
                <!-- Yearly Planner Feature -->
                <div class="feature-card yearly-planner">
                    <div class="card-content">
                        <div class="feature-icon">üìÖ</div>
                        <h3>üìö Yearly Planner</h3>
                        <p>Create weekly schedules for all subjects and grades with smart templates.</p>
                        <div class="feature-highlights">
                            <div class="highlight">üìù Smart Templates</div>
                            <div class="highlight">‚úèÔ∏è Easy Editing</div>
                        </div>
                    </div>
                    <button id="yearlyPlannerBtn" class="btn btn-primary btn-large">üìÖ Start Planning</button>
                </div>
                
                <!-- Grading Buddy Feature -->
                <div class="feature-card grading-buddy">
                    <div class="card-content">
                        <div class="feature-icon">üìä</div>
                        <h3>üéØ Grading Buddy</h3>
                        <p>Manage students and create assessments with instant PDF reports.</p>
                        <div class="feature-list">
                            <div class="feature-item">üë• Student Records</div>
                            <div class="feature-item">üìÑ PDF Reports</div>
                        </div>
                    </div>
                    <button id="gradingBuddyBtn" class="btn btn-primary btn-large">üìä Manage Grades</button>
                </div>
                
                <!-- AI Chatbox Feature -->
                <div class="feature-card ai-chatbox">
                    <div class="card-content">
                        <div class="feature-icon">ü§ñ</div>
                        <h3>üí¨ AI Assistant</h3>
                        <p>Get personalized lesson plans and activities for Pakistani curriculum.</p>
                        <div class="ai-features">
                            <div class="ai-feature">üìñ Lesson Plans</div>
                            <div class="ai-feature">üéÆ Activities</div>
                        </div>
                    </div>
                    <button id="chatbotBtn" class="btn btn-primary btn-large">ü§ñ AI Assistant</button>
                </div>
            </div>
            
            <!-- Quick Stats Section -->
            <div class="stats-section">
                <h2>üìà Quick Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üè´</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Classes Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Students Enrolled</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Assessments Created</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Weeks Planned</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Yearly Planner Section -->
        <div id="yearlyPlanner" style="display:none;">
            <h2>üìÖ Yearly Planner</h2>
            <p>Loading planner...</p>
        </div>
        
        <!-- Grading Buddy Section -->
        <div id="gradingBuddy" style="display:none;">
            <!-- Will be populated by loadGradingBuddy() -->
        </div>
        
        <!-- Chatbot Section -->
        <div id="chatbot" style="display:none;">
            <h2>ü§ñ U-Dost Chat</h2>
            <p>Loading chatbot...</p>
        </div>
        
        <!-- Profile Section -->
        <div id="profileSection" style="display:none;">
            <!-- Will be populated by loadProfileEdit() -->
        </div>
    </main>
    
    <style>
        .navbar {
            background: linear-gradient(135deg, var(--soft-blue), var(--sage-green));
            box-shadow: var(--shadow-md);
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-welcome {
            color: white;
            font-weight: 500;
        }
        
        .nav-button {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .logout-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .logout-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-section h1 {
            color: var(--soft-blue-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: var(--gray-600);
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .feature-card {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s ease;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        .card-content {
            flex: 1;
        }

        .feature-card .btn {
            margin-top: 20px;
            margin-bottom: 0;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .large-card {
            grid-column: span 2;
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .yearly-planner, .grading-buddy, .ai-chatbox {
            border-top: 5px solid var(--soft-blue);
        }
        
        .feature-card h3 {
            color: var(--gray-700);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .feature-card p {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .feature-highlights, .feature-list, .ai-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .highlight, .feature-item, .ai-feature {
            background: var(--soft-blue-light);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--soft-blue), var(--soft-blue-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--sage-green), var(--sage-green-dark));
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--warm-cream-dark), var(--gentle-mint));
            color: var(--gray-700);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-large {
            font-size: 1.1rem;
            padding: 15px 30px;
        }
        
        .stats-section {
            margin-top: 50px;
        }
        
        .stats-section h2 {
            text-align: center;
            color: var(--gray-700);
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            font-size: 2.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--soft-blue-dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .flash-messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(104, 211, 145, 0.1);
            color: var(--success);
            border: 1px solid rgba(104, 211, 145, 0.3);
        }
        
        .alert-error {
            background: rgba(252, 129, 129, 0.1);
            color: var(--danger);
            border: 1px solid rgba(252, 129, 129, 0.3);
        }
        
        .alert-info {
            background: rgba(168, 213, 232, 0.1);
            color: var(--info);
            border: 1px solid rgba(168, 213, 232, 0.3);
        }
        
        /* Grading Buddy Styles */
        .grading-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .class-management {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 20px;
        }
        
        .add-btn {
            background: var(--sage-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .add-btn:hover {
            background: var(--sage-green-dark);
            transform: translateY(-2px);
        }
        
        .class-card {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .class-card:hover {
            border-color: var(--soft-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .class-card h4 {
            color: var(--soft-blue-dark);
            margin-bottom: 10px;
        }
        
        .class-card button {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .class-card button:hover {
            background: var(--soft-blue-dark);
            transform: translateY(-1px);
        }
        
        #addClassForm {
            background: var(--light-gray);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        #addClassForm input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        #addClassForm button {
            background: var(--sage-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .class-detail-view {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-top: 20px;
        }
        
        .add-students-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .add-students-options button {
            background: var(--mint-green);
            color: var(--gray-700);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .student-profile {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .student-profile h5 {
            color: var(--soft-blue-dark);
            margin-bottom: 8px;
        }
        
        .student-profile button {
            background: var(--warm-pink);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Profile Edit Styles */
        .profile-edit {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-form {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .profile-form label {
            display: block;
            color: var(--gray-700);
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 15px;
        }
        
        .profile-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .profile-form input:focus {
            outline: none;
            border-color: var(--soft-blue);
        }
        
        .profile-form button {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .profile-form button:hover {
            background: var(--soft-blue-dark);
            transform: translateY(-2px);
        }
        
        /* Section Styles */
        .planner-section, .chatbot-section {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        
        .planner-section h2, .chatbot-section h2 {
            color: var(--soft-blue-dark);
            margin-bottom: 20px;
        }
        
        .planner-section button, .chatbot-section button {
            background: var(--soft-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .planner-section button:hover, .chatbot-section button:hover {
            background: var(--soft-blue-dark);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .large-card {
                grid-column: span 1;
            }
            
            .feature-highlights, .feature-list, .ai-features {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .nav-welcome {
                font-size: 0.9rem;
            }
            
            .welcome-section h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .add-students-options {
                flex-direction: column;
            }
            
            .grading-container, .profile-edit {
                padding: 10px;
            }
        }
    </style>
    
    <script>
        // Navigation Functions
        function hideAllSections() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('yearlyPlanner').style.display = 'none';
            document.getElementById('gradingBuddy').style.display = 'none';
            document.getElementById('chatbot').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
        }
        
        // Grading Buddy Functions
        function loadGradingBuddy() {
            document.getElementById('gradingBuddy').innerHTML = `
                <div class="grading-container">
                    <h2>üìä Grading Buddy</h2>
                    
                    <div class="class-management">
                        <h3>Your Classes</h3>
                        <button onclick="addClass()" class="add-btn">‚ûï Add New Class</button>
                        
                        <div id="classList">
                            <!-- Classes will appear here -->
                        </div>
                    </div>
                    
                    <div id="addClassForm" style="display:none;">
                        <h3>Create New Class</h3>
                        <input type="text" id="className" placeholder="Class Name (e.g., Grade 3-A)">
                        <input type="text" id="classSubject" placeholder="Subject">
                        <button onclick="saveClass()">Save Class</button>
                        <button onclick="cancelAddClass()">Cancel</button>
                    </div>
                    
                    <div id="classDetails" style="display:none;">
                        <!-- Individual class management will load here -->
                    </div>
                </div>
            `;
            
            loadExistingClasses();
        }
        
        function addClass() {
            document.getElementById('addClassForm').style.display = 'block';
        }
        
        function cancelAddClass() {
            document.getElementById('addClassForm').style.display = 'none';
            document.getElementById('className').value = '';
            document.getElementById('classSubject').value = '';
        }
        
        function saveClass() {
            const className = document.getElementById('className').value;
            const subject = document.getElementById('classSubject').value;
            
            if (className && subject) {
                // Save class to storage
                const newClass = {
                    id: Date.now(),
                    name: className,
                    subject: subject,
                    students: []
                };
                
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                classes.push(newClass);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                
                // Refresh class list
                loadExistingClasses();
                document.getElementById('addClassForm').style.display = 'none';
                document.getElementById('className').value = '';
                document.getElementById('classSubject').value = '';
            } else {
                alert('Please enter both class name and subject!');
            }
        }
        
        function loadExistingClasses() {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classListDiv = document.getElementById('classList');
            
            classListDiv.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <h4>${cls.name} - ${cls.subject}</h4>
                    <p>Students: ${cls.students.length}</p>
                    <button onclick="openClass(${cls.id})">üìö Open Class</button>
                    <button onclick="editClass(${cls.id})">‚úèÔ∏è Edit</button>
                </div>
            `).join('');
        }
        
        function openClass(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass) {
                alert('Class not found!');
                return;
            }
            
            document.getElementById('classDetails').style.display = 'block';
            document.getElementById('classDetails').innerHTML = `
                <div class="class-detail-view">
                    <h3>üìö ${currentClass.name} - ${currentClass.subject}</h3>
                    
                    <div class="student-management">
                        <h4>Students (${currentClass.students.length})</h4>
                        
                        <div class="add-students-options">
                            <button onclick="manualAddStudent(${classId})">‚ûï Add Student Manually</button>
                            <button onclick="uploadStudentPicture(${classId})">üì∏ Upload Student List Picture</button>
                        </div>
                        
                        <div id="pictureUpload_${classId}" style="display:none;">
                            <input type="file" id="studentListImage_${classId}" accept="image/*">
                            <button onclick="extractStudentNames(${classId})">Extract Names from Picture</button>
                        </div>
                        
                        <div id="studentList_${classId}">
                            ${currentClass.students.map(student => `
                                <div class="student-profile">
                                    <h5>${student.name}</h5>
                                    <p>Father: ${student.fatherName || 'Not added'}</p>
                                    <p>Mother: ${student.motherName || 'Not added'}</p>
                                    <p>Contact: ${student.contact || 'Not added'}</p>
                                    <button onclick="editStudentProfile(${classId}, ${student.id})">‚úèÔ∏è Edit Profile</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function uploadStudentPicture(classId) {
            document.getElementById(`pictureUpload_${classId}`).style.display = 'block';
        }
        
        function extractStudentNames(classId) {
            // Simulate name extraction (you can add OCR later)
            const extractedNames = [
                "Ahmed Ali", "Fatima Sheikh", "Hassan Khan", "Ayesha Ahmad", "Ali Raza"
            ];
            
            // Add these students to class
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            if (classIndex === -1) {
                alert('Class not found!');
                return;
            }
            
            extractedNames.forEach(name => {
                classes[classIndex].students.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: ''
                });
            });
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            // Refresh class view
            openClass(classId);
            alert(`‚úÖ Added ${extractedNames.length} students from picture!`);
        }
        
        function manualAddStudent(classId) {
            const studentName = prompt('Enter student name:');
            if (!studentName) return;
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            if (classIndex === -1) {
                alert('Class not found!');
                return;
            }
            
            classes[classIndex].students.push({
                id: Date.now(),
                name: studentName,
                fatherName: '',
                motherName: '',
                contact: '',
                address: ''
            });
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            openClass(classId);
        }
        
        function editStudentProfile(classId, studentId) {
            alert('Student profile editing will be available in next update!');
        }
        
        function editClass(classId) {
            alert('Class editing will be available in next update!');
        }
        
        // Profile Edit Functions
        function loadProfileEdit() {
            document.getElementById('profileSection').innerHTML = `
                <div class="profile-edit">
                    <h2>üë§ Edit Profile</h2>
                    
                    <div class="profile-form">
                        <label>Phone Number:</label>
                        <input type="text" id="profilePhone" value="${getCurrentUser()?.phone || ''}">
                        
                        <label>CNIC:</label>
                        <input type="text" id="profileCNIC" placeholder="12345-1234567-1">
                        
                        <label>Email:</label>
                        <input type="email" id="profileEmail" placeholder="teacher@email.com">
                        
                        <label>Address:</label>
                        <input type="text" id="profileAddress" placeholder="Your Address">
                        
                        <label>Profile Photo:</label>
                        <input type="file" id="profilePhoto" accept="image/*">
                        
                        <button onclick="saveProfile()">üíæ Save Profile</button>
                    </div>
                </div>
            `;
        }
        
        function saveProfile() {
            const profileData = {
                phone: document.getElementById('profilePhone').value,
                cnic: document.getElementById('profileCNIC').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value
            };
            
            localStorage.setItem('teacherProfile', JSON.stringify(profileData));
            alert('‚úÖ Profile updated successfully!');
        }
        
        // Yearly Planner Loading Function
        function loadYearlyPlanner() {
            document.getElementById('yearlyPlanner').innerHTML = `
                <div class="planner-section">
                    <h2>üìÖ Yearly Planner</h2>
                    <p>This is your yearly planning section. Plan your academic year with weekly schedules for all subjects.</p>
                    <button onclick="redirectToPlanner()">üìÖ Open Full Planner</button>
                </div>
            `;
        }
        
        function redirectToPlanner() {
            window.location.href = '{{ url_for("yearly_planner") }}';
        }
        
        // Chatbot Loading Function
        function loadChatbot() {
            document.getElementById('chatbot').innerHTML = `
                <div class="chatbot-section">
                    <h2>ü§ñ U-Dost Chat</h2>
                    <p>AI-powered assistant for Pakistani curriculum, lesson plans, and teaching strategies.</p>
                    <button onclick="redirectToChatbot()">ü§ñ Open Full Chat</button>
                </div>
            `;
        }
        
        function redirectToChatbot() {
            window.location.href = '{{ url_for("chatbot") }}';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add CORRECT listeners for navigation
            setTimeout(function() {
                const plannerBtn = document.getElementById('plannerNavBtn');
                const gradingBtn = document.getElementById('gradingNavBtn');
                const chatBtn = document.getElementById('chatNavBtn');
                const profileBtn = document.getElementById('profileNavBtn');
                
                if (plannerBtn) {
                    plannerBtn.onclick = function() {
                        console.log('Planner clicked');
                        hideAllSections();
                        document.getElementById('yearlyPlanner').style.display = 'block';
                        loadYearlyPlanner();
                    };
                }
                
                if (gradingBtn) {
                    gradingBtn.onclick = function() {
                        console.log('Grading clicked');
                        hideAllSections();
                        document.getElementById('gradingBuddy').style.display = 'block';
                        loadGradingBuddy();
                    };
                }
                
                if (chatBtn) {
                    chatBtn.onclick = function() {
                        console.log('Chat clicked');
                        hideAllSections();
                        document.getElementById('chatbot').style.display = 'block';
                        loadChatbot();
                    };
                }
                
                if (profileBtn) {
                    profileBtn.onclick = function() {
                        console.log('Profile clicked');
                        hideAllSections();
                        document.getElementById('profileSection').style.display = 'block';
                        loadProfileEdit();
                    };
                }
            }, 100);
            
            // Track dashboard page view
            setTimeout(function() {
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('dashboard_viewed');
                }
            }, 1500);
            
            // Fix button click handlers for proper navigation
            document.getElementById('yearlyPlannerBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('yearlyPlanner').style.display = 'block';
                loadYearlyPlanner();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Yearly Planner',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('chatbotBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('chatbot').style.display = 'block';
                loadChatbot();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'AI Chatbot',
                        from: 'dashboard'
                    });
                }
            });

            document.getElementById('gradingBuddyBtn').addEventListener('click', function() {
                hideAllSections();
                document.getElementById('gradingBuddy').style.display = 'block';
                loadGradingBuddy();
                if (typeof posthog !== 'undefined' && typeof posthog.capture === 'function') {
                    posthog.capture('feature_accessed', {
                        feature: 'Grading Buddy',
                        from: 'dashboard'
                    });
                }
            });
        });
        
        // Session management functions
        function getCurrentUser() {
            const savedUser = localStorage.getItem('ustaadDostUser');
            return savedUser ? JSON.parse(savedUser) : null;
        }
        
        function logout() {
            console.log("Logging out user..."); // Debug log
            
            // Clear saved session from localStorage
            localStorage.removeItem('ustaadDostUser');
            
            // Clear any session storage too
            sessionStorage.clear();
            
            console.log("Local session data cleared"); // Debug log
            
            // Redirect to logout endpoint (which will clear server session)
            window.location.href = '/logout';
        }
        
        function updateSessionIndicator() {
            const user = getCurrentUser();
            const indicator = document.getElementById('sessionIndicator');
            
            if (user && indicator) {
                const loginTime = new Date(user.loginTime);
                const timeAgo = formatTimeAgo(loginTime);
                indicator.textContent = `(Session: ${timeAgo})`;
                indicator.style.color = '#28a745';
                console.log("Session indicator updated:", timeAgo); // Debug log
            }
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }
        
        function checkSessionStatus() {
            const user = getCurrentUser();
            
            if (user) {
                const loginTime = user.loginTime;
                const currentTime = new Date().getTime();
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                
                if (currentTime - loginTime > sevenDays) {
                    console.log("Session expired, redirecting to login"); // Debug log
                    localStorage.removeItem('ustaadDostUser');
                    window.location.href = '/login';
                    return false;
                }
                
                // Update session time in localStorage
                user.loginTime = currentTime;
                localStorage.setItem('ustaadDostUser', JSON.stringify(user));
                updateSessionIndicator();
                return true;
            }
            
            console.log("No session found in localStorage"); // Debug log
            return false;
        }
        
        // Store login info in localStorage when dashboard loads
        function handleDashboardLoad() {
            console.log("Dashboard loaded, checking session..."); // Debug log
            
            // Always sync localStorage with Flask session if Flask session exists
            const userPhone = "{{ session.get('phone_number', '') }}";
            const userName = "{{ session.get('user_name', '') }}";
            const loginTime = "{{ session.get('login_time', '') }}";
            
            if (userPhone) {
                console.log("Syncing localStorage with Flask session"); // Debug log
                
                // Parse login time or use current time as fallback
                let sessionStartTime = new Date().getTime();
                if (loginTime) {
                    try {
                        sessionStartTime = new Date(loginTime).getTime();
                    } catch (e) {
                        console.log("Could not parse login_time, using current time"); // Debug log
                    }
                }
                
                // Create or update localStorage session
                localStorage.setItem('ustaadDostUser', JSON.stringify({
                    phone: userPhone,
                    loginTime: sessionStartTime,
                    userData: { name: userName }
                }));
                
                console.log("localStorage session synchronized with server"); // Debug log
            } else {
                console.log("No Flask session found, clearing localStorage"); // Debug log
                localStorage.removeItem('ustaadDostUser');
            }
            
            checkSessionStatus();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', handleDashboardLoad);
        
        // Check session status every 5 minutes
        setInterval(checkSessionStatus, 5 * 60 * 1000);
        
        // COMPREHENSIVE APP TESTING SYSTEM (BACKEND ONLY - REMOVED FROM USER INTERFACE)
        function addTestingMode() {
            // Testing functionality removed from user interface
            // Only available for backend/development use
            return;
        }

        function runFullAppTest() {
            const testResults = [];
            
            console.log("üß™ STARTING COMPREHENSIVE APP TEST...");
            
            // Test all features one by one
            testResults.push(testLoginSystem());
            testResults.push(testNavigation());
            testResults.push(testYearlyPlanner());
            testResults.push(testGradingBuddy());
            testResults.push(testChatbot());
            testResults.push(testProfileEdit());
            
            // Show results
            displayTestResults(testResults);
        }

        function testLoginSystem() {
            console.log("Testing: Login System");
            
            try {
                // Test session storage
                const testUser = { phone: "03001234567", loginTime: Date.now() };
                localStorage.setItem('ustaadDostUser', JSON.stringify(testUser));
                const retrieved = JSON.parse(localStorage.getItem('ustaadDostUser'));
                
                if (retrieved.phone === testUser.phone) {
                    return { feature: "Login System", status: "‚úÖ PASS", details: "Session storage working" };
                }
            } catch (error) {
                return { feature: "Login System", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Login System", status: "‚ùå FAIL", details: "Session not working" };
        }

        function testNavigation() {
            console.log("Testing: Navigation");
            
            try {
                // Test if navigation elements exist
                const navButtons = [
                    'plannerNavBtn',
                    'gradingNavBtn', 
                    'chatNavBtn',
                    'profileNavBtn'
                ];
                
                const missingButtons = navButtons.filter(id => !document.getElementById(id));
                
                if (missingButtons.length === 0) {
                    return { feature: "Navigation", status: "‚úÖ PASS", details: "All nav buttons present" };
                } else {
                    return { feature: "Navigation", status: "‚ùå FAIL", details: `Missing: ${missingButtons.join(', ')}` };
                }
            } catch (error) {
                return { feature: "Navigation", status: "‚ùå FAIL", details: error.message };
            }
        }

        function testYearlyPlanner() {
            console.log("Testing: Yearly Planner");
            
            try {
                // Test planner storage
                const testPlan = {
                    schedule: {
                        Monday: { period1: "English", period2: "Math", breakStart: "10:00", breakEnd: "10:20" }
                    }
                };
                
                localStorage.setItem('yearlyPlan', JSON.stringify(testPlan));
                const retrieved = JSON.parse(localStorage.getItem('yearlyPlan'));
                
                if (retrieved.schedule.Monday.period1 === "English") {
                    return { feature: "Yearly Planner", status: "‚úÖ PASS", details: "Plan storage working" };
                }
            } catch (error) {
                return { feature: "Yearly Planner", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Yearly Planner", status: "‚ùå FAIL", details: "Storage not working" };
        }

        function testGradingBuddy() {
            console.log("Testing: Grading Buddy");
            
            try {
                // Test class creation and storage
                const testClass = {
                    id: 12345,
                    name: "Test Class",
                    subject: "English",
                    students: [{ id: 1, name: "Test Student" }]
                };
                
                localStorage.setItem('teacherClasses', JSON.stringify([testClass]));
                const retrieved = JSON.parse(localStorage.getItem('teacherClasses'));
                
                if (retrieved[0].name === "Test Class") {
                    return { feature: "Grading Buddy", status: "‚úÖ PASS", details: "Class storage working" };
                }
            } catch (error) {
                return { feature: "Grading Buddy", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Grading Buddy", status: "‚ùå FAIL", details: "Class storage failed" };
        }

        function testChatbot() {
            console.log("Testing: U-Dost Chatbot");
            
            try {
                // Test chatbot elements
                const chatElements = ['textInput', 'voiceButton', 'fileUpload'];
                const missingElements = chatElements.filter(id => !document.getElementById(id));
                
                // Test response generation function
                if (typeof generateUDostResponse === 'function') {
                    return { 
                        feature: "U-Dost Chatbot", 
                        status: missingElements.length === 0 ? "‚úÖ PASS" : "‚ö†Ô∏è PARTIAL", 
                        details: missingElements.length === 0 ? "All elements present" : `Missing: ${missingElements.join(', ')}`
                    };
                } else {
                    return { 
                        feature: "U-Dost Chatbot", 
                        status: missingElements.length === 0 ? "‚ö†Ô∏è PARTIAL" : "‚ùå FAIL", 
                        details: missingElements.length === 0 ? "Elements present, function missing" : `Missing elements and function`
                    };
                }
            } catch (error) {
                return { feature: "U-Dost Chatbot", status: "‚ùå FAIL", details: error.message };
            }
        }

        function testProfileEdit() {
            console.log("Testing: Profile Edit");
            
            try {
                // Test profile storage
                const testProfile = {
                    phone: "03001234567",
                    email: "test@teacher.com",
                    cnic: "12345-1234567-1"
                };
                
                localStorage.setItem('teacherProfile', JSON.stringify(testProfile));
                const retrieved = JSON.parse(localStorage.getItem('teacherProfile'));
                
                if (retrieved.email === testProfile.email) {
                    return { feature: "Profile Edit", status: "‚úÖ PASS", details: "Profile storage working" };
                }
            } catch (error) {
                return { feature: "Profile Edit", status: "‚ùå FAIL", details: error.message };
            }
            
            return { feature: "Profile Edit", status: "‚ùå FAIL", details: "Profile storage failed" };
        }

        function displayTestResults(results) {
            // Remove existing test results
            const existingResults = document.getElementById('testResults');
            if (existingResults) existingResults.remove();
            
            const resultHTML = `
                <div id="testResults" style="position: fixed; top: 50px; right: 10px; background: white; border: 2px solid #333; padding: 20px; z-index: 9999; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3>üß™ APP TEST RESULTS</h3>
                    ${results.map(result => `
                        <div style="margin: 10px 0; padding: 10px; border-left: 3px solid ${result.status.includes('PASS') ? 'green' : result.status.includes('PARTIAL') ? 'orange' : 'red'};">
                            <strong>${result.feature}</strong><br>
                            Status: ${result.status}<br>
                            Details: ${result.details}
                        </div>
                    `).join('')}
                    
                    <div style="margin-top: 20px;">
                        <button onclick="fixFailedFeatures()" style="background: red; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">üîß Auto-Fix Issues</button>
                        <button onclick="closeTestResults()" style="background: gray; color: white; padding: 10px; margin-left: 10px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', resultHTML);
        }

        function fixFailedFeatures() {
            console.log("üîß Attempting to auto-fix failed features...");
            
            // Auto-create missing elements
            if (!document.getElementById('textInput')) {
                console.log("Creating missing chat input...");
                // Add missing chat elements
            }
            
            if (!document.getElementById('yearlyPlanner')) {
                console.log("Creating missing planner section...");
                // Add missing planner
            }
            
            alert("üîß Auto-fix attempted! Run test again to verify.");
        }

        function closeTestResults() {
            const testResults = document.getElementById('testResults');
            if (testResults) testResults.remove();
        }

        // Test specific chatbot responses
        function testChatbotResponses() {
            const testCases = [
                { grade: "1", subject: "English", topic: "nouns", expected: "noun" },
                { grade: "4", subject: "Islamiyat", topic: "Prophet", expected: "prophet" },
                { grade: "5", subject: "Math", topic: "addition", expected: "addition" }
            ];
            
            testCases.forEach(test => {
                console.log(`Testing: Grade ${test.grade} ${test.subject} ${test.topic}`);
                // Simulate chatbot input and check response
            });
        }

        // Test navigation clicks
        function testAllNavigationClicks() {
            console.log("Testing all navigation clicks...");
            
            // Simulate clicks and check if correct sections open
            const navTests = [
                { button: 'plannerNavBtn', expectedSection: 'yearlyPlanner' },
                { button: 'gradingNavBtn', expectedSection: 'gradingBuddy' },
                { button: 'chatNavBtn', expectedSection: 'chatbot' }
            ];
            
            navTests.forEach(test => {
                // Simulate click and verify section opens
                console.log(`Click test: ${test.button} ‚Üí ${test.expectedSection}`);
            });
        }

        // Testing mode removed from user interface
        // App initialization without testing features
    </script>
</body>
</html>