<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grading Buddy - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        h2, h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-purple { background: #6f42c1; color: white; }
        .btn-gray { background: #6c757d; color: white; }

        input, select, textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 5px 0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .class-card {
            border: 2px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .student-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
        }

        input[type="number"] {
            width: 80px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            button {
                display: none;
            }
            a {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Grading Buddy</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">
            <a href="{{ url_for('index') }}">‚Üê Back to Dashboard</a>
        </p>

        <div id="main"></div>
    </div>

    <script>
        const phoneNumber = '{{ phone_number }}';

        function getCurrentUser() {
            return phoneNumber || 'unknown';
        }

        function displayClasses() {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            
            let html = '<h2>Your Classes</h2>';
            html += '<button class="btn-green" onclick="createClass()">‚ûï Create New Class</button>';
            
            if (classes.length === 0) {
                html += '<p style="margin: 20px 0; color: #666;">No classes created yet. Create your first class!</p>';
            } else {
                classes.forEach(cls => {
                    html += `
                        <div class="class-card">
                            <h3>${cls.name}</h3>
                            <p>üë• Students: ${cls.students.length} | üìù Tests: ${cls.tests.length}</p>
                            <button class="btn-blue" onclick="showClass(${cls.id})">Open Class</button>
                            <button class="btn-red" onclick="deleteClass(${cls.id})">Delete Class</button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('main').innerHTML = html;
        }

        function createClass() {
            const className = prompt("Enter class name (e.g., Grade 3-A):");
            if (className && className.trim()) {
                const newClass = {
                    id: Date.now(),
                    name: className.trim(),
                    students: [],
                    tests: []
                };
                
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                classes.push(newClass);
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                
                alert('‚úÖ Class created successfully!');
                displayClasses();
            }
        }

        function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? All students and tests will be deleted.')) {
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                classes = classes.filter(c => c.id !== classId);
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert('‚úÖ Class deleted!');
                displayClasses();
            }
        }

        function showClass(classId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass) {
                alert('Class not found!');
                displayClasses();
                return;
            }
            
            let html = `
                <h2>üìö ${currentClass.name}</h2>
                <button class="btn-gray" onclick="displayClasses()">‚¨ÖÔ∏è Back to Classes</button>
                
                <div style="margin: 30px 0;">
                    <h3>üë• Students (${currentClass.students.length})</h3>
                    <button class="btn-green" onclick="addStudentsBulk(${classId})">‚ûï Add Students (Bulk)</button>
                    <button class="btn-blue" onclick="addSingleStudent(${classId})">‚ûï Add Single Student</button>
                    <button class="btn-orange" onclick="viewStudentList(${classId})">üìã View All Students</button>
                </div>
                
                <div style="margin: 30px 0;">
                    <h3>üìù Tests (${currentClass.tests.length})</h3>
                    <button class="btn-green" onclick="createScoresheet(${classId})">‚ûï Create New Test</button>
                    <button class="btn-orange" onclick="viewAllTests(${classId})">üìã View All Tests</button>
                </div>
            `;
            
            document.getElementById('main').innerHTML = html;
        }

        function addStudentsBulk(classId) {
            const studentNames = prompt("Enter student names (one per line):\n\nExample:\nAhmed Ali\nFatima Khan\nHassan Sheikh");
            
            if (studentNames && studentNames.trim()) {
                const names = studentNames.split('\n').filter(name => name.trim().length > 0);
                
                if (names.length === 0) {
                    alert('No valid names entered!');
                    return;
                }
                
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                names.forEach(name => {
                    classes[classIndex].students.push({
                        id: Date.now() + Math.random(),
                        name: name.trim(),
                        fatherName: '',
                        contact: ''
                    });
                });
                
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert(`‚úÖ Added ${names.length} students successfully!`);
                showClass(classId);
            }
        }

        function addSingleStudent(classId) {
            const name = prompt("Enter student name:");
            if (name && name.trim()) {
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                classes[classIndex].students.push({
                    id: Date.now(),
                    name: name.trim(),
                    fatherName: '',
                    contact: ''
                });
                
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert('‚úÖ Student added successfully!');
                showClass(classId);
            }
        }

        function viewStudentList(classId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <h2>üë• Students in ${currentClass.name}</h2>
                <button class="btn-gray" onclick="showClass(${classId})">‚¨ÖÔ∏è Back to Class</button>
                <div style="margin: 20px 0;">
            `;
            
            if (currentClass.students.length === 0) {
                html += '<p style="color: #666;">No students added yet.</p>';
            } else {
                currentClass.students.forEach((student, index) => {
                    html += `
                        <div class="student-item">
                            <h4>${index + 1}. ${student.name}</h4>
                            <p>Father: ${student.fatherName || 'Not added'} | Contact: ${student.contact || 'Not added'}</p>
                            <button class="btn-blue" onclick="editStudent(${classId}, ${student.id})">‚úèÔ∏è Edit</button>
                            <button class="btn-red" onclick="deleteStudent(${classId}, ${student.id})">üóëÔ∏è Delete</button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('main').innerHTML = html;
        }

        function editStudent(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const name = prompt("Student Name:", student.name);
            if (name === null) return;
            
            const fatherName = prompt("Father Name:", student.fatherName);
            if (fatherName === null) return;
            
            const contact = prompt("Contact Number:", student.contact);
            if (contact === null) return;
            
            if (name.trim()) {
                const classIndex = classes.findIndex(c => c.id === classId);
                const studentIndex = classes[classIndex].students.findIndex(s => s.id === studentId);
                
                classes[classIndex].students[studentIndex] = {
                    id: studentId,
                    name: name.trim(),
                    fatherName: fatherName.trim(),
                    contact: contact.trim()
                };
                
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert('‚úÖ Student updated!');
                viewStudentList(classId);
            }
        }

        function deleteStudent(classId, studentId) {
            if (confirm('Delete this student?')) {
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                classes[classIndex].students = classes[classIndex].students.filter(s => s.id !== studentId);
                
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert('‚úÖ Student deleted!');
                viewStudentList(classId);
            }
        }

        function createScoresheet(classId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('‚ö†Ô∏è Please add students first!');
                return;
            }
            
            const subject = prompt("Subject:\n\nEnter subject name:\n(e.g., English, Math, Urdu, Science, Islamiyat, Social Studies, General Knowledge)");
            if (!subject || !subject.trim()) return;
            
            const topic = prompt("Enter topic/chapter:\n(e.g., Chapter 5 - Nouns, Multiplication Tables)");
            if (!topic || !topic.trim()) return;
            
            const type = prompt("Assessment type:\n\nType 'marks' for marks-based test\nType 'tick' for tick/cross assessment");
            if (!type) return;
            
            if (type.toLowerCase() === 'marks') {
                const totalMarks = prompt("Total marks:\n(e.g., 10, 20, 50, 100)");
                if (totalMarks && !isNaN(totalMarks)) {
                    createMarksSheet(classId, subject.trim(), topic.trim(), parseInt(totalMarks));
                }
            } else if (type.toLowerCase() === 'tick') {
                createTickSheet(classId, subject.trim(), topic.trim());
            } else {
                alert('Invalid type! Please enter "marks" or "tick"');
            }
        }

        function createMarksSheet(classId, subject, topic, totalMarks) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <h2>${subject} - ${topic}</h2>
                <p><strong>Class:</strong> ${currentClass.name} | <strong>Total Marks:</strong> ${totalMarks}</p>
                <button class="btn-gray" onclick="showClass(${classId})">‚¨ÖÔ∏è Back to Class</button>
                <button class="btn-green" onclick="saveMarksTest(${classId}, '${subject}', '${topic}', ${totalMarks})">üíæ Save Test</button>
                <button class="btn-blue" onclick="printSheet()">üñ®Ô∏è Print</button>
                
                <div id="printArea">
                    <h3 style="text-align: center;">${currentClass.name} - ${subject}</h3>
                    <p style="text-align: center;">${topic} (Total: ${totalMarks} marks)</p>
                    <p style="text-align: center;">Date: ${new Date().toLocaleDateString()}</p>
                    
                    <table>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                            <th>Obtained Marks</th>
                            <th>Percentage</th>
                            <th>Grade</th>
                        </tr>
            `;
            
            currentClass.students.forEach((student, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td><input type="number" id="m_${student.id}" min="0" max="${totalMarks}" onchange="calculatePercentage(${student.id}, ${totalMarks})" style="width: 80px;"></td>
                        <td><span id="p_${student.id}">-</span></td>
                        <td><span id="g_${student.id}">-</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </div>
            `;
            
            document.getElementById('main').innerHTML = html;
        }

        function calculatePercentage(studentId, totalMarks) {
            const obtained = parseFloat(document.getElementById('m_' + studentId).value) || 0;
            const percentage = ((obtained / totalMarks) * 100).toFixed(2);
            document.getElementById('p_' + studentId).innerText = percentage + '%';
            
            let grade = 'F';
            if (percentage >= 90) grade = 'A+';
            else if (percentage >= 80) grade = 'A';
            else if (percentage >= 70) grade = 'B';
            else if (percentage >= 60) grade = 'C';
            else if (percentage >= 50) grade = 'D';
            else if (percentage >= 40) grade = 'E';
            
            document.getElementById('g_' + studentId).innerText = grade;
        }

        function saveMarksTest(classId, subject, topic, totalMarks) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            const testData = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                type: 'marks',
                totalMarks: totalMarks,
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            currentClass.students.forEach(student => {
                const obtained = parseFloat(document.getElementById('m_' + student.id).value) || 0;
                const percentage = ((obtained / totalMarks) * 100).toFixed(2);
                
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                else if (percentage >= 40) grade = 'E';
                
                testData.scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    obtainedMarks: obtained,
                    percentage: percentage,
                    grade: grade
                });
            });
            
            classes[classIndex].tests.push(testData);
            localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Test saved successfully!');
            showClass(classId);
        }

        function createTickSheet(classId, subject, topic) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <h2>${subject} - ${topic}</h2>
                <p><strong>Class:</strong> ${currentClass.name} | <strong>Type:</strong> Tick/Cross Assessment</p>
                <button class="btn-gray" onclick="showClass(${classId})">‚¨ÖÔ∏è Back to Class</button>
                <button class="btn-green" onclick="saveTickTest(${classId}, '${subject}', '${topic}')">üíæ Save Test</button>
                <button class="btn-blue" onclick="printSheet()">üñ®Ô∏è Print</button>
                
                <div id="printArea">
                    <h3 style="text-align: center;">${currentClass.name} - ${subject}</h3>
                    <p style="text-align: center;">${topic} (Tick/Cross Assessment)</p>
                    <p style="text-align: center;">Date: ${new Date().toLocaleDateString()}</p>
                    
                    <table>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                            <th>Status</th>
                        </tr>
            `;
            
            currentClass.students.forEach((student, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>
                            <select id="t_${student.id}" style="width: 150px;">
                                <option value="">- Select -</option>
                                <option value="‚úì Complete">‚úì Complete</option>
                                <option value="‚úó Incomplete">‚úó Incomplete</option>
                                <option value="‚≠ê Excellent">‚≠ê Excellent</option>
                                <option value="‚ö† Needs Work">‚ö† Needs Work</option>
                            </select>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </div>
            `;
            
            document.getElementById('main').innerHTML = html;
        }

        function saveTickTest(classId, subject, topic) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            const testData = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                type: 'tick',
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            currentClass.students.forEach(student => {
                const status = document.getElementById('t_' + student.id).value || '- Not marked -';
                
                testData.scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    status: status
                });
            });
            
            classes[classIndex].tests.push(testData);
            localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Test saved successfully!');
            showClass(classId);
        }

        function viewAllTests(classId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <h2>üìù All Tests - ${currentClass.name}</h2>
                <button class="btn-gray" onclick="showClass(${classId})">‚¨ÖÔ∏è Back to Class</button>
                <div style="margin: 20px 0;">
            `;
            
            if (currentClass.tests.length === 0) {
                html += '<p style="color: #666;">No tests created yet.</p>';
            } else {
                currentClass.tests.forEach(test => {
                    html += `
                        <div class="class-card">
                            <h3>${test.subject} - ${test.topic}</h3>
                            <p><strong>Date:</strong> ${test.date} | <strong>Type:</strong> ${test.type === 'marks' ? 'Marks-based' : 'Tick/Cross'}</p>
                            ${test.type === 'marks' ? `<p><strong>Total Marks:</strong> ${test.totalMarks}</p>` : ''}
                            <button class="btn-blue" onclick="viewTestDetails(${classId}, ${test.id})">üëÅÔ∏è View Details</button>
                            <button class="btn-red" onclick="deleteTest(${classId}, ${test.id})">üóëÔ∏è Delete</button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('main').innerHTML = html;
        }

        function viewTestDetails(classId, testId) {
            const classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const test = currentClass.tests.find(t => t.id === testId);
            
            let html = `
                <h2>${test.subject} - ${test.topic}</h2>
                <p><strong>Class:</strong> ${currentClass.name} | <strong>Date:</strong> ${test.date}</p>
                <button class="btn-gray" onclick="viewAllTests(${classId})">‚¨ÖÔ∏è Back to Tests</button>
                <button class="btn-blue" onclick="printSheet()">üñ®Ô∏è Print</button>
                
                <div id="printArea">
                    <h3 style="text-align: center;">${currentClass.name} - ${test.subject}</h3>
                    <p style="text-align: center;">${test.topic}</p>
                    <p style="text-align: center;">Date: ${test.date}</p>
                    
                    <table>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
            `;
            
            if (test.type === 'marks') {
                html += `
                            <th>Obtained Marks</th>
                            <th>Percentage</th>
                            <th>Grade</th>
                        </tr>
                `;
                
                test.scores.forEach((score, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${score.studentName}</td>
                            <td>${score.obtainedMarks}/${test.totalMarks}</td>
                            <td>${score.percentage}%</td>
                            <td>${score.grade}</td>
                        </tr>
                    `;
                });
            } else {
                html += `
                            <th>Status</th>
                        </tr>
                `;
                
                test.scores.forEach((score, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${score.studentName}</td>
                            <td>${score.status}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </table>
                </div>
            `;
            
            document.getElementById('main').innerHTML = html;
        }

        function deleteTest(classId, testId) {
            if (confirm('Delete this test?')) {
                let classes = JSON.parse(localStorage.getItem(getCurrentUser() + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                classes[classIndex].tests = classes[classIndex].tests.filter(t => t.id !== testId);
                
                localStorage.setItem(getCurrentUser() + '_classes', JSON.stringify(classes));
                alert('‚úÖ Test deleted!');
                viewAllTests(classId);
            }
        }

        function printSheet() {
            const printContent = document.getElementById('printArea').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print - Grading Buddy</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid black; padding: 10px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        h3, p { text-align: center; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by USTAAD DOST - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        window.onload = function() {
            if (phoneNumber) {
                localStorage.setItem('ustaadDostUser', JSON.stringify({ phone: phoneNumber }));
            }
            displayClasses();
        };
    </script>
</body>
</html>
