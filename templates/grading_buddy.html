<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grading Buddy - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Make sure this is in your HTML -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üìä Grading Buddy</h1>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">üè† Dashboard</a>
                <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                <a href="{{ url_for('logout') }}" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="grading-container">
            <div class="welcome-section">
                <h1>üìä Grading Buddy</h1>
                <p class="welcome-subtitle">Manage your classes, students, and assessments with comprehensive grading tools</p>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card">
                    <div class="action-icon">üë•</div>
                    <h3>Class Management</h3>
                    <p>Create and manage classes for grades 1-5</p>
                    <button class="btn btn-primary" onclick="showSection('classes')">üìö Manage Classes</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üë§</div>
                    <h3>Student Profiles</h3>
                    <p>Add students with guardian contacts and CNIC</p>
                    <button class="btn btn-success" onclick="showSection('students')">üë• Add Students</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üìù</div>
                    <h3>Scoresheets</h3>
                    <p>Create custom scoresheets and assessments</p>
                    <button class="btn btn-secondary" onclick="showSection('scoresheets')">üìä Create Scoresheet</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üìÑ</div>
                    <h3>Reports</h3>
                    <p>Generate PDF reports for students and classes</p>
                    <button class="btn btn-accent" onclick="showSection('reports')">üìà View Reports</button>
                </div>
            </div>

            <!-- Class Management Section -->
            <div id="classes-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üë• Class Management</h2>
                    <button class="btn btn-primary" onclick="addNewClass()">‚ûï Add New Class</button>
                </div>
                
                <div class="classes-grid">
                    <div class="class-card sample-class">
                        <div class="class-header">
                            <h3>Grade 4 - Section A</h3>
                            <span class="student-count">25 Students</span>
                        </div>
                        <div class="class-details">
                            <div class="detail-item">
                                <span class="label">Subjects:</span>
                                <span class="value">English, Math, Urdu, Science</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Academic Year:</span>
                                <span class="value">2024-2025</span>
                            </div>
                        </div>
                        <div class="class-actions">
                            <button class="btn btn-sm btn-primary">üë• View Students</button>
                            <button class="btn btn-sm btn-secondary">üìä Assessments</button>
                            <button class="btn btn-sm btn-accent">üìÑ Reports</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Management Section -->
            <div id="students-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üë§ Student Management</h2>
                    <button class="btn btn-primary" onclick="addNewStudent()">‚ûï Add New Student</button>
                </div>
                
                <div class="add-students-section">
                    <h3>Add Students to Class</h3>
                    
                    <div class="upload-options">
                        <button class="btn btn-secondary" onclick="manualEntry()">üìù Manual Entry</button>
                        <button class="btn btn-accent" onclick="uploadPicture()">üì∏ Upload Picture</button>
                    </div>
                    
                    <div id="pictureUpload" style="display:none;" class="picture-upload-section">
                        <div class="upload-area">
                            <input type="file" id="studentListImage" accept="image/jpeg,image/jpg,image/png,image/bmp,image/webp,application/pdf" style="display:none;">
                            <div class="upload-dropzone" onclick="document.getElementById('studentListImage').click();">
                                <div class="upload-icon">üì∑</div>
                                <p>Click to upload student list image</p>
                                <small>Supports: JPG, PNG, BMP, WebP, PDF with student names</small>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="extractNamesFromImage()" id="extractBtn" style="display:none;">üîç Extract Names</button>
                        <div id="extractedNames" class="extracted-names-section"></div>
                    </div>
                </div>
                
                <div class="student-form" id="manualStudentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="student-name">Student Name</label>
                            <input type="text" id="student-name" class="form-input" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="student-class">Class</label>
                            <select id="student-class" class="form-select">
                                <option value="">Select Class...</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-roll">Roll Number</label>
                            <input type="text" id="student-roll" class="form-input" placeholder="Enter roll number">
                        </div>
                        <div class="form-group">
                            <label for="guardian-name">Guardian Name</label>
                            <input type="text" id="guardian-name" class="form-input" placeholder="Parent/Guardian name">
                        </div>
                        <div class="form-group">
                            <label for="guardian-cnic">Guardian CNIC</label>
                            <input type="text" id="guardian-cnic" class="form-input" placeholder="XXXXX-XXXXXXX-X">
                        </div>
                        <div class="form-group">
                            <label for="guardian-phone">Contact Number</label>
                            <input type="tel" id="guardian-phone" class="form-input" placeholder="03XX-XXXXXXX">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewStudent()">üíæ Save Student</button>
                </div>
            </div>

            <!-- Scoresheets Section -->
            <div id="scoresheets-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üìù Scoresheets & Assessments</h2>
                    <button class="btn btn-primary" onclick="createScoresheet()">üìä Create New Scoresheet</button>
                </div>
                
                <div class="scoresheet-options">
                    <div class="option-card">
                        <div class="option-icon">‚úÖ</div>
                        <h3>Screener Grading</h3>
                        <p>7-task checkbox system for quick assessment</p>
                        <button class="btn btn-primary">üìã Start Screener</button>
                    </div>
                    <div class="option-card">
                        <div class="option-icon">üìä</div>
                        <h3>Custom Scoresheet</h3>
                        <p>Create customizable scoresheets with auto date/time</p>
                        <button class="btn btn-secondary">üìù Custom Scoresheet</button>
                    </div>
                    <div class="option-card">
                        <div class="option-icon">üìà</div>
                        <h3>Progress Tracking</h3>
                        <p>Monitor student progress and analytics</p>
                        <button class="btn btn-accent">üìà View Progress</button>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üìÑ Reports & Analytics</h2>
                    <button class="btn btn-primary" onclick="generateReport()">üìä Generate Report</button>
                </div>
                
                <div class="report-options">
                    <div class="report-type">
                        <h3>Individual Student Reports</h3>
                        <div class="report-controls">
                            <select class="form-select">
                                <option>Select Student...</option>
                            </select>
                            <button class="btn btn-primary">üìÑ Generate PDF</button>
                        </div>
                    </div>
                    
                    <div class="report-type">
                        <h3>Class Performance Reports</h3>
                        <div class="report-controls">
                            <select class="form-select">
                                <option>Select Class...</option>
                                <option>Grade 4 - Section A</option>
                                <option>Grade 3 - Section B</option>
                                <option>Grade 5 - Section A</option>
                            </select>
                            <button class="btn btn-secondary">üìä Class Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Highlights -->
            <div class="features-section">
                <h2>üåü Grading Buddy Features</h2>
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon">üë•</div>
                        <h3>Class Management</h3>
                        <p>Organize students by grades 1-5 with section support</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìù</div>
                        <h3>Custom Scoresheets</h3>
                        <p>Create tailored assessments with automatic timestamps</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">‚úÖ</div>
                        <h3>Screener Grading</h3>
                        <p>Quick 7-task checkbox system for rapid evaluation</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìÑ</div>
                        <h3>PDF Reports</h3>
                        <p>Professional reports for students and entire classes</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <style>
        .navbar {
            background: linear-gradient(135deg, var(--sage-green), var(--soft-blue));
            box-shadow: var(--shadow-md);
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .nav-welcome {
            color: white;
            font-weight: 500;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-section h1 {
            color: var(--sage-green-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: var(--gray-600);
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .action-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .action-card h3 {
            color: var(--gray-700);
            margin-bottom: 10px;
        }
        
        .action-card p {
            color: var(--gray-600);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .content-section {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .section-header h2 {
            color: var(--gray-700);
            margin: 0;
        }
        
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .class-card {
            background: var(--gentle-mint-light);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--sage-green);
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .class-header h3 {
            color: var(--gray-700);
            margin: 0;
        }
        
        .student-count {
            background: var(--sage-green);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .class-details {
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .value {
            color: var(--gray-600);
        }
        
        .class-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .form-input, .form-select {
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--sage-green);
        }
        
        .scoresheet-options, .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .option-card {
            background: var(--soft-blue-light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--soft-blue);
        }
        
        .option-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .report-type {
            background: var(--warm-cream-light);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--warm-cream-dark);
        }
        
        .report-type h3 {
            color: var(--gray-700);
            margin-bottom: 15px;
        }
        
        .report-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--soft-blue), var(--soft-blue-dark));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--sage-green), var(--sage-green-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--warm-cream-dark), var(--gentle-mint));
            color: var(--gray-700);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* NEW GRADING SYSTEM STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .class-detail-view {
            padding: 20px;
        }
        
        .class-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .action-btn.primary {
            background: var(--sage-green);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .students-summary {
            margin: 20px 0;
        }
        
        .student-list-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .student-tag {
            background: var(--soft-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .more-students {
            background: var(--gray-400);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .test-preview {
            background: var(--warm-white);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--sage-green);
        }
        
        .create-test-form {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .assessment-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .assessment-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .save-btn {
            background: var(--sage-green);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: var(--gray-500);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .scoresheet, .exercise-checklist {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .scores-table, .checklist-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .scores-table table, .checklist-table table, .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .scores-table th, .checklist-table th, .results-table th,
        .scores-table td, .checklist-table td, .results-table td {
            padding: 12px;
            border: 1px solid var(--gray-300);
            text-align: left;
        }
        
        .scores-table th, .checklist-table th, .results-table th {
            background: var(--sage-green);
            color: white;
            font-weight: 600;
        }
        
        .scores-table input[type="number"], .checklist-table input[type="checkbox"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
        }
        
        .checklist-table input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .test-results, .exercise-results {
            max-width: 100%;
            margin: 20px 0;
        }
        
        .results-summary {
            background: var(--mint-green);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .grade-a, .grade-a\+ {
            background: #d4edda;
            color: #155724;
            font-weight: 700;
        }
        
        .grade-b {
            background: #fff3cd;
            color: #856404;
            font-weight: 600;
        }
        
        .grade-c {
            background: #ffeaa7;
            color: #6c6c00;
            font-weight: 600;
        }
        
        .grade-d {
            background: #fdcb6e;
            color: #8b4513;
            font-weight: 600;
        }
        
        .grade-f {
            background: #f8d7da;
            color: #721c24;
            font-weight: 700;
        }
        
        .no-classes {
            text-align: center;
            padding: 40px 20px;
            background: var(--warm-white);
            border-radius: 15px;
            color: var(--gray-600);
        }
        
        .features-section {
            text-align: center;
            margin-top: 50px;
        }
        
        .features-section h2 {
            color: var(--gray-700);
            margin-bottom: 30px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .feature-item {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .feature-item h3 {
            color: var(--gray-700);
            margin-bottom: 10px;
        }
        
        .feature-item p {
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(104, 211, 145, 0.1);
            color: var(--success);
            border: 1px solid rgba(104, 211, 145, 0.3);
        }
        
        .alert-error {
            background: rgba(252, 129, 129, 0.1);
            color: var(--danger);
            border: 1px solid rgba(252, 129, 129, 0.3);
        }
        
        /* Picture Upload Styling */
        .add-students-section {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 25px;
        }
        
        .upload-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .picture-upload-section {
            margin-top: 20px;
        }
        
        .upload-area {
            margin-bottom: 20px;
        }
        
        .upload-dropzone {
            border: 3px dashed var(--soft-blue);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(135, 206, 235, 0.05);
        }
        
        .upload-dropzone:hover {
            border-color: var(--soft-blue-dark);
            background: rgba(135, 206, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--soft-blue);
        }
        
        .upload-dropzone p {
            font-size: 1.1rem;
            color: var(--gray-700);
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .upload-dropzone small {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .extracted-names-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(104, 211, 145, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(104, 211, 145, 0.2);
        }
        
        .extracted-names-section h4 {
            color: var(--success);
            margin-bottom: 10px;
        }
        
        .instruction-text {
            color: var(--gray-600);
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .student-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .student-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
        }
        
        .student-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .student-name-input:focus {
            outline: none;
            border-color: var(--soft-blue);
            box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.2);
        }
        
        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        
        .extracted-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-warning {
            background: #d69e2e;
            color: white;
        }
        
        .btn-warning:hover {
            background: #b7791f;
        }
        
        /* NEW COMPONENT STYLES FOR STREAMLINED CLASS MANAGEMENT */
        .new-test-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        
        .new-test-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .new-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .class-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        
        .stat-card h4 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sage-green);
            margin: 0;
        }
        
        .stat-card p {
            margin: 5px 0 0 0;
            color: #666;
            font-weight: 500;
        }
        
        .class-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .section h4 {
            margin-top: 0;
            color: var(--sage-green-dark);
            border-bottom: 2px solid var(--soft-blue);
            padding-bottom: 10px;
        }
        
        .student-add-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .option-card {
            background: white;
            padding: 30px 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-color: var(--soft-blue);
        }
        
        .option-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .option-card h4 {
            margin: 10px 0 5px 0;
            color: var(--sage-green-dark);
        }
        
        .option-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .manual-add-form, .picture-add-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .bulk-add {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .bulk-add h5 {
            margin: 0 0 10px 0;
            color: var(--sage-green-dark);
        }
        
        .bulk-add textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }
        
        .upload-area {
            margin: 20px 0;
            padding: 30px;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
        }
        
        .upload-preview {
            margin-top: 15px;
        }
        
        .extracted-name {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .name-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }
        
        .remove-btn {
            padding: 5px 8px;
            background: #fed7d7;
            color: #c53030;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .student-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .student-info h4 {
            margin: 0 0 10px 0;
            color: var(--sage-green-dark);
        }
        
        .student-details {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .student-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .edit-btn {
            background: var(--soft-blue);
            color: white;
        }
        
        .delete-btn {
            background: #fed7d7;
            color: #c53030;
        }
        
        .edit-btn:hover {
            background: #3182ce;
        }
        
        .delete-btn:hover {
            background: #feb2b2;
        }
        
        .add-btn, .save-btn, .extract-btn, .back-btn, .cancel-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .add-btn, .save-btn {
            background: var(--success);
            color: white;
        }
        
        .extract-btn {
            background: var(--soft-blue);
            color: white;
        }
        
        .back-btn {
            background: #718096;
            color: white;
        }
        
        .cancel-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .add-btn:hover, .save-btn:hover {
            background: #38a169;
        }
        
        .extract-btn:hover {
            background: #3182ce;
        }
        
        .back-btn:hover {
            background: #4a5568;
        }
        
        .cancel-btn:hover {
            background: #cbd5e0;
        }
        
        .edit-student-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                text-align: center;
            }
            
            .class-actions {
                justify-content: center;
            }
            
            .report-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .class-sections {
                grid-template-columns: 1fr;
            }
            
            .student-add-options {
                grid-template-columns: 1fr;
            }
            
            .class-stats {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
    
    <script>
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // SIMPLIFIED CLASS CREATION (ONE-TIME SETUP)
        function addNewClass() {
            const classFormHTML = `
                <div id="addClassForm" class="modal-overlay">
                    <div class="modal-content">
                        <h3>‚ûï Create New Class</h3>
                        <div class="form-group">
                            <label>Class Name:</label>
                            <input type="text" id="className" placeholder="Class Name (e.g., Grade 3-A)" required>
                        </div>
                        <div class="form-actions">
                            <button onclick="saveClass()" class="btn btn-success">Create Class</button>
                            <button onclick="closeClassForm()" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', classFormHTML);
        }
        
        // Alias for compatibility
        function addClass() {
            addNewClass();
        }

        function saveClass() {
            const className = document.getElementById('className').value;
            
            if (className) {
                const newClass = {
                    id: Date.now(),
                    name: className, // Just class name, no subject restriction
                    students: [],
                    scoresheets: [] // Will contain tests for all subjects
                };
                
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                classes.push(newClass);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                
                alert('‚úÖ Class created successfully!');
                loadExistingClasses();
                closeClassForm();
            } else {
                alert('Please enter class name!');
            }
        }

        function closeClassForm() {
            const form = document.getElementById('addClassForm');
            if (form) form.remove();
        }

        function loadExistingClasses() {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classesGrid = document.querySelector('.classes-grid');
            
            if (classes.length === 0) {
                classesGrid.innerHTML = `
                    <div class="no-classes">
                        <p>üìö No classes created yet. Click "Add New Class" to get started!</p>
                    </div>
                `;
                return;
            }
            
            classesGrid.innerHTML = classes.map(classItem => `
                <div class="class-card">
                    <div class="class-header">
                        <h3>${classItem.name}</h3>
                        <span class="student-count">${classItem.students.length} Students</span>
                    </div>
                    <div class="class-details">
                        <div class="detail-item">
                            <span class="label">Tests:</span>
                            <span class="value">${classItem.scoresheets ? classItem.scoresheets.length : 0} assessments</span>
                        </div>
                    </div>
                    <div class="class-actions">
                        <button class="btn btn-sm btn-primary" onclick="openClass(${classItem.id})">üè´ Open Class</button>
                        <button class="btn btn-sm btn-secondary" onclick="addStudentsOptions(${classItem.id})">üë• Students</button>
                        <button class="btn btn-sm btn-accent" onclick="deleteClass(${classItem.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? This action cannot be undone.')) {
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                classes = classes.filter(c => c.id !== classId);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                loadExistingClasses();
                alert('‚úÖ Class deleted successfully!');
            }
        }

        function addStudents(classId) {
            document.getElementById('students-section').style.display = 'block';
            document.getElementById('students-section').scrollIntoView({ behavior: 'smooth' });
            
            // Store current class ID for student addition
            window.currentClassId = classId;
        }

        function addNewStudent() {
            if (!window.currentClassId) {
                alert('Please select a class first by clicking "üë• Students" from a class card.');
                return;
            }
            
            const studentName = document.getElementById('student-name').value;
            const studentClass = document.getElementById('student-class').value;
            const studentRoll = document.getElementById('student-roll').value;
            const guardianName = document.getElementById('guardian-name').value;
            const guardianCnic = document.getElementById('guardian-cnic').value;
            const guardianPhone = document.getElementById('guardian-phone').value;
            
            if (!studentName) {
                alert('Please enter student name!');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: studentName,
                class: studentClass,
                rollNumber: studentRoll,
                guardian: {
                    name: guardianName,
                    cnic: guardianCnic,
                    phone: guardianPhone
                }
            };
            
            // Add student to class
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === window.currentClassId);
            
            if (classIndex !== -1) {
                classes[classIndex].students.push(newStudent);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                
                alert('‚úÖ Student added successfully!');
                
                // Clear form
                document.getElementById('student-name').value = '';
                document.getElementById('student-class').value = '';
                document.getElementById('student-roll').value = '';
                document.getElementById('guardian-name').value = '';
                document.getElementById('guardian-cnic').value = '';
                document.getElementById('guardian-phone').value = '';
                
                loadExistingClasses();
            }
        }

        function createScoresheet() {
            if (!window.currentClassId) {
                alert('Please select a class first!');
                return;
            }
            createNewTest(window.currentClassId);
        }

        function generateReport() {
            alert('üìä Report generation feature coming soon! Will generate PDF reports for individual students and classes.');
        }

        // ENHANCED CLASS INTERFACE WITH NEW TEST BUTTON
        function openClass(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass) {
                alert('Class not found!');
                return;
            }
            
            // Create class detail section if it doesn't exist
            let classDetailSection = document.getElementById('classDetails');
            if (!classDetailSection) {
                classDetailSection = document.createElement('div');
                classDetailSection.id = 'classDetails';
                classDetailSection.className = 'content-section';
                document.querySelector('.grading-container').appendChild(classDetailSection);
            }
            
            classDetailSection.style.display = 'block';
            classDetailSection.innerHTML = `
                <div class="class-detail-view">
                    <h3>üìö ${currentClass.name}</h3>
                    
                    <!-- PROMINENT NEW TEST BUTTON -->
                    <div class="new-test-section">
                        <button onclick="createNewTest(${classId})" class="new-test-btn">
                            ‚ûï Create New Test
                        </button>
                    </div>
                    
                    <div class="class-stats">
                        <div class="stat-card">
                            <h4>${currentClass.students.length}</h4>
                            <p>Students</p>
                        </div>
                        <div class="stat-card">
                            <h4>${currentClass.scoresheets ? currentClass.scoresheets.length : 0}</h4>
                            <p>Tests Conducted</p>
                        </div>
                    </div>
                    
                    <div class="class-sections">
                        <div class="section">
                            <h4>üë• Students Management</h4>
                            <button onclick="addStudentsOptions(${classId})" class="action-btn">Add Students</button>
                            <button onclick="viewAllStudents(${classId})" class="action-btn">View All Students</button>
                        </div>
                        
                        <div class="section">
                            <h4>üìä Tests & Assessments</h4>
                            <div id="recentTests_${classId}"></div>
                            <button onclick="viewAllTests(${classId})" class="action-btn">View All Tests</button>
                        </div>
                    </div>
                </div>
            `;
            
            loadRecentTests(classId);
            classDetailSection.scrollIntoView({ behavior: 'smooth' });
        }

        function loadRecentTests(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const recentTestsDiv = document.getElementById(`recentTests_${classId}`);
            
            if (!currentClass.scoresheets || currentClass.scoresheets.length === 0) {
                recentTestsDiv.innerHTML = '<p>No tests created yet. Click "Create New Test" to get started!</p>';
                return;
            }
            
            const recentTests = currentClass.scoresheets.slice(-3).reverse(); // Show last 3 tests
            recentTestsDiv.innerHTML = recentTests.map(test => `
                <div class="test-preview">
                    <h5>${test.subject} - ${test.topic}</h5>
                    <p><strong>Type:</strong> ${test.type} | <strong>Date:</strong> ${test.date}</p>
                    <button onclick="viewTestResults(${classId}, ${test.id})" class="btn btn-sm btn-primary">üìä View Results</button>
                </div>
            `).join('');
        }

        function viewAllTests(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            alert(`üìä All Tests for ${currentClass.name}:\n\nTotal Tests: ${currentClass.scoresheets ? currentClass.scoresheets.length : 0}\n\nDetailed test history viewer coming soon!`);
        }

        // STUDENT ADDITION WITH MANUAL & PICTURE OPTIONS
        function addStudentsOptions(classId) {
            document.getElementById('classDetails').innerHTML = `
                <div class="add-students-container">
                    <h3>üë• Add Students to Class</h3>
                    
                    <div class="student-add-options">
                        <div class="option-card" onclick="manualStudentAdd(${classId})">
                            <div class="option-icon">‚úèÔ∏è</div>
                            <h4>Manual Entry</h4>
                            <p>Add students one by one</p>
                        </div>
                        
                        <div class="option-card" onclick="pictureStudentAdd(${classId})">
                            <div class="option-icon">üì∏</div>
                            <h4>Picture Upload</h4>
                            <p>Upload student list photo</p>
                        </div>
                    </div>
                    
                    <div id="studentAddInterface"></div>
                    
                    <button onclick="openClass(${classId})" class="back-btn">‚¨ÖÔ∏è Back to Class</button>
                </div>
            `;
        }

        function manualStudentAdd(classId) {
            document.getElementById('studentAddInterface').innerHTML = `
                <div class="manual-add-form">
                    <h4>‚úèÔ∏è Add Student Manually</h4>
                    <input type="text" id="studentName" placeholder="Student Name" required>
                    <button onclick="addSingleStudent(${classId})" class="add-btn">Add Student</button>
                    
                    <div class="bulk-add">
                        <h5>Or add multiple students (one per line):</h5>
                        <textarea id="bulkStudents" placeholder="Student Name 1&#10;Student Name 2&#10;Student Name 3" rows="5"></textarea>
                        <button onclick="addBulkStudents(${classId})" class="add-btn">Add All</button>
                    </div>
                </div>
            `;
        }

        function addSingleStudent(classId) {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('Please enter student name!');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: studentName,
                fatherName: '',
                motherName: '',
                contact: '',
                address: '',
                gender: ''
            };
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            classes[classIndex].students.push(newStudent);
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            document.getElementById('studentName').value = '';
            alert(`‚úÖ ${studentName} added successfully!`);
        }

        function addBulkStudents(classId) {
            const bulkText = document.getElementById('bulkStudents').value.trim();
            if (!bulkText) {
                alert('Please enter student names!');
                return;
            }
            
            const studentNames = bulkText.split('\n').map(name => name.trim()).filter(name => name);
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            studentNames.forEach(name => {
                const newStudent = {
                    id: Date.now() + Math.random(),
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: '',
                    gender: ''
                };
                classes[classIndex].students.push(newStudent);
            });
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            document.getElementById('bulkStudents').value = '';
            alert(`‚úÖ ${studentNames.length} students added successfully!`);
        }

        // PICTURE UPLOAD FOR STUDENT NAMES
        function pictureStudentAdd(classId) {
            document.getElementById('studentAddInterface').innerHTML = `
                <div class="picture-add-form">
                    <h4>üì∏ Upload Student List Picture</h4>
                    <p>Upload a photo containing student names</p>
                    
                    <div class="upload-area">
                        <input type="file" id="studentImages" accept="image/*" multiple onchange="previewImages()">
                        <div class="upload-preview" id="imagePreview"></div>
                    </div>
                    
                    <button onclick="extractStudentNames(${classId})" class="extract-btn">Extract Names</button>
                    
                    <div id="extractedNamesContainer" style="display:none;">
                        <!-- Names will be dynamically inserted here by OCR -->
                    </div>
                </div>
            `;
        }

        function previewImages() {
            const files = document.getElementById('studentImages').files;
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML += `
                            <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin: 5px;">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function extractStudentNames(classId) {
            const imageFile = document.getElementById('studentImages').files[0];
            
            if (!imageFile) {
                alert('Please select an image first!');
                return;
            }
            
            document.getElementById('extractedNamesContainer').innerHTML = 'Reading names from image...';
            document.getElementById('extractedNamesContainer').style.display = 'block';
            
            // BETTER OCR SETTINGS
            Tesseract.recognize(imageFile, 'eng', {
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ',
                tessedit_pageseg_mode: 6
            })
            .then(({ data: { text } }) => {
                console.log('OCR found:', text);
                
                // BETTER NAME EXTRACTION
                const lines = text.split(/[\n\r]+/);
                const names = [];
                
                lines.forEach(line => {
                    const cleaned = line.trim().replace(/[^A-Za-z\s]/g, '');
                    if (cleaned.length >= 3 && cleaned.split(' ').length >= 2) {
                        names.push(cleaned);
                    }
                });
                
                if (names.length === 0) {
                    alert('No names found. Try clearer image or manual entry.');
                    return;
                }
                
                showRealExtractedNames(names, classId);
            })
            .catch(error => {
                console.error('OCR failed:', error);
                alert('OCR failed. Use manual entry instead.');
            });
        }

        function showRealExtractedNames(names, classId) {
            let html = '<h5>Names found in image:</h5>';
            names.forEach((name, index) => {
                html += `
                    <div>
                        <input type="text" id="name_${index}" value="${name}" />
                        <button onclick="removeName(${index})">Remove</button>
                    </div>
                `;
            });
            html += `<button onclick="saveRealNames(${classId}, ${names.length})">Save Names</button>`;
            
            document.getElementById('extractedNamesContainer').innerHTML = html;
        }

        function removeName(index) {
            document.getElementById(`name_${index}`).parentElement.remove();
        }

        function saveRealNames(classId, originalCount) {
            const students = [];
            
            // Collect all name inputs that still exist
            for (let i = 0; i < originalCount; i++) {
                const nameInput = document.getElementById(`name_${i}`);
                if (nameInput && nameInput.value.trim()) {
                    students.push({
                        id: Date.now() + Math.random(),
                        name: nameInput.value.trim(),
                        fatherName: '',
                        motherName: '',
                        contact: '',
                        address: '',
                        gender: ''
                    });
                }
            }
            
            // FORCE SAVE TO LOCALSTORAGE
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            
            if (classIndex !== -1) {
                classes[classIndex].students.push(...students);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                alert(`‚úÖ ${students.length} students saved successfully!`);
                openClass(classId);
            }
        }


        function saveWeeklyPlan() {
            const planData = {}; // collect your plan data here
            
            // FORCE SAVE
            localStorage.setItem('yearlyPlan', JSON.stringify(planData));
            localStorage.setItem('weeklyTemplate', JSON.stringify(planData));
            
            alert('Plan saved successfully!');
        }

        // STUDENT PROFILE EDITING
        function viewAllStudents(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let studentsHTML = `
                <div class="students-list">
                    <h3>üë• Students in ${currentClass.name}</h3>
                    
                    <div class="students-grid">
                        ${currentClass.students.map(student => `
                            <div class="student-card">
                                <div class="student-info">
                                    <h4>${student.name}</h4>
                                    <p class="student-details">
                                        ${student.fatherName ? `Father: ${student.fatherName}` : 'Father: Not added'}<br>
                                        ${student.contact ? `Contact: ${student.contact}` : 'Contact: Not added'}
                                    </p>
                                </div>
                                <div class="student-actions">
                                    <button onclick="editStudentProfile(${classId}, ${student.id})" class="edit-btn">‚úèÔ∏è Edit</button>
                                    <button onclick="deleteStudent(${classId}, ${student.id})" class="delete-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="openClass(${classId})" class="back-btn">‚¨ÖÔ∏è Back to Class</button>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = studentsHTML;
        }

        function editStudentProfile(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const editForm = `
                <div class="edit-student-form">
                    <h3>‚úèÔ∏è Edit Student Profile</h3>
                    
                    <div class="form-group">
                        <label>Student Name:</label>
                        <input type="text" id="editName" value="${student.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Father's Name:</label>
                        <input type="text" id="editFatherName" value="${student.fatherName || ''}" placeholder="Father's name">
                    </div>
                    
                    <div class="form-group">
                        <label>Mother's Name:</label>
                        <input type="text" id="editMotherName" value="${student.motherName || ''}" placeholder="Mother's name">
                    </div>
                    
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="text" id="editContact" value="${student.contact || ''}" placeholder="Parent contact number">
                    </div>
                    
                    <div class="form-group">
                        <label>Address:</label>
                        <textarea id="editAddress" placeholder="Home address">${student.address || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Gender:</label>
                        <select id="editGender">
                            <option value="">Select Gender</option>
                            <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveStudentProfile(${classId}, ${studentId})" class="save-btn">üíæ Save Changes</button>
                        <button onclick="viewAllStudents(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = editForm;
        }

        function saveStudentProfile(classId, studentId) {
            const updatedData = {
                name: document.getElementById('editName').value.trim(),
                fatherName: document.getElementById('editFatherName').value.trim(),
                motherName: document.getElementById('editMotherName').value.trim(),
                contact: document.getElementById('editContact').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                gender: document.getElementById('editGender').value
            };
            
            if (!updatedData.name) {
                alert('Student name is required!');
                return;
            }
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const studentIndex = classes[classIndex].students.findIndex(s => s.id === studentId);
            
            // Update student data
            Object.assign(classes[classIndex].students[studentIndex], updatedData);
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            alert('‚úÖ Student profile updated successfully!');
            viewAllStudents(classId);
        }

        function deleteStudent(classId, studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                classes[classIndex].students = classes[classIndex].students.filter(s => s.id !== studentId);
                
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                alert('‚úÖ Student deleted successfully!');
                viewAllStudents(classId);
            }
        }

        // CREATE NEW TEST WITH SUBJECT SELECTION
        function createNewTest(classId) {
            const subjects = ['English', 'Math', 'Urdu', 'Islamiyat', 'Science', 'Social Studies', 'General Knowledge'];
            const testTypes = ['Written Test', 'Oral Test', 'Quiz', 'Assignment', 'Exercise Check', 'Class Work', 'Homework'];
            
            const testFormHTML = `
                <div class="create-test-form">
                    <h3>üìù Create New Test</h3>
                    
                    <div class="form-group">
                        <label>Test Subject:</label>
                        <select id="testSubject" required>
                            <option value="">Select Subject</option>
                            ${subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Test Type:</label>
                        <select id="testType" required>
                            <option value="">Select Type</option>
                            ${testTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Test Topic:</label>
                        <input type="text" id="testTopic" placeholder="e.g., Chapter 5 - Nouns" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Total Marks:</label>
                        <input type="number" id="totalMarks" placeholder="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Assessment Type:</label>
                        <div class="assessment-options">
                            <label><input type="radio" name="assessmentType" value="marks" checked> Marks (0-100)</label>
                            <label><input type="radio" name="assessmentType" value="exercises"> Exercise Checklist (7 tasks)</label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="proceedToScoring(${classId})" class="save-btn">Next: Add Scores</button>
                        <button onclick="cancelTestCreation(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = testFormHTML;
        }

        function proceedToScoring(classId) {
            const subject = document.getElementById('testSubject').value;
            const testType = document.getElementById('testType').value;
            const topic = document.getElementById('testTopic').value;
            const totalMarks = document.getElementById('totalMarks').value;
            const assessmentType = document.querySelector('input[name="assessmentType"]:checked').value;
            
            if (!subject || !testType || !topic || !totalMarks) {
                alert('Please fill all required fields!');
                return;
            }
            
            const testData = {
                id: Date.now(),
                subject: subject,
                type: testType,
                topic: topic,
                totalMarks: parseInt(totalMarks),
                assessmentType: assessmentType,
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            if (assessmentType === 'marks') {
                createMarksScoresheet(classId, testData);
            } else {
                createExerciseChecklist(classId, testData);
            }
        }

        function cancelTestCreation(classId) {
            openClass(classId);
        }

        // MARKS SCORESHEET SYSTEM
        function createMarksScoresheet(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('Please add students first!');
                addStudents(classId);
                return;
            }
            
            let scoresheetHTML = `
                <div class="scoresheet">
                    <h3>üìä ${testData.subject} - ${testData.topic}</h3>
                    <p><strong>Type:</strong> ${testData.type} | <strong>Total Marks:</strong> ${testData.totalMarks} | <strong>Date:</strong> ${testData.date}</p>
                    
                    <div class="scores-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Obtained Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentClass.students.map(student => `
                                    <tr>
                                        <td>${student.name}</td>
                                        <td><input type="number" id="marks_${student.id}" max="${testData.totalMarks}" min="0" onchange="calculateGrade(${student.id}, ${testData.totalMarks})"></td>
                                        <td><span id="percentage_${student.id}">-</span></td>
                                        <td><span id="grade_${student.id}">-</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveScoresheet(${classId}, ${JSON.stringify(testData).replace(/"/g, '&quot;')})" class="save-btn">üíæ Save Test Results</button>
                        <button onclick="openClass(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = scoresheetHTML;
        }

        function calculateGrade(studentId, totalMarks) {
            const obtainedMarks = document.getElementById(`marks_${studentId}`).value;
            if (obtainedMarks) {
                const percentage = Math.round((obtainedMarks / totalMarks) * 100);
                document.getElementById(`percentage_${studentId}`).textContent = percentage + '%';
                
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                
                document.getElementById(`grade_${studentId}`).textContent = grade;
            }
        }

        // EXERCISE CHECKLIST (7 TASKS) SYSTEM
        function createExerciseChecklist(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('Please add students first!');
                addStudents(classId);
                return;
            }
            
            const exercises = [
                'Reading Comprehension', 
                'Writing Task', 
                'Vocabulary', 
                'Grammar Exercise', 
                'Speaking/Oral', 
                'Problem Solving', 
                'Creative Work'
            ];
            
            let checklistHTML = `
                <div class="exercise-checklist">
                    <h3>‚úÖ ${testData.subject} - ${testData.topic}</h3>
                    <p><strong>Type:</strong> Exercise Checklist | <strong>Date:</strong> ${testData.date}</p>
                    
                    <div class="checklist-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    ${exercises.map(exercise => `<th>${exercise}</th>`).join('')}
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentClass.students.map(student => `
                                    <tr>
                                        <td>${student.name}</td>
                                        ${exercises.map((exercise, index) => `
                                            <td><input type="checkbox" id="exercise_${student.id}_${index}" onchange="updateExerciseTotal(${student.id})"></td>
                                        `).join('')}
                                        <td><span id="total_${student.id}">0/7</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveExerciseChecklist(${classId}, ${JSON.stringify(testData).replace(/"/g, '&quot;')})" class="save-btn">üíæ Save Exercise Results</button>
                        <button onclick="openClass(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = checklistHTML;
        }

        function updateExerciseTotal(studentId) {
            let checkedCount = 0;
            for (let i = 0; i < 7; i++) {
                const checkbox = document.getElementById(`exercise_${studentId}_${i}`);
                if (checkbox && checkbox.checked) {
                    checkedCount++;
                }
            }
            document.getElementById(`total_${studentId}`).textContent = `${checkedCount}/7`;
        }

        // SAVE SCORESHEET FUNCTIONS
        function saveScoresheet(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            // Collect all scores
            const scores = [];
            currentClass.students.forEach(student => {
                const obtainedMarks = document.getElementById(`marks_${student.id}`)?.value || 0;
                const percentage = Math.round((obtainedMarks / testData.totalMarks) * 100);
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                
                scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    obtainedMarks: parseInt(obtainedMarks) || 0,
                    percentage: percentage,
                    grade: grade
                });
            });
            
            testData.scores = scores;
            
            // Add scoresheet to class
            if (!currentClass.scoresheets) {
                currentClass.scoresheets = [];
            }
            currentClass.scoresheets.push(testData);
            
            // Save to localStorage
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            alert('‚úÖ Test scores saved successfully!');
            openClass(classId);
        }

        function saveExerciseChecklist(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            // Collect exercise results
            const exerciseResults = [];
            currentClass.students.forEach(student => {
                let checkedCount = 0;
                const exercises = [];
                
                for (let i = 0; i < 7; i++) {
                    const checkbox = document.getElementById(`exercise_${student.id}_${i}`);
                    const isChecked = checkbox && checkbox.checked;
                    exercises.push(isChecked);
                    if (isChecked) checkedCount++;
                }
                
                exerciseResults.push({
                    studentId: student.id,
                    studentName: student.name,
                    exercises: exercises,
                    total: `${checkedCount}/7`,
                    completionRate: Math.round((checkedCount / 7) * 100) + '%'
                });
            });
            
            testData.exerciseResults = exerciseResults;
            
            // Add to class scoresheets
            if (!currentClass.scoresheets) {
                currentClass.scoresheets = [];
            }
            currentClass.scoresheets.push(testData);
            
            // Save to localStorage
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            alert('‚úÖ Exercise checklist saved successfully!');
            openClass(classId);
        }

        function viewTestResults(classId, testId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const test = currentClass.scoresheets.find(t => t.id === testId);
            
            if (!test) {
                alert('Test not found!');
                return;
            }
            
            let resultsHTML = '';
            if (test.assessmentType === 'marks') {
                resultsHTML = `
                    <div class="test-results">
                        <h3>üìä ${test.subject} - ${test.topic} Results</h3>
                        <p><strong>Type:</strong> ${test.type} | <strong>Date:</strong> ${test.date}</p>
                        
                        <div class="results-summary">
                            <h4>Class Performance:</h4>
                            <p>Average: ${calculateClassAverage(test.scores)}% | Highest: ${getHighestScore(test.scores)}% | Lowest: ${getLowestScore(test.scores)}%</p>
                        </div>
                        
                        <table class="results-table">
                            <thead>
                                <tr><th>Student</th><th>Marks</th><th>Percentage</th><th>Grade</th></tr>
                            </thead>
                            <tbody>
                                ${test.scores.map(score => `
                                    <tr>
                                        <td>${score.studentName}</td>
                                        <td>${score.obtainedMarks}/${test.totalMarks}</td>
                                        <td>${score.percentage}%</td>
                                        <td class="grade-${score.grade.toLowerCase()}">${score.grade}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <button onclick="openClass(${classId})" class="btn btn-secondary">Back to Class</button>
                    </div>
                `;
            } else {
                resultsHTML = `
                    <div class="exercise-results">
                        <h3>‚úÖ ${test.subject} - ${test.topic} Results</h3>
                        <p><strong>Type:</strong> Exercise Checklist | <strong>Date:</strong> ${test.date}</p>
                        
                        <table class="results-table">
                            <thead>
                                <tr><th>Student</th><th>Completed Tasks</th><th>Completion Rate</th></tr>
                            </thead>
                            <tbody>
                                ${test.exerciseResults.map(result => `
                                    <tr>
                                        <td>${result.studentName}</td>
                                        <td>${result.total}</td>
                                        <td>${result.completionRate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <button onclick="openClass(${classId})" class="btn btn-secondary">Back to Class</button>
                    </div>
                `;
            }
            
            document.getElementById('classDetails').innerHTML = resultsHTML;
        }

        function calculateClassAverage(scores) {
            if (scores.length === 0) return 0;
            const total = scores.reduce((sum, score) => sum + score.percentage, 0);
            return Math.round(total / scores.length);
        }

        function getHighestScore(scores) {
            return scores.length > 0 ? Math.max(...scores.map(s => s.percentage)) : 0;
        }

        function getLowestScore(scores) {
            return scores.length > 0 ? Math.min(...scores.map(s => s.percentage)) : 0;
        }
        
        // Picture upload functionality for student lists
        function manualEntry() {
            document.getElementById('pictureUpload').style.display = 'none';
            document.getElementById('manualStudentForm').style.display = 'block';
        }
        
        function uploadPicture() {
            document.getElementById('manualStudentForm').style.display = 'none';
            document.getElementById('pictureUpload').style.display = 'block';
        }
        
        function extractNamesFromImage() {
            const fileInput = document.getElementById('studentListImage');
            const file = fileInput.files[0];
            
            if (file) {
                // Show loading state
                document.getElementById('extractBtn').textContent = 'üîÑ Processing...';
                document.getElementById('extractBtn').disabled = true;
                
                // Use backend API to extract text from image
                processStudentListImage(file);
            } else {
                alert('Please select an image file first.');
            }
        }
        
        async function processStudentListImage(imageFile) {
            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', imageFile);
                
                // Call backend API for name extraction
                const response = await fetch('/grading/extract-names', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.names) {
                    displayExtractedNames(data.names);
                    
                    // Show success message
                    const container = document.getElementById('extractedNames');
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px;';
                    successMsg.textContent = data.message;
                    container.insertBefore(successMsg, container.firstChild);
                } else {
                    throw new Error(data.error || 'Failed to extract names');
                }
                
            } catch (error) {
                console.error('Name extraction error:', error);
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0;';
                errorMsg.innerHTML = `
                    <strong>‚ö†Ô∏è Extraction Failed:</strong> ${error.message}<br>
                    <small>Note: This feature uses AI vision to extract names. Make sure the image contains clear, readable text with student names.</small>
                `;
                document.getElementById('extractedNames').appendChild(errorMsg);
                
                // No fallback - only use real OCR results
            } finally {
                // Reset button
                document.getElementById('extractBtn').textContent = 'üîç Extract Names';
                document.getElementById('extractBtn').disabled = false;
            }
        }
        
        function displayExtractedNames(names) {
            const container = document.getElementById('extractedNames');
            container.innerHTML = `
                <h4>‚úÖ Extracted Student Names:</h4>
                <p class="instruction-text">Review and edit the names below, then save to your class:</p>
                <div class="student-list">
                    ${names.map((name, index) => `
                        <div class="student-name-row">
                            <input type="text" value="${name}" class="student-name-input" data-index="${index}">
                            <button class="btn-remove" onclick="removeStudentName(${index})" title="Remove">‚ùå</button>
                        </div>
                    `).join('')}
                </div>
                <div class="extracted-actions">
                    <button class="btn btn-success" onclick="saveStudentList()">üíæ Save to Class</button>
                    <button class="btn btn-secondary" onclick="addMoreNames()">‚ûï Add More</button>
                    <button class="btn btn-warning" onclick="clearExtracted()">üóëÔ∏è Clear All</button>
                </div>
            `;
            container.style.display = 'block';
        }
        
        function removeStudentName(index) {
            const row = document.querySelector(`[data-index="${index}"]`).closest('.student-name-row');
            row.remove();
        }
        
        function addMoreNames() {
            const studentList = document.querySelector('.student-list');
            const newIndex = Date.now(); // Use timestamp as unique index
            const newRow = document.createElement('div');
            newRow.className = 'student-name-row';
            newRow.innerHTML = `
                <input type="text" value="" class="student-name-input" data-index="${newIndex}" placeholder="Enter student name">
                <button class="btn-remove" onclick="removeStudentName(${newIndex})" title="Remove">‚ùå</button>
            `;
            studentList.appendChild(newRow);
        }
        
        function saveStudentList() {
            const inputs = document.querySelectorAll('.student-name-input');
            const names = Array.from(inputs).map(input => input.value.trim()).filter(name => name.length > 0);
            
            if (names.length === 0) {
                alert('Please add at least one student name.');
                return;
            }
            
            // Simulate saving to database
            alert(`Successfully saved ${names.length} students to class:\n\n${names.join('\n')}\n\nThis feature will be integrated with the database soon!`);
            
            // Clear the extracted names
            clearExtracted();
        }
        
        function clearExtracted() {
            document.getElementById('extractedNames').innerHTML = '';
            document.getElementById('extractedNames').style.display = 'none';
            document.getElementById('studentListImage').value = '';
            document.getElementById('extractBtn').style.display = 'none';
        }
        
        // Handle file selection and page initialization
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('studentListImage');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const fileName = e.target.files[0].name;
                        document.querySelector('.upload-dropzone p').textContent = `üìé Selected: ${fileName}`;
                        document.getElementById('extractBtn').style.display = 'block';
                    }
                });
            }
            
            // Initialize classes display
            loadExistingClasses();
        });
    </script>
</body>
</html>