<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grading Buddy - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #667eea;
            color: white;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Grading Buddy</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">
            <a href="{{ url_for('index') }}">‚Üê Back to Dashboard</a>
        </p>

        <div id="gradingBuddy"></div>
    </div>

    <script>
        // =================
        // CLASS MANAGEMENT
        // =================

        function showGradingBuddy() {
            document.getElementById('gradingBuddy').innerHTML = `
                <h2>üìä Grading Buddy</h2>
                
                <div class="class-section">
                    <h3>Your Classes</h3>
                    <button onclick="createNewClass()" style="background: green; color: white; padding: 15px; margin: 10px; font-size: 16px;">
                        ‚ûï Create New Class
                    </button>
                    
                    <div id="classesList"></div>
                </div>
                
                <div id="classWorkArea" style="display: none;"></div>
            `;
            
            loadClassesList();
        }

        function createNewClass() {
            document.getElementById('classesList').innerHTML = `
                <div style="border: 2px solid blue; padding: 20px; margin: 10px;">
                    <h4>Create New Class</h4>
                    <input type="text" id="newClassName" placeholder="Enter class name (e.g. Grade 3-A)" 
                        style="width: 300px; padding: 10px; font-size: 16px;">
                    <br><br>
                    <button onclick="saveNewClass()" style="background: green; color: white; padding: 15px; margin: 5px;">
                        Save Class
                    </button>
                    <button onclick="loadClassesList()" style="background: gray; color: white; padding: 15px; margin: 5px;">
                        Cancel
                    </button>
                </div>
            `;
        }

        function saveNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            
            if (!className) {
                alert('Please enter class name!');
                return;
            }
            
            const newClass = {
                id: Date.now(),
                name: className,
                students: [],
                scoresheets: []
            };
            
            const userPhone = getCurrentUser();
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            classes.push(newClass);
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            
            alert('‚úÖ Class created successfully!');
            loadClassesList();
        }

        function loadClassesList() {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            
            let html = '';
            
            if (classes.length === 0) {
                html = '<p>No classes created yet. Create your first class!</p>';
            } else {
                classes.forEach(cls => {
                    html += `
                        <div style="border: 1px solid gray; padding: 15px; margin: 10px; background: white;">
                            <h4>${cls.name}</h4>
                            <p>Students: ${cls.students.length} | Tests: ${cls.scoresheets.length}</p>
                            <button onclick="openClass(${cls.id})" style="background: blue; color: white; padding: 10px; margin: 5px;">
                                Open Class
                            </button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('classesList').innerHTML = html;
        }

        // =================
        // CLASS MANAGEMENT
        // =================

        function openClass(classId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            document.getElementById('classWorkArea').style.display = 'block';
            document.getElementById('classWorkArea').innerHTML = `
                <div style="border: 3px solid green; padding: 20px; margin: 20px;">
                    <h3>üìö ${currentClass.name}</h3>
                    
                    <div style="display: flex; gap: 20px; margin: 20px 0;">
                        <div style="border: 1px solid blue; padding: 15px;">
                            <h4>üë• Students: ${currentClass.students.length}</h4>
                            <button onclick="addStudents(${classId})" style="background: green; color: white; padding: 10px; margin: 5px;">
                                Add Students
                            </button>
                            <button onclick="viewStudents(${classId})" style="background: blue; color: white; padding: 10px; margin: 5px;">
                                View All Students
                            </button>
                        </div>
                        
                        <div style="border: 1px solid red; padding: 15px;">
                            <h4>üìù Tests: ${currentClass.scoresheets.length}</h4>
                            <button onclick="createScoresheet(${classId})" style="background: red; color: white; padding: 10px; margin: 5px;">
                                Create New Test
                            </button>
                            <button onclick="viewTests(${classId})" style="background: orange; color: white; padding: 10px; margin: 5px;">
                                View All Tests
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="showGradingBuddy()" style="background: gray; color: white; padding: 15px;">
                        ‚¨ÖÔ∏è Back to Classes
                    </button>
                </div>
                
                <div id="studentWorkArea"></div>
                <div id="testWorkArea"></div>
            `;
        }

        // =================
        // STUDENT MANAGEMENT
        // =================

        function addStudents(classId) {
            document.getElementById('studentWorkArea').innerHTML = `
                <div style="border: 2px solid green; padding: 20px; margin: 20px;">
                    <h4>Add Students to Class</h4>
                    
                    <h5>Bulk Add Students (paste names, one per line):</h5>
                    <textarea id="bulkNames" placeholder="Ahmed Ali
Fatima Khan
Hassan Sheikh
Ayesha Ahmad" 
                        rows="10" style="width: 100%; padding: 15px; font-size: 16px;"></textarea>
                    
                    <br><br>
                    <button onclick="saveBulkStudents(${classId})" style="background: green; color: white; padding: 20px; font-size: 18px;">
                        ‚ûï Add All These Students
                    </button>
                    
                    <hr>
                    
                    <h5>Or add single student:</h5>
                    <input type="text" id="singleName" placeholder="Student name" style="width: 300px; padding: 10px; font-size: 16px;">
                    <button onclick="addSingleStudent(${classId})" style="background: blue; color: white; padding: 10px;">
                        Add Student
                    </button>
                </div>
            `;
        }

        function saveBulkStudents(classId) {
            const bulkText = document.getElementById('bulkNames').value.trim();
            
            if (!bulkText) {
                alert('Please enter student names!');
                return;
            }
            
            const names = bulkText.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            
            const userPhone = getCurrentUser();
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            names.forEach(name => {
                const student = {
                    id: Date.now() + Math.random(),
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: ''
                };
                classes[classIndex].students.push(student);
            });
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            alert(`‚úÖ Added ${names.length} students successfully!`);
            openClass(classId);
        }

        function addSingleStudent(classId) {
            const name = document.getElementById('singleName').value.trim();
            
            if (!name) {
                alert('Please enter student name!');
                return;
            }
            
            const student = {
                id: Date.now(),
                name: name,
                fatherName: '',
                motherName: '',
                contact: '',
                address: ''
            };
            
            const userPhone = getCurrentUser();
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            classes[classIndex].students.push(student);
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            document.getElementById('singleName').value = '';
            alert('‚úÖ Student added!');
        }

        function viewStudents(classId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <div style="border: 2px solid blue; padding: 20px; margin: 20px;">
                    <h4>üë• Students in ${currentClass.name}</h4>
            `;
            
            if (currentClass.students.length === 0) {
                html += '<p>No students added yet.</p>';
            } else {
                currentClass.students.forEach(student => {
                    html += `
                        <div style="border: 1px solid gray; padding: 15px; margin: 10px; background: #f9f9f9;">
                            <h5>${student.name}</h5>
                            <p>Father: ${student.fatherName || 'Not added'}</p>
                            <p>Contact: ${student.contact || 'Not added'}</p>
                            
                            <button onclick="editStudent(${classId}, ${student.id})" style="background: green; color: white; padding: 8px;">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteStudent(${classId}, ${student.id})" style="background: red; color: white; padding: 8px;">
                                üóëÔ∏è Delete  
                            </button>
                            <button onclick="studentReports(${classId}, ${student.id})" style="background: blue; color: white; padding: 8px;">
                                üìä Reports
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('studentWorkArea').innerHTML = html;
        }

        function editStudent(classId, studentId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            document.getElementById('studentWorkArea').innerHTML = `
                <div style="border: 2px solid green; padding: 20px; margin: 20px;">
                    <h4>‚úèÔ∏è Edit ${student.name}</h4>
                    
                    <label>Name:</label><br>
                    <input type="text" id="editName" value="${student.name}" style="width: 300px; padding: 10px; margin: 5px;"><br>
                    
                    <label>Father Name:</label><br>
                    <input type="text" id="editFather" value="${student.fatherName}" style="width: 300px; padding: 10px; margin: 5px;"><br>
                    
                    <label>Mother Name:</label><br>
                    <input type="text" id="editMother" value="${student.motherName}" style="width: 300px; padding: 10px; margin: 5px;"><br>
                    
                    <label>Contact:</label><br>
                    <input type="text" id="editContact" value="${student.contact}" style="width: 300px; padding: 10px; margin: 5px;"><br>
                    
                    <label>Address:</label><br>
                    <input type="text" id="editAddress" value="${student.address}" style="width: 300px; padding: 10px; margin: 5px;"><br><br>
                    
                    <button onclick="saveStudentEdit(${classId}, ${studentId})" style="background: green; color: white; padding: 15px;">
                        üíæ Save Changes
                    </button>
                    <button onclick="viewStudents(${classId})" style="background: gray; color: white; padding: 15px;">
                        Cancel
                    </button>
                </div>
            `;
        }

        function saveStudentEdit(classId, studentId) {
            const name = document.getElementById('editName').value.trim();
            const father = document.getElementById('editFather').value.trim();
            const mother = document.getElementById('editMother').value.trim();
            const contact = document.getElementById('editContact').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            
            if (!name) {
                alert('Name is required!');
                return;
            }
            
            const userPhone = getCurrentUser();
            let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const studentIndex = classes[classIndex].students.findIndex(s => s.id === studentId);
            
            classes[classIndex].students[studentIndex] = {
                id: studentId,
                name: name,
                fatherName: father,
                motherName: mother,
                contact: contact,
                address: address
            };
            
            localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
            alert('‚úÖ Student updated!');
            viewStudents(classId);
        }

        function deleteStudent(classId, studentId) {
            if (confirm('Delete this student permanently?')) {
                const userPhone = getCurrentUser();
                let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                classes[classIndex].students = classes[classIndex].students.filter(s => s.id !== studentId);
                
                localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
                alert('‚úÖ Student deleted!');
                viewStudents(classId);
            }
        }

        // =================
        // SCORESHEET SYSTEM
        // =================

        function createScoresheet(classId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('Please add students first!');
                return;
            }
            
            document.getElementById('testWorkArea').innerHTML = `
                <div style="border: 2px solid red; padding: 20px; margin: 20px;">
                    <h4>üìù Create New Test Scoresheet</h4>
                    
                    <label>Subject:</label><br>
                    <select id="testSubject" style="width: 300px; padding: 10px; margin: 10px;">
                        <option value="">Select Subject</option>
                        <option value="English">English</option>
                        <option value="Math">Math</option>
                        <option value="Urdu">Urdu</option>
                        <option value="Islamiyat">Islamiyat</option>
                        <option value="Science">Science</option>
                        <option value="Social Studies">Social Studies</option>
                        <option value="General Knowledge">General Knowledge</option>
                    </select><br>
                    
                    <label>Topic/Chapter:</label><br>
                    <input type="text" id="testTopic" placeholder="e.g. Chapter 5 - Nouns" style="width: 300px; padding: 10px; margin: 10px;"><br>
                    
                    <label>Assessment Type:</label><br>
                    <input type="radio" name="assessType" value="marks" checked> Marks Based (e.g. 85/100)<br>
                    <input type="radio" name="assessType" value="tick"> Tick/Cross Based<br><br>
                    
                    <div id="marksSection">
                        <label>Total Marks:</label><br>
                        <input type="number" id="totalMarks" placeholder="100" style="width: 200px; padding: 10px; margin: 10px;"><br>
                    </div>
                    
                    <button onclick="generateTestSheet(${classId})" style="background: red; color: white; padding: 20px; font-size: 18px;">
                        üìä Generate Test Sheet
                    </button>
                </div>
            `;
            
            document.querySelectorAll('input[name="assessType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('marksSection').style.display = 
                        this.value === 'marks' ? 'block' : 'none';
                });
            });
        }

        function generateTestSheet(classId) {
            const subject = document.getElementById('testSubject').value;
            const topic = document.getElementById('testTopic').value;
            const assessType = document.querySelector('input[name="assessType"]:checked').value;
            const totalMarks = document.getElementById('totalMarks').value;
            
            if (!subject || !topic) {
                alert('Please fill subject and topic!');
                return;
            }
            
            if (assessType === 'marks' && !totalMarks) {
                alert('Please enter total marks!');
                return;
            }
            
            if (assessType === 'marks') {
                showMarksSheet(classId, subject, topic, totalMarks);
            } else {
                showTickSheet(classId, subject, topic);
            }
        }

        function showMarksSheet(classId, subject, topic, totalMarks) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <div id="printableSheet" style="border: 3px solid red; padding: 20px; margin: 20px; background: white;">
                    <div style="text-align: center;">
                        <h3>${subject} Test - ${topic}</h3>
                        <p><strong>Class:</strong> ${currentClass.name} | <strong>Total Marks:</strong> ${totalMarks}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table border="2" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px;">Roll No.</th>
                            <th style="padding: 10px;">Student Name</th>
                            <th style="padding: 10px;">Obtained Marks</th>
                            <th style="padding: 10px;">Percentage</th>
                            <th style="padding: 10px;">Grade</th>
                        </tr>
            `;
            
            currentClass.students.forEach((student, index) => {
                html += `
                    <tr>
                        <td style="padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px;">${student.name}</td>
                        <td style="padding: 10px; text-align: center;">
                            <input type="number" id="marks_${student.id}" max="${totalMarks}" min="0" 
                                onchange="calculateGradeNow(${student.id}, ${totalMarks})"
                                style="width: 80px; padding: 5px; text-align: center; font-size: 16px;">
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <span id="percent_${student.id}" style="font-weight: bold;">-</span>
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <span id="grade_${student.id}" style="font-weight: bold;">-</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </div>
                
                <div style="text-align: center; margin: 20px;">
                    <button onclick="saveMarksTest(${classId}, '${subject}', '${topic}', ${totalMarks})" 
                        style="background: green; color: white; padding: 20px; margin: 10px; font-size: 18px;">
                        üíæ Save Test Results
                    </button>
                    <button onclick="printTestSheet()" 
                        style="background: blue; color: white; padding: 20px; margin: 10px; font-size: 18px;">
                        üñ®Ô∏è Print Test Sheet
                    </button>
                </div>
            `;
            
            document.getElementById('testWorkArea').innerHTML = html;
        }

        function calculateGradeNow(studentId, totalMarks) {
            const marks = document.getElementById(`marks_${studentId}`).value;
            if (marks !== '') {
                const percent = Math.round((marks / totalMarks) * 100);
                document.getElementById(`percent_${studentId}`).textContent = percent + '%';
                
                let grade = 'F';
                if (percent >= 90) grade = 'A+';
                else if (percent >= 80) grade = 'A';
                else if (percent >= 70) grade = 'B';
                else if (percent >= 60) grade = 'C';
                else if (percent >= 50) grade = 'D';
                
                document.getElementById(`grade_${studentId}`).textContent = grade;
            }
        }

        function saveMarksTest(classId, subject, topic, totalMarks) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            const testData = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                type: 'marks',
                totalMarks: parseInt(totalMarks),
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            currentClass.students.forEach(student => {
                const marks = document.getElementById(`marks_${student.id}`).value || 0;
                const percent = totalMarks > 0 ? Math.round((marks / totalMarks) * 100) : 0;
                
                testData.scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    obtainedMarks: parseInt(marks),
                    percentage: percent
                });
            });
            
            let updatedClasses = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = updatedClasses.findIndex(c => c.id === classId);
            updatedClasses[classIndex].scoresheets.push(testData);
            localStorage.setItem(userPhone + '_classes', JSON.stringify(updatedClasses));
            
            alert('‚úÖ Test results saved successfully!');
            openClass(classId);
        }

        function showTickSheet(classId, subject, topic) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <div id="printableTickSheet" style="border: 3px solid green; padding: 20px; margin: 20px; background: white;">
                    <div style="text-align: center;">
                        <h3>${subject} - ${topic}</h3>
                        <p><strong>Class:</strong> ${currentClass.name} | <strong>Type:</strong> Tick/Cross Assessment</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table border="2" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 15px;">Student Name</th>
                            <th style="padding: 15px;">Completed</th>
                            <th style="padding: 15px;">Status</th>
                        </tr>
            `;
            
            currentClass.students.forEach(student => {
                html += `
                    <tr>
                        <td style="padding: 15px;">${student.name}</td>
                        <td style="padding: 15px; text-align: center;">
                            <input type="checkbox" id="tick_${student.id}" onchange="updateTickStatus(${student.id})"
                                style="width: 25px; height: 25px;">
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <span id="status_${student.id}" style="font-weight: bold; color: red;">Not Done</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </div>
                
                <div style="text-align: center; margin: 20px;">
                    <button onclick="saveTickTest(${classId}, '${subject}', '${topic}')" 
                        style="background: green; color: white; padding: 20px; margin: 10px; font-size: 18px;">
                        üíæ Save Assessment
                    </button>
                    <button onclick="printTickSheet()" 
                        style="background: blue; color: white; padding: 20px; margin: 10px; font-size: 18px;">
                        üñ®Ô∏è Print Assessment
                    </button>
                </div>
            `;
            
            document.getElementById('testWorkArea').innerHTML = html;
        }

        function updateTickStatus(studentId) {
            const checkbox = document.getElementById(`tick_${studentId}`);
            const status = document.getElementById(`status_${studentId}`);
            
            if (checkbox.checked) {
                status.textContent = 'Completed ‚úÖ';
                status.style.color = 'green';
            } else {
                status.textContent = 'Not Done ‚ùå';
                status.style.color = 'red';
            }
        }

        function saveTickTest(classId, subject, topic) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            const testData = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                type: 'tick',
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            currentClass.students.forEach(student => {
                const completed = document.getElementById(`tick_${student.id}`).checked;
                
                testData.scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    completed: completed,
                    status: completed ? 'Completed' : 'Not Done'
                });
            });
            
            let updatedClasses = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const classIndex = updatedClasses.findIndex(c => c.id === classId);
            updatedClasses[classIndex].scoresheets.push(testData);
            localStorage.setItem(userPhone + '_classes', JSON.stringify(updatedClasses));
            
            alert('‚úÖ Assessment saved successfully!');
            openClass(classId);
        }

        // =================
        // PRINT FUNCTIONS
        // =================

        function printTestSheet() {
            const content = document.getElementById('printableSheet').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Test Sheet</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f0f0f0; }
                    </style>
                </head>
                <body>
                    ${content}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printTickSheet() {
            const content = document.getElementById('printableTickSheet').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Assessment Sheet</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f0f0f0; }
                    </style>
                </head>
                <body>
                    ${content}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // =================
        // VIEW TESTS
        // =================

        function viewTests(classId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            let html = `
                <div style="border: 2px solid orange; padding: 20px; margin: 20px;">
                    <h4>üìä All Tests for ${currentClass.name}</h4>
            `;
            
            if (currentClass.scoresheets.length === 0) {
                html += '<p>No tests created yet.</p>';
            } else {
                html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f0f0f0;"><th>Subject</th><th>Topic</th><th>Type</th><th>Date</th><th>Actions</th></tr>';
                
                currentClass.scoresheets.forEach(test => {
                    html += `
                        <tr>
                            <td style="padding: 10px;">${test.subject}</td>
                            <td style="padding: 10px;">${test.topic}</td>
                            <td style="padding: 10px;">${test.type}</td>
                            <td style="padding: 10px;">${test.date}</td>
                            <td style="padding: 10px;">
                                <button onclick="deleteTest(${classId}, ${test.id})" style="background: red; color: white; padding: 5px;">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</table>';
            }
            
            html += `
                <br>
                <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px;">
                    ‚¨ÖÔ∏è Back to Class
                </button>
            </div>
            `;
            
            document.getElementById('testWorkArea').innerHTML = html;
        }

        function deleteTest(classId, testId) {
            if (confirm('Delete this test permanently?')) {
                const userPhone = getCurrentUser();
                let classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                
                classes[classIndex].scoresheets = classes[classIndex].scoresheets.filter(t => t.id !== testId);
                
                localStorage.setItem(userPhone + '_classes', JSON.stringify(classes));
                alert('‚úÖ Test deleted!');
                viewTests(classId);
            }
        }

        // =================
        // HELPER FUNCTIONS
        // =================

        function getCurrentUser() {
            const user = JSON.parse(localStorage.getItem('ustaadDostUser') || '{}');
            return user.phone || 'unknown';
        }

        // =================
        // STUDENT REPORTS
        // =================

        function studentReports(classId, studentId) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const studentTests = currentClass.scoresheets.filter(test => 
                test.scores.some(score => score.studentId === studentId)
            );
            
            document.getElementById('studentWorkArea').innerHTML = `
                <div style="border: 2px solid purple; padding: 20px; margin: 20px;">
                    <h4>üìä ${student.name} - Progress Reports</h4>
                    
                    <div style="margin: 20px 0;">
                        <button onclick="printWeeklyReport(${classId}, ${studentId})" 
                            style="background: blue; color: white; padding: 15px; margin: 5px; font-size: 16px;">
                            üìÖ Weekly Report
                        </button>
                        <button onclick="printMonthlyReport(${classId}, ${studentId})" 
                            style="background: green; color: white; padding: 15px; margin: 5px; font-size: 16px;">
                            üìÖ Monthly Report
                        </button>
                        <button onclick="printYearlyReport(${classId}, ${studentId})" 
                            style="background: purple; color: white; padding: 15px; margin: 5px; font-size: 16px;">
                            üìÖ Yearly Report
                        </button>
                    </div>
                    
                    <div style="background: #f9f9f9; padding: 15px; margin: 15px 0;">
                        <h5>Recent Test Results:</h5>
                        ${studentTests.map(test => {
                            const studentScore = test.scores.find(score => score.studentId === studentId);
                            return `
                                <p>${test.subject} - ${test.topic} (${test.date}): 
                                ${test.type === 'marks' ? 
                                    `${studentScore.obtainedMarks}/${test.totalMarks} (${studentScore.percentage}%)` : 
                                    studentScore.status
                                }</p>
                            `;
                        }).join('')}
                    </div>
                    
                    <button onclick="viewStudents(${classId})" style="background: gray; color: white; padding: 15px;">
                        ‚¨ÖÔ∏è Back to Students
                    </button>
                </div>
            `;
        }

        function printWeeklyReport(classId, studentId) {
            printStudentReport(classId, studentId, 'Weekly', 7);
        }

        function printMonthlyReport(classId, studentId) {
            printStudentReport(classId, studentId, 'Monthly', 30);
        }

        function printYearlyReport(classId, studentId) {
            printStudentReport(classId, studentId, 'Yearly', 365);
        }

        function printStudentReport(classId, studentId, reportType, daysBack) {
            const userPhone = getCurrentUser();
            const classes = JSON.parse(localStorage.getItem(userPhone + '_classes') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysBack);
            
            const relevantTests = currentClass.scoresheets.filter(test => {
                const testDate = new Date(test.date);
                return testDate >= cutoffDate;
            });
            
            const studentScores = relevantTests.map(test => {
                const score = test.scores.find(s => s.studentId === studentId);
                return { test, score };
            }).filter(item => item.score);
            
            const marksTests = studentScores.filter(item => item.test.type === 'marks');
            const avgPercentage = marksTests.length > 0 ? 
                Math.round(marksTests.reduce((sum, item) => sum + item.score.percentage, 0) / marksTests.length) : 0;
            
            const reportContent = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>${reportType} Progress Report</h2>
                    <h3>Student: ${student.name}</h3>
                    <p>Class: ${currentClass.name}</p>
                    <p>Father: ${student.fatherName || 'N/A'} | Contact: ${student.contact || 'N/A'}</p>
                    <p>Report Date: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Summary:</h4>
                    <p><strong>Total Tests:</strong> ${studentScores.length}</p>
                    <p><strong>Average Score:</strong> ${avgPercentage}%</p>
                </div>
                
                <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 10px;">Subject</th>
                        <th style="padding: 10px;">Topic</th>
                        <th style="padding: 10px;">Date</th>
                        <th style="padding: 10px;">Result</th>
                    </tr>
                    ${studentScores.map(item => `
                        <tr>
                            <td style="padding: 10px;">${item.test.subject}</td>
                            <td style="padding: 10px;">${item.test.topic}</td>
                            <td style="padding: 10px;">${item.test.date}</td>
                            <td style="padding: 10px;">
                                ${item.test.type === 'marks' ? 
                                    `${item.score.obtainedMarks}/${item.test.totalMarks} (${item.score.percentage}%)` : 
                                    item.score.status
                                }
                            </td>
                        </tr>
                    `).join('')}
                </table>
                
                <div style="margin-top: 40px;">
                    <p><strong>Teacher Comments:</strong> _________________________________</p>
                    <br>
                    <p><strong>Parent Signature:</strong> _________________________________</p>
                </div>
            `;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${reportType} Report - ${student.name}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${reportContent}
                    <p style="text-align: center; margin-top: 30px; font-size: 12px;">
                        Generated by Ustaad Dost - ${new Date().toLocaleString()}
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        window.onload = function() {
            const phoneNumber = '{{ phone_number }}';
            if (phoneNumber) {
                localStorage.setItem('ustaadDostUser', JSON.stringify({ phone: phoneNumber }));
            }
            showGradingBuddy();
        };
    </script>
</body>
</html>
