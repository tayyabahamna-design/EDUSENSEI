<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Grading Buddy - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1, 99999)|random }}">
    <!-- Make sure this is in your HTML -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üìä Grading Buddy</h1>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">üè† Dashboard</a>
                <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                <a href="{{ url_for('logout') }}" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="grading-container">
            <div class="welcome-section">
                <h1>üìä Grading Buddy</h1>
                <p class="welcome-subtitle">Manage your classes, students, and assessments with comprehensive grading tools</p>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card">
                    <div class="action-icon">üë•</div>
                    <h3>Class Management</h3>
                    <p>Create and manage classes for grades 1-5</p>
                    <button class="btn btn-primary" onclick="showSection('classes')">üìö Manage Classes</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üë§</div>
                    <h3>Student Profiles</h3>
                    <p>Add students with guardian contacts and CNIC</p>
                    <button class="btn btn-success" onclick="showSection('students')">üë• Add Students</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üìù</div>
                    <h3>Scoresheets</h3>
                    <p>Create custom scoresheets and assessments</p>
                    <button class="btn btn-secondary" onclick="showSection('scoresheets')">üìä Create Scoresheet</button>
                </div>
                <div class="action-card">
                    <div class="action-icon">üìÑ</div>
                    <h3>Reports</h3>
                    <p>Generate PDF reports for students and classes</p>
                    <button class="btn btn-accent" onclick="showSection('reports')">üìà View Reports</button>
                </div>
            </div>

            <!-- Class Management Section -->
            <div id="classes-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üë• Class Management</h2>
                    <button class="btn btn-primary" onclick="addNewClass()">‚ûï Add New Class</button>
                </div>
                
                <div class="classes-grid">
                    <!-- Classes will be loaded here dynamically -->
                </div>
            </div>

            <!-- Student Management Section -->
            <div id="students-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üë§ Student Management</h2>
                    <button class="btn btn-primary" onclick="addNewStudent()">‚ûï Add New Student</button>
                </div>
                
                <div class="add-students-section">
                    <h3>Add Students to Class</h3>
                    
                    <div class="upload-options">
                        <button class="btn btn-secondary" onclick="manualEntry()">üìù Manual Entry</button>
                        <button class="btn btn-accent" onclick="uploadPicture()">üì∏ Upload Picture</button>
                        <button class="btn btn-primary" onclick="bulkImport()">üìã Bulk Import</button>
                    </div>
                    
                    <div id="bulkImportSection" style="display:none;" class="bulk-import-section">
                        <h4>üìã Bulk Import Students</h4>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Select Class:</label>
                            <select id="bulkImportClassSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>
                        
                        <p>Paste student names (one per line):</p>
                        <textarea id="bulkNamesList" placeholder="Husnain Fatima&#10;Humaira Fatima&#10;Ayesha Nadeem&#10;..." rows="10" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
                        <button class="btn btn-success" onclick="processBulkImport()">‚úÖ Add All Students</button>
                        <button class="btn btn-secondary" onclick="cancelBulkImport()">‚ùå Cancel</button>
                    </div>
                    
                    <div id="pictureUpload" style="display:none;" class="picture-upload-section">
                        <div class="upload-area">
                            <input type="file" id="studentListImage" accept="image/jpeg,image/jpg,image/png,image/bmp,image/webp,application/pdf" style="display:none;">
                            <div class="upload-dropzone" onclick="document.getElementById('studentListImage').click();">
                                <div class="upload-icon">üì∑</div>
                                <p>Click to upload student list image</p>
                                <small>Supports: JPG, PNG, BMP, WebP, PDF with student names</small>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="extractNamesFromImage()" id="extractBtn" style="display:none;">üîç Extract Names</button>
                        <div id="extractedNames" class="extracted-names-section"></div>
                    </div>
                </div>
                
                <div class="student-form" id="manualStudentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="student-name">Student Name</label>
                            <input type="text" id="student-name" class="form-input" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="student-class">Class</label>
                            <select id="student-class" class="form-select">
                                <option value="">Select Class...</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-roll">Roll Number</label>
                            <input type="text" id="student-roll" class="form-input" placeholder="Enter roll number">
                        </div>
                        <div class="form-group">
                            <label for="guardian-name">Guardian Name</label>
                            <input type="text" id="guardian-name" class="form-input" placeholder="Parent/Guardian name">
                        </div>
                        <div class="form-group">
                            <label for="guardian-cnic">Guardian CNIC</label>
                            <input type="text" id="guardian-cnic" class="form-input" placeholder="XXXXX-XXXXXXX-X">
                        </div>
                        <div class="form-group">
                            <label for="guardian-phone">Contact Number</label>
                            <input type="tel" id="guardian-phone" class="form-input" placeholder="03XX-XXXXXXX">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewStudent()">üíæ Save Student</button>
                </div>
            </div>

            <!-- Scoresheets Section -->
            <div id="scoresheets-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üìù Scoresheets & Assessments</h2>
                    <button class="btn btn-primary" onclick="createScoresheet()">üìä Create New Scoresheet</button>
                </div>
                
                <div class="scoresheet-options">
                    <div class="option-card">
                        <div class="option-icon">‚úÖ</div>
                        <h3>Screener Grading</h3>
                        <p>7-task checkbox system for quick assessment</p>
                        <button class="btn btn-primary">üìã Start Screener</button>
                    </div>
                    <div class="option-card">
                        <div class="option-icon">üìä</div>
                        <h3>Custom Scoresheet</h3>
                        <p>Create customizable scoresheets with auto date/time</p>
                        <button class="btn btn-secondary">üìù Custom Scoresheet</button>
                    </div>
                    <div class="option-card">
                        <div class="option-icon">üìà</div>
                        <h3>Progress Tracking</h3>
                        <p>Monitor student progress and analytics</p>
                        <button class="btn btn-accent">üìà View Progress</button>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>üìÑ Reports & Analytics</h2>
                    <button class="btn btn-primary" onclick="generateReport()">üìä Generate Report</button>
                </div>
                
                <div class="report-options">
                    <div class="report-type">
                        <h3>Individual Student Reports</h3>
                        <div class="report-controls">
                            <select class="form-select">
                                <option>Select Student...</option>
                            </select>
                            <button class="btn btn-primary">üìÑ Generate PDF</button>
                        </div>
                    </div>
                    
                    <div class="report-type">
                        <h3>Class Performance Reports</h3>
                        <div class="report-controls">
                            <select class="form-select">
                                <option>Select Class...</option>
                                <option>Grade 4 - Section A</option>
                                <option>Grade 3 - Section B</option>
                                <option>Grade 5 - Section A</option>
                            </select>
                            <button class="btn btn-secondary">üìä Class Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Highlights -->
            <div class="features-section">
                <h2>üåü Grading Buddy Features</h2>
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon">üë•</div>
                        <h3>Class Management</h3>
                        <p>Organize students by grades 1-5 with section support</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìù</div>
                        <h3>Custom Scoresheets</h3>
                        <p>Create tailored assessments with automatic timestamps</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">‚úÖ</div>
                        <h3>Screener Grading</h3>
                        <p>Quick 7-task checkbox system for rapid evaluation</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìÑ</div>
                        <h3>PDF Reports</h3>
                        <p>Professional reports for students and entire classes</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <style>
        .navbar {
            background: linear-gradient(135deg, var(--sage-green), var(--soft-blue));
            box-shadow: var(--shadow-md);
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .nav-welcome {
            color: white;
            font-weight: 500;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-section h1 {
            color: var(--sage-green-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: var(--gray-600);
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .action-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .action-card h3 {
            color: var(--gray-700);
            margin-bottom: 10px;
        }
        
        .action-card p {
            color: var(--gray-600);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .content-section {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .section-header h2 {
            color: var(--gray-700);
            margin: 0;
        }
        
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .class-card {
            background: var(--gentle-mint-light);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--sage-green);
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .class-header h3 {
            color: var(--gray-700);
            margin: 0;
        }
        
        .student-count {
            background: var(--sage-green);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .class-details {
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .value {
            color: var(--gray-600);
        }
        
        .class-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .form-input, .form-select {
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--sage-green);
        }
        
        .scoresheet-options, .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .option-card {
            background: var(--soft-blue-light);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--soft-blue);
        }
        
        .option-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .report-type {
            background: var(--warm-cream-light);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--warm-cream-dark);
        }
        
        .report-type h3 {
            color: var(--gray-700);
            margin-bottom: 15px;
        }
        
        .report-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--soft-blue), var(--soft-blue-dark));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--sage-green), var(--sage-green-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
            color: white;
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--warm-cream-dark), var(--gentle-mint));
            color: var(--gray-700);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* NEW GRADING SYSTEM STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .class-detail-view {
            padding: 20px;
        }
        
        .class-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .action-btn.primary {
            background: var(--sage-green);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .students-summary {
            margin: 20px 0;
        }
        
        .student-list-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .student-tag {
            background: var(--soft-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .more-students {
            background: var(--gray-400);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .test-preview {
            background: var(--warm-white);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid var(--sage-green);
        }
        
        .create-test-form {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .assessment-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .assessment-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .save-btn {
            background: var(--sage-green);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: var(--gray-500);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .scoresheet, .exercise-checklist {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .scores-table, .checklist-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .scores-table table, .checklist-table table, .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .scores-table th, .checklist-table th, .results-table th,
        .scores-table td, .checklist-table td, .results-table td {
            padding: 12px;
            border: 1px solid var(--gray-300);
            text-align: left;
        }
        
        .scores-table th, .checklist-table th, .results-table th {
            background: var(--sage-green);
            color: white;
            font-weight: 600;
        }
        
        .scores-table input[type="number"], .checklist-table input[type="checkbox"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
        }
        
        .checklist-table input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .test-results, .exercise-results {
            max-width: 100%;
            margin: 20px 0;
        }
        
        .results-summary {
            background: var(--mint-green);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .grade-a, .grade-a\+ {
            background: #d4edda;
            color: #155724;
            font-weight: 700;
        }
        
        .grade-b {
            background: #fff3cd;
            color: #856404;
            font-weight: 600;
        }
        
        .grade-c {
            background: #ffeaa7;
            color: #6c6c00;
            font-weight: 600;
        }
        
        .grade-d {
            background: #fdcb6e;
            color: #8b4513;
            font-weight: 600;
        }
        
        .grade-f {
            background: #f8d7da;
            color: #721c24;
            font-weight: 700;
        }
        
        .no-classes {
            text-align: center;
            padding: 40px 20px;
            background: var(--warm-white);
            border-radius: 15px;
            color: var(--gray-600);
        }
        
        .features-section {
            text-align: center;
            margin-top: 50px;
        }
        
        .features-section h2 {
            color: var(--gray-700);
            margin-bottom: 30px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .feature-item {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .feature-item h3 {
            color: var(--gray-700);
            margin-bottom: 10px;
        }
        
        .feature-item p {
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(104, 211, 145, 0.1);
            color: var(--success);
            border: 1px solid rgba(104, 211, 145, 0.3);
        }
        
        .alert-error {
            background: rgba(252, 129, 129, 0.1);
            color: var(--danger);
            border: 1px solid rgba(252, 129, 129, 0.3);
        }
        
        /* Picture Upload Styling */
        .add-students-section {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 25px;
        }
        
        .upload-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .picture-upload-section {
            margin-top: 20px;
        }
        
        .upload-area {
            margin-bottom: 20px;
        }
        
        .upload-dropzone {
            border: 3px dashed var(--soft-blue);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(135, 206, 235, 0.05);
        }
        
        .upload-dropzone:hover {
            border-color: var(--soft-blue-dark);
            background: rgba(135, 206, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--soft-blue);
        }
        
        .upload-dropzone p {
            font-size: 1.1rem;
            color: var(--gray-700);
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .upload-dropzone small {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .extracted-names-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(104, 211, 145, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(104, 211, 145, 0.2);
        }
        
        .extracted-names-section h4 {
            color: var(--success);
            margin-bottom: 10px;
        }
        
        .instruction-text {
            color: var(--gray-600);
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .student-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .student-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
        }
        
        .student-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .student-name-input:focus {
            outline: none;
            border-color: var(--soft-blue);
            box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.2);
        }
        
        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        
        .extracted-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-warning {
            background: #d69e2e;
            color: white;
        }
        
        .btn-warning:hover {
            background: #b7791f;
        }
        
        /* NEW COMPONENT STYLES FOR STREAMLINED CLASS MANAGEMENT */
        .new-test-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        
        .new-test-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .new-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .class-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        
        .stat-card h4 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sage-green);
            margin: 0;
        }
        
        .stat-card p {
            margin: 5px 0 0 0;
            color: #666;
            font-weight: 500;
        }
        
        .class-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .section h4 {
            margin-top: 0;
            color: var(--sage-green-dark);
            border-bottom: 2px solid var(--soft-blue);
            padding-bottom: 10px;
        }
        
        .student-add-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .option-card {
            background: white;
            padding: 30px 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-color: var(--soft-blue);
        }
        
        .option-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .option-card h4 {
            margin: 10px 0 5px 0;
            color: var(--sage-green-dark);
        }
        
        .option-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .manual-add-form, .picture-add-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .bulk-add {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .bulk-add h5 {
            margin: 0 0 10px 0;
            color: var(--sage-green-dark);
        }
        
        .bulk-add textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }
        
        .upload-area {
            margin: 20px 0;
            padding: 30px;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
        }
        
        .upload-preview {
            margin-top: 15px;
        }
        
        .extracted-name {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .name-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }
        
        .remove-btn {
            padding: 5px 8px;
            background: #fed7d7;
            color: #c53030;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .student-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .student-info h4 {
            margin: 0 0 10px 0;
            color: var(--sage-green-dark);
        }
        
        .student-details {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .student-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .edit-btn {
            background: var(--soft-blue);
            color: white;
        }
        
        .delete-btn {
            background: #fed7d7;
            color: #c53030;
        }
        
        .edit-btn:hover {
            background: #3182ce;
        }
        
        .delete-btn:hover {
            background: #feb2b2;
        }
        
        .add-btn, .save-btn, .extract-btn, .back-btn, .cancel-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .add-btn, .save-btn {
            background: var(--success);
            color: white;
        }
        
        .extract-btn {
            background: var(--soft-blue);
            color: white;
        }
        
        .back-btn {
            background: #718096;
            color: white;
        }
        
        .cancel-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .add-btn:hover, .save-btn:hover {
            background: #38a169;
        }
        
        .extract-btn:hover {
            background: #3182ce;
        }
        
        .back-btn:hover {
            background: #4a5568;
        }
        
        .cancel-btn:hover {
            background: #cbd5e0;
        }
        
        .edit-student-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                text-align: center;
            }
            
            .class-actions {
                justify-content: center;
            }
            
            .report-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .class-sections {
                grid-template-columns: 1fr;
            }
            
            .student-add-options {
                grid-template-columns: 1fr;
            }
            
            .class-stats {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
    
    <script>
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // HELPER FUNCTIONS FOR LOCALSTORAGE
        function getUserData(key) {
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        function saveUserData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // SIMPLE CLASS CREATION - NO SUBJECT FIELD
        function addNewClass() {
            const classFormHTML = `
                <div id="addClassForm" class="modal-overlay">
                    <div class="modal-content">
                        <h3>‚ûï Create New Class</h3>
                        <input type="text" id="className" placeholder="Class Name (e.g., Grade 3-A)" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <div style="text-align: center;">
                            <button onclick="saveClass()" style="background: green; color: white; padding: 12px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Create Class</button>
                            <button onclick="closeClassForm()" style="background: gray; color: white; padding: 12px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', classFormHTML);
        }
        
        // Alias for compatibility
        function addClass() {
            addNewClass();
        }

        function saveClass() {
            const className = document.getElementById('className').value.trim();
            
            if (!className) {
                alert('Please enter class name!');
                return;
            }
            
            const newClass = {
                id: Date.now(),
                name: className,
                students: [],
                scoresheets: []
            };
            
            let classes = getUserData('teacherClasses');
            classes.push(newClass);
            saveUserData('teacherClasses', classes);
            
            alert('‚úÖ Class created! Now add students.');
            loadExistingClasses();
            closeClassForm();
        }

        function closeClassForm() {
            const form = document.getElementById('addClassForm');
            if (form) form.remove();
        }

        function loadExistingClasses() {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classesGrid = document.querySelector('.classes-grid');
            
            if (classes.length === 0) {
                classesGrid.innerHTML = `
                    <div class="no-classes">
                        <p>üìö No classes created yet. Click "Add New Class" to get started!</p>
                    </div>
                `;
                return;
            }
            
            classesGrid.innerHTML = classes.map(classItem => `
                <div class="class-card">
                    <div class="class-header">
                        <h3>${classItem.name}</h3>
                        <span class="student-count">${classItem.students.length} Students</span>
                    </div>
                    <div class="class-details">
                        <div class="detail-item">
                            <span class="label">Tests:</span>
                            <span class="value">${classItem.scoresheets ? classItem.scoresheets.length : 0} assessments</span>
                        </div>
                    </div>
                    <div class="class-actions">
                        <button class="btn btn-sm btn-primary" onclick="openClass(${classItem.id})">üè´ Open Class</button>
                        <button class="btn btn-sm btn-secondary" onclick="addStudentsOptions(${classItem.id})">üë• Students</button>
                        <button class="btn btn-sm btn-accent" onclick="deleteClass(${classItem.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? This action cannot be undone.')) {
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                classes = classes.filter(c => c.id !== classId);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                loadExistingClasses();
                alert('‚úÖ Class deleted successfully!');
            }
        }

        function addStudents(classId) {
            document.getElementById('students-section').style.display = 'block';
            document.getElementById('students-section').scrollIntoView({ behavior: 'smooth' });
            
            // Store current class ID for student addition
            window.currentClassId = classId;
        }

        function addNewStudent() {
            if (!window.currentClassId) {
                alert('Please select a class first by clicking "üë• Students" from a class card.');
                return;
            }
            
            const studentName = document.getElementById('student-name').value;
            const studentClass = document.getElementById('student-class').value;
            const studentRoll = document.getElementById('student-roll').value;
            const guardianName = document.getElementById('guardian-name').value;
            const guardianCnic = document.getElementById('guardian-cnic').value;
            const guardianPhone = document.getElementById('guardian-phone').value;
            
            if (!studentName) {
                alert('Please enter student name!');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: studentName,
                class: studentClass,
                rollNumber: studentRoll,
                guardian: {
                    name: guardianName,
                    cnic: guardianCnic,
                    phone: guardianPhone
                }
            };
            
            // Add student to class
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === window.currentClassId);
            
            if (classIndex !== -1) {
                classes[classIndex].students.push(newStudent);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                
                alert('‚úÖ Student added successfully!');
                
                // Clear form
                document.getElementById('student-name').value = '';
                document.getElementById('student-class').value = '';
                document.getElementById('student-roll').value = '';
                document.getElementById('guardian-name').value = '';
                document.getElementById('guardian-cnic').value = '';
                document.getElementById('guardian-phone').value = '';
                
                loadExistingClasses();
            }
        }

        function createScoresheet() {
            if (!window.currentClassId) {
                alert('Please select a class first!');
                return;
            }
            createNewTest(window.currentClassId);
        }

        function generateReport() {
            alert('üìä Report generation feature coming soon! Will generate PDF reports for individual students and classes.');
        }

        // ENHANCED CLASS INTERFACE WITH NEW TEST BUTTON
        function openClass(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass) {
                alert('Class not found!');
                return;
            }
            
            // Create class detail section if it doesn't exist
            let classDetailSection = document.getElementById('classDetails');
            if (!classDetailSection) {
                classDetailSection = document.createElement('div');
                classDetailSection.id = 'classDetails';
                classDetailSection.className = 'content-section';
                document.querySelector('.grading-container').appendChild(classDetailSection);
            }
            
            classDetailSection.style.display = 'block';
            classDetailSection.innerHTML = `
                <div class="class-detail-view">
                    <h3>üìö ${currentClass.name}</h3>
                    
                    <!-- PROMINENT NEW TEST BUTTON -->
                    <div class="new-test-section">
                        <button onclick="createNewTest(${classId})" class="new-test-btn">
                            ‚ûï Create New Test
                        </button>
                    </div>
                    
                    <div class="class-stats">
                        <div class="stat-card">
                            <h4>${currentClass.students.length}</h4>
                            <p>Students</p>
                        </div>
                        <div class="stat-card">
                            <h4>${currentClass.scoresheets ? currentClass.scoresheets.length : 0}</h4>
                            <p>Tests Conducted</p>
                        </div>
                    </div>
                    
                    <div class="class-sections">
                        <div class="section">
                            <h4>üë• Students Management</h4>
                            <button onclick="addStudentsOptions(${classId})" class="action-btn">Add Students</button>
                            <button onclick="viewAllStudents(${classId})" class="action-btn">View All Students</button>
                        </div>
                        
                        <div class="section">
                            <h4>üìä Tests & Assessments</h4>
                            <div id="recentTests_${classId}"></div>
                            <button onclick="viewAllTests(${classId})" class="action-btn">View All Tests</button>
                        </div>
                    </div>
                </div>
            `;
            
            loadRecentTests(classId);
            classDetailSection.scrollIntoView({ behavior: 'smooth' });
        }

        function loadRecentTests(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const recentTestsDiv = document.getElementById(`recentTests_${classId}`);
            
            if (!currentClass.scoresheets || currentClass.scoresheets.length === 0) {
                recentTestsDiv.innerHTML = '<p>No tests created yet. Click "Create New Test" to get started!</p>';
                return;
            }
            
            const recentTests = currentClass.scoresheets.slice(-3).reverse(); // Show last 3 tests
            recentTestsDiv.innerHTML = recentTests.map(test => `
                <div class="test-preview">
                    <h5>${test.subject} - ${test.topic}</h5>
                    <p><strong>Type:</strong> ${test.type} | <strong>Date:</strong> ${test.date}</p>
                    <button onclick="viewTestResults(${classId}, ${test.id})" class="btn btn-sm btn-primary">üìä View Results</button>
                </div>
            `).join('');
        }

        function viewAllTests(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            alert(`üìä All Tests for ${currentClass.name}:\n\nTotal Tests: ${currentClass.scoresheets ? currentClass.scoresheets.length : 0}\n\nDetailed test history viewer coming soon!`);
        }

        // STUDENT ADDITION WITH MANUAL & PICTURE OPTIONS
        function addStudentsOptions(classId) {
            document.getElementById('classDetails').innerHTML = `
                <div class="add-students-container">
                    <h3>üë• Add Students to Class</h3>
                    
                    <div class="student-add-options">
                        <div class="option-card" onclick="manualStudentAdd(${classId})">
                            <div class="option-icon">‚úèÔ∏è</div>
                            <h4>Manual Entry</h4>
                            <p>Add students one by one</p>
                        </div>
                        
                        <div class="option-card" onclick="pictureStudentAdd(${classId})">
                            <div class="option-icon">üì∏</div>
                            <h4>Picture Upload</h4>
                            <p>Upload student list photo</p>
                        </div>
                    </div>
                    
                    <div id="studentAddInterface"></div>
                    
                    <button onclick="openClass(${classId})" class="back-btn">‚¨ÖÔ∏è Back to Class</button>
                </div>
            `;
        }

        function manualStudentAdd(classId) {
            document.getElementById('studentAddInterface').innerHTML = `
                <div class="manual-add-form" style="padding: 20px;">
                    <h4>‚úèÔ∏è Add Students</h4>
                    
                    <div class="single-add" style="margin-bottom: 30px;">
                        <h5>Add Single Student:</h5>
                        <input type="text" id="singleStudentName" placeholder="Student Name" 
                            style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; margin: 10px 0;">
                        <button onclick="addSingleStudent(${classId})" class="add-btn"
                            style="background: #007bff; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                            Add Student
                        </button>
                    </div>
                    
                    <div class="bulk-add" style="margin-top: 30px;">
                        <h5>Add Multiple Students (one name per line):</h5>
                        <textarea id="bulkStudents" 
                            placeholder="Ahmed Ali&#10;Fatima Khan&#10;Hassan Ahmed&#10;Ayesha Sheikh" 
                            rows="8" 
                            style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; margin: 10px 0; font-family: Arial;"></textarea>
                        <button onclick="addBulkStudents(${classId})" 
                            style="background: green; color: white; padding: 15px 30px; font-size: 18px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                            ‚úÖ Add All Students
                        </button>
                    </div>
                    
                    <button onclick="viewAllStudents(${classId})" 
                        style="background: #6c757d; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                        View All Students
                    </button>
                </div>
            `;
        }

        function addSingleStudent(classId) {
            const studentName = document.getElementById('singleStudentName').value.trim();
            
            if (!studentName) {
                alert('Please enter student name!');
                return;
            }
            
            const newStudent = {
                id: Date.now(),
                name: studentName,
                fatherName: '',
                motherName: '',
                contact: '',
                address: '',
                gender: ''
            };
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            classes[classIndex].students.push(newStudent);
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            // Clear input
            document.getElementById('singleStudentName').value = '';
            
            alert(`‚úÖ ${studentName} added successfully!`);
        }

        function addBulkStudents(classId) {
            const bulkText = document.getElementById('bulkStudents').value.trim();
            
            if (!bulkText) {
                alert('Please enter student names!');
                return;
            }
            
            // Split names by new lines and clean them
            const studentNames = bulkText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            if (studentNames.length === 0) {
                alert('No valid names found!');
                return;
            }
            
            // Create individual profiles for each student
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            
            let addedCount = 0;
            studentNames.forEach(name => {
                const newStudent = {
                    id: Date.now() + Math.random(), // Unique ID for each student
                    name: name,
                    fatherName: '',
                    motherName: '',
                    contact: '',
                    address: '',
                    gender: ''
                };
                
                classes[classIndex].students.push(newStudent);
                addedCount++;
            });
            
            // Save all students
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            // Clear the textarea
            document.getElementById('bulkStudents').value = '';
            
            alert(`‚úÖ ${addedCount} students added successfully! You can edit their profiles individually.`);
            
            // Show the list of students
            viewAllStudents(classId);
        }
        

        // PICTURE UPLOAD FOR STUDENT NAMES
        function pictureStudentAdd(classId) {
            document.getElementById('studentAddInterface').innerHTML = `
                <div class="picture-add-form">
                    <h4>üì∏ Upload Student List Picture</h4>
                    
                    <div class="warning" style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ‚ö†Ô∏è <strong>Note:</strong> OCR works best with:
                        <br>‚Ä¢ Clear, printed text
                        <br>‚Ä¢ Good lighting
                        <br>‚Ä¢ Dark text on light background
                        <br><strong>For handwritten lists, use MANUAL ENTRY instead.</strong>
                    </div>
                    
                    <div class="upload-area">
                        <input type="file" id="studentImages" accept="image/*" onchange="previewImages()">
                        <div class="upload-preview" id="imagePreview"></div>
                    </div>
                    
                    <button onclick="extractStudentNames(${classId})" class="extract-btn">üì∑ Try OCR</button>
                    <button onclick="manualStudentAdd(${classId})" style="background: #28a745; margin-left: 10px;">‚úèÔ∏è Manual Entry (Recommended)</button>
                    
                    <div id="extractedNamesContainer" style="display:none;">
                        <!-- Names will be dynamically inserted here by OCR -->
                    </div>
                </div>
            `;
        }

        function previewImages() {
            const files = document.getElementById('studentImages').files;
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML += `
                            <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin: 5px;">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function extractStudentNames(classId) {
            const imageFile = document.getElementById('studentImages').files[0];
            
            if (!imageFile) {
                alert('Please select an image first!');
                return;
            }
            
            document.getElementById('extractedNamesContainer').innerHTML = 'Reading handwritten names...';
            document.getElementById('extractedNamesContainer').style.display = 'block';
            
            // HANDWRITING OCR SETTINGS
            Tesseract.recognize(imageFile, 'eng', {
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ',
                tessedit_pageseg_mode: 6,
                preserve_interword_spaces: '1'
            })
            .then(({ data: { text } }) => {
                console.log('Raw OCR:', text);
                
                // FILTER OUT GARBAGE
                const lines = text.split('\n');
                const cleanNames = [];
                
                lines.forEach(line => {
                    let cleaned = line.trim();
                    // Remove symbols and numbers
                    cleaned = cleaned.replace(/[^A-Za-z\s]/g, '');
                    // Remove single letters
                    cleaned = cleaned.replace(/\b[A-Za-z]\b/g, '');
                    // Clean extra spaces
                    cleaned = cleaned.replace(/\s+/g, ' ').trim();
                    
                    // Only keep if looks like a name (2+ words, 5+ chars total)
                    if (cleaned.length >= 5 && cleaned.split(' ').length >= 2) {
                        cleanNames.push(cleaned);
                    }
                });
                
                if (cleanNames.length === 0) {
                    alert('‚ùå Handwriting unclear. Please use MANUAL ENTRY instead.');
                    manualStudentAdd(classId);
                    return;
                }
                
                showRealExtractedNames(cleanNames, classId);
            })
            .catch(error => {
                console.error('OCR failed:', error);
                alert('OCR failed for handwriting. Use MANUAL ENTRY.');
                manualStudentAdd(classId);
            });
        }

        function showRealExtractedNames(names, classId) {
            let html = '<h5>Names found in image:</h5>';
            names.forEach((name, index) => {
                html += `
                    <div>
                        <input type="text" id="name_${index}" value="${name}" />
                        <button onclick="removeName(${index})">Remove</button>
                    </div>
                `;
            });
            html += `<button onclick="saveRealNames(${classId}, ${names.length})">Save Names</button>`;
            
            document.getElementById('extractedNamesContainer').innerHTML = html;
        }

        function removeName(index) {
            document.getElementById(`name_${index}`).parentElement.remove();
        }

        function saveRealNames(classId, originalCount) {
            const students = [];
            
            // Collect all name inputs that still exist
            for (let i = 0; i < originalCount; i++) {
                const nameInput = document.getElementById(`name_${i}`);
                if (nameInput && nameInput.value.trim()) {
                    students.push({
                        id: Date.now() + Math.random(),
                        name: nameInput.value.trim(),
                        fatherName: '',
                        motherName: '',
                        contact: '',
                        address: '',
                        gender: ''
                    });
                }
            }
            
            // FORCE SAVE TO LOCALSTORAGE
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id == classId);
            
            if (classIndex !== -1) {
                classes[classIndex].students.push(...students);
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                alert(`‚úÖ ${students.length} students saved successfully!`);
                openClass(classId);
            }
        }


        function saveWeeklyPlan() {
            const planData = {}; // collect your plan data here
            
            // FORCE SAVE
            localStorage.setItem('yearlyPlan', JSON.stringify(planData));
            localStorage.setItem('weeklyTemplate', JSON.stringify(planData));
            
            alert('Plan saved successfully!');
        }

        // STUDENT PROFILE EDITING
        function viewAllStudents(classId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (!currentClass || !currentClass.students || currentClass.students.length === 0) {
                document.getElementById('classDetails').innerHTML = `
                    <h3>üë• Students in ${currentClass.name}</h3>
                    <p>No students added yet.</p>
                    <button onclick="manualStudentAdd(${classId})" style="background: green; color: white; padding: 15px; margin: 10px;">
                        ‚ûï Add Students
                    </button>
                    <button onclick="openClass(${classId})">‚¨ÖÔ∏è Back to Class</button>
                `;
                return;
            }
            
            let html = `
                <h3>üë• Students in ${currentClass.name} (${currentClass.students.length} students)</h3>
                
                <button onclick="manualStudentAdd(${classId})" style="background: green; color: white; padding: 10px; margin: 10px;">
                    ‚ûï Add More Students
                </button>
                
                <div class="students-grid">
            `;
            
            // Create individual student cards with edit/delete
            currentClass.students.forEach((student, index) => {
                html += `
                    <div class="student-card-${index}" style="border: 2px solid #333; padding: 15px; margin: 10px; background: #f9f9f9; border-radius: 8px;">
                        <h4 style="color: #007bff; margin: 0 0 10px 0;">${student.name}</h4>
                        
                        <div class="student-details">
                            <p><strong>Father:</strong> ${student.fatherName || 'Not added'}</p>
                            <p><strong>Mother:</strong> ${student.motherName || 'Not added'}</p>
                            <p><strong>Contact:</strong> ${student.contact || 'Not added'}</p>
                            <p><strong>Address:</strong> ${student.address || 'Not added'}</p>
                            <p><strong>Gender:</strong> ${student.gender || 'Not specified'}</p>
                        </div>
                        
                        <div class="student-actions" style="margin-top: 15px;">
                            <button onclick="editStudentProfile(${classId}, ${student.id})" 
                                style="background: #28a745; color: white; padding: 8px 12px; margin: 3px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                ‚úèÔ∏è Edit Profile
                            </button>
                            
                            <button onclick="deleteStudent(${classId}, ${student.id})" 
                                style="background: #dc3545; color: white; padding: 8px 12px; margin: 3px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                üóëÔ∏è Delete
                            </button>
                            
                            <button onclick="viewStudentProgress(${classId}, ${student.id})" 
                                style="background: #007bff; color: white; padding: 8px 12px; margin: 3px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                üìä Reports
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="text-align: center; margin: 20px;">
                    <button onclick="openClass(${classId})" 
                        style="background: #6c757d; color: white; padding: 15px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        ‚¨ÖÔ∏è Back to Class
                    </button>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = html;
        }

        function editStudentProfile(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const editForm = `
                <div class="edit-student-form">
                    <h3>‚úèÔ∏è Edit ${student.name}'s Profile</h3>
                    
                    <div class="form-fields">
                        <label>Student Name:</label>
                        <input type="text" id="editName" value="${student.name}" 
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                        <label>Father's Name:</label>
                        <input type="text" id="editFatherName" value="${student.fatherName || ''}" placeholder="Father's Name"
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                        <label>Mother's Name:</label>
                        <input type="text" id="editMotherName" value="${student.motherName || ''}" placeholder="Mother's Name"
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                        <label>Guardian Contact:</label>
                        <input type="tel" id="editContact" value="${student.contact || ''}" placeholder="03xxxxxxxxx"
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                        <label>Home Address:</label>
                        <input type="text" id="editAddress" value="${student.address || ''}" placeholder="Home Address"
                            style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        
                        <label>Gender:</label>
                        <select id="editGender" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                            <option value="">Select Gender</option>
                            <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                        </select>
                    </div>
                    
                    <div class="form-actions" style="text-align: center; margin-top: 20px;">
                        <button onclick="saveStudentProfile(${classId}, ${studentId})" 
                            style="background: #28a745; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                            üíæ Save Changes
                        </button>
                        
                        <button onclick="viewAllStudents(${classId})" 
                            style="background: #6c757d; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = editForm;
        }

        function saveStudentProfile(classId, studentId) {
            const updatedData = {
                name: document.getElementById('editName').value.trim(),
                fatherName: document.getElementById('editFatherName').value.trim(),
                motherName: document.getElementById('editMotherName').value.trim(),
                contact: document.getElementById('editContact').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                gender: document.getElementById('editGender').value
            };
            
            if (!updatedData.name) {
                alert('Student name is required!');
                return;
            }
            
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const studentIndex = classes[classIndex].students.findIndex(s => s.id === studentId);
            
            // Update student data
            Object.assign(classes[classIndex].students[studentIndex], updatedData);
            
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            alert('‚úÖ Student profile updated successfully!');
            viewAllStudents(classId);
        }

        function deleteStudent(classId, studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
                const classIndex = classes.findIndex(c => c.id === classId);
                classes[classIndex].students = classes[classIndex].students.filter(s => s.id !== studentId);
                
                localStorage.setItem('teacherClasses', JSON.stringify(classes));
                alert('‚úÖ Student deleted successfully!');
                viewAllStudents(classId);
            }
        }

        // CREATE NEW TEST WITH SUBJECT SELECTION AT SCORESHEET CREATION
        function createNewTest(classId) {
            const subjects = ['English', 'Math', 'Urdu', 'Islamiyat', 'Science', 'Social Studies', 'General Knowledge', 'Computer'];
            
            const testFormHTML = `
                <div class="create-test-form">
                    <h3>üìù Create New Scoresheet</h3>
                    
                    <label>Select Subject:</label>
                    <select id="testSubject" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">Choose Subject</option>
                        ${subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
                    </select>
                    
                    <label>Test Topic/Chapter:</label>
                    <input type="text" id="testTopic" placeholder="e.g., Chapter 5 - Nouns" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    
                    <label>Test Type:</label>
                    <select id="testType" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">Select Type</option>
                        <option value="Written Test">Written Test</option>
                        <option value="Oral Test">Oral Test</option>
                        <option value="Quiz">Quiz</option>
                        <option value="Assignment">Assignment</option>
                        <option value="Class Work">Class Work</option>
                        <option value="Homework">Homework</option>
                    </select>
                    
                    <label>Assessment Method:</label>
                    <div style="margin: 10px 0;">
                        <label><input type="radio" name="assessmentMethod" value="marks" checked> Marks Based (e.g., 85/100)</label><br>
                        <label><input type="radio" name="assessmentMethod" value="tick"> Tick/Cross Based</label>
                    </div>
                    
                    <div id="marksSection">
                        <label>Total Marks:</label>
                        <input type="number" id="totalMarks" placeholder="100" style="width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="generateScoresheet(${classId})" style="background: blue; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            üìä Generate Scoresheet
                        </button>
                        <button onclick="openClass(${classId})" style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = testFormHTML;
            
            // Hide marks section when tick/cross selected
            setTimeout(() => {
                document.querySelectorAll('input[name="assessmentMethod"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const marksSection = document.getElementById('marksSection');
                        if (this.value === 'tick') {
                            marksSection.style.display = 'none';
                        } else {
                            marksSection.style.display = 'block';
                        }
                    });
                });
            }, 100);
        }
        
        function generateScoresheet(classId) {
            const subject = document.getElementById('testSubject').value;
            const topic = document.getElementById('testTopic').value;
            const testType = document.getElementById('testType').value;
            const method = document.querySelector('input[name="assessmentMethod"]:checked').value;
            const totalMarks = document.getElementById('totalMarks') ? document.getElementById('totalMarks').value : null;
            
            if (!subject || !topic || !testType) {
                alert('Please fill all required fields!');
                return;
            }
            
            if (method === 'marks' && !totalMarks) {
                alert('Please enter total marks!');
                return;
            }
            
            const classes = getUserData('teacherClasses');
            const currentClass = classes.find(c => c.id == classId);
            
            if (!currentClass.students || currentClass.students.length === 0) {
                alert('Please add students first!');
                manualStudentAdd(classId);
                return;
            }
            
            const scoresheetData = {
                id: Date.now(),
                subject: subject,
                topic: topic,
                testType: testType,
                method: method,
                totalMarks: method === 'marks' ? parseInt(totalMarks) : null,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                scores: []
            };
            
            if (method === 'marks') {
                showMarksScoresheet(classId, scoresheetData);
            } else {
                showTickScoresheet(classId, scoresheetData);
            }
        }

        // MARKS-BASED SCORESHEET
        function showMarksScoresheet(classId, scoresheetData) {
            const classes = getUserData('teacherClasses');
            const currentClass = classes.find(c => c.id == classId);
            
            let scoresheetHTML = `
                <div class="scoresheet" id="printableScoresheet">
                    <div class="scoresheet-header">
                        <h3>üìä ${scoresheetData.subject} - ${scoresheetData.topic}</h3>
                        <p><strong>Class:</strong> ${currentClass.name} | <strong>Type:</strong> ${scoresheetData.testType}</p>
                        <p><strong>Date:</strong> ${scoresheetData.date} | <strong>Total Marks:</strong> ${scoresheetData.totalMarks}</p>
                    </div>
                    
                    <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px;">Roll No.</th>
                            <th style="padding: 10px;">Student Name</th>
                            <th style="padding: 10px;">Obtained Marks</th>
                            <th style="padding: 10px;">Percentage</th>
                            <th style="padding: 10px;">Grade</th>
                        </tr>
                        ${currentClass.students.map((student, index) => `
                            <tr>
                                <td style="padding: 10px; text-align: center;">${index + 1}</td>
                                <td style="padding: 10px;">${student.name}</td>
                                <td style="padding: 10px; text-align: center;">
                                    <input type="number" id="marks_${student.id}" max="${scoresheetData.totalMarks}" min="0" 
                                        onchange="calculatePercentage(${student.id}, ${scoresheetData.totalMarks})"
                                        style="width: 80px; padding: 5px; text-align: center; font-size: 16px;">
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span id="percentage_${student.id}">-</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span id="grade_${student.id}">-</span>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                
                <div class="scoresheet-actions" style="text-align: center; margin: 20px;">
                    <button onclick="saveScoresheet(${classId}, ${scoresheetData.id}, 'marks')" 
                        style="background: green; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        üíæ Save Scoresheet
                    </button>
                    <button onclick="printScoresheet()" 
                        style="background: blue; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        üñ®Ô∏è Print Scoresheet
                    </button>
                    <button onclick="openClass(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = scoresheetHTML;
            window.currentScoresheetData = scoresheetData;
        }
        
        function calculatePercentage(studentId, totalMarks) {
            const obtainedMarks = document.getElementById(`marks_${studentId}`).value;
            if (obtainedMarks !== '') {
                const percentage = Math.round((obtainedMarks / totalMarks) * 100);
                document.getElementById(`percentage_${studentId}`).textContent = percentage + '%';
                
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                
                document.getElementById(`grade_${studentId}`).textContent = grade;
            }
        }
        
        function printScoresheet() {
            const printContent = document.getElementById('printableScoresheet').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Scoresheet</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px;">Generated by Ustaad Dost - ${new Date().toLocaleString()}</p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        // TICK/CROSS SCORESHEET
        function showTickScoresheet(classId, scoresheetData) {
            const classes = getUserData('teacherClasses');
            const currentClass = classes.find(c => c.id == classId);
            
            let tickHTML = `
                <div class="tick-scoresheet" id="printableTickSheet">
                    <div class="scoresheet-header">
                        <h3>‚úÖ ${scoresheetData.subject} - ${scoresheetData.topic}</h3>
                        <p><strong>Class:</strong> ${currentClass.name} | <strong>Type:</strong> ${scoresheetData.testType}</p>
                        <p><strong>Date:</strong> ${scoresheetData.date} | <strong>Assessment:</strong> Tick/Cross Based</p>
                    </div>
                    
                    <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px;">Student Name</th>
                            <th style="padding: 10px;">Completed</th>
                            <th style="padding: 10px;">Status</th>
                        </tr>
                        ${currentClass.students.map(student => `
                            <tr>
                                <td style="padding: 10px;">${student.name}</td>
                                <td style="padding: 10px; text-align: center;">
                                    <input type="checkbox" id="tick_${student.id}" onchange="updateTickStatus(${student.id})"
                                        style="width: 20px; height: 20px;">
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span id="status_${student.id}">‚ùå Not Completed</span>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                
                <div class="scoresheet-actions" style="text-align: center; margin: 20px;">
                    <button onclick="saveScoresheet(${classId}, ${scoresheetData.id}, 'tick')" 
                        style="background: green; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        üíæ Save Scoresheet
                    </button>
                    <button onclick="printTickSheet()" 
                        style="background: blue; color: white; padding: 15px 30px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        üñ®Ô∏è Print Scoresheet
                    </button>
                    <button onclick="openClass(${classId})" 
                        style="background: gray; color: white; padding: 15px 30px; margin: 10px; border: none; border-radius: 5px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = tickHTML;
            window.currentScoresheetData = scoresheetData;
        }
        
        function updateTickStatus(studentId) {
            const isChecked = document.getElementById(`tick_${studentId}`).checked;
            const statusSpan = document.getElementById(`status_${studentId}`);
            
            if (isChecked) {
                statusSpan.textContent = '‚úÖ Completed';
                statusSpan.style.color = 'green';
            } else {
                statusSpan.textContent = '‚ùå Not Completed';
                statusSpan.style.color = 'red';
            }
        }
        
        function printTickSheet() {
            const printContent = document.getElementById('printableTickSheet').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Tick Sheet</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <p style="text-align: center; margin-top: 30px;">Generated by Ustaad Dost - ${new Date().toLocaleString()}</p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        // SAVE SCORESHEET
        function saveScoresheet(classId, scoresheetId, method) {
            const classes = getUserData('teacherClasses');
            const currentClass = classes.find(c => c.id == classId);
            const scoresheetData = window.currentScoresheetData;
            
            // Collect scores based on method
            if (method === 'marks') {
                scoresheetData.scores = currentClass.students.map(student => {
                    const obtainedMarks = document.getElementById(`marks_${student.id}`).value || 0;
                    const percentage = scoresheetData.totalMarks > 0 ? 
                        Math.round((obtainedMarks / scoresheetData.totalMarks) * 100) : 0;
                    
                    let grade = 'F';
                    if (percentage >= 90) grade = 'A+';
                    else if (percentage >= 80) grade = 'A';
                    else if (percentage >= 70) grade = 'B';
                    else if (percentage >= 60) grade = 'C';
                    else if (percentage >= 50) grade = 'D';
                    
                    return {
                        studentId: student.id,
                        studentName: student.name,
                        obtainedMarks: parseInt(obtainedMarks),
                        percentage: percentage,
                        grade: grade
                    };
                });
            } else {
                scoresheetData.scores = currentClass.students.map(student => {
                    const isCompleted = document.getElementById(`tick_${student.id}`).checked;
                    
                    return {
                        studentId: student.id,
                        studentName: student.name,
                        completed: isCompleted,
                        status: isCompleted ? 'Completed' : 'Not Completed'
                    };
                });
            }
            
            // Add to class scoresheets
            let updatedClasses = getUserData('teacherClasses');
            const classIndex = updatedClasses.findIndex(c => c.id == classId);
            
            if (!updatedClasses[classIndex].scoresheets) {
                updatedClasses[classIndex].scoresheets = [];
            }
            
            updatedClasses[classIndex].scoresheets.push(scoresheetData);
            saveUserData('teacherClasses', updatedClasses);
            
            alert('‚úÖ Scoresheet saved successfully!');
            openClass(classId);
        }
        
        function proceedToScoring(classId) {
            const subject = document.getElementById('testSubject').value;
            const testType = document.getElementById('testType').value;
            const topic = document.getElementById('testTopic').value;
            const totalMarks = document.getElementById('totalMarks').value;
            const assessmentType = document.querySelector('input[name="assessmentType"]:checked').value;
            
            if (!subject || !testType || !topic || !totalMarks) {
                alert('Please fill all required fields!');
                return;
            }
            
            const testData = {
                id: Date.now(),
                subject: subject,
                type: testType,
                topic: topic,
                totalMarks: parseInt(totalMarks),
                assessmentType: assessmentType,
                date: new Date().toLocaleDateString(),
                scores: []
            };
            
            if (assessmentType === 'marks') {
                createMarksScoresheet(classId, testData);
            } else {
                createExerciseChecklist(classId, testData);
            }
        }

        function cancelTestCreation(classId) {
            openClass(classId);
        }

        // MARKS SCORESHEET SYSTEM
        function createMarksScoresheet(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('Please add students first!');
                addStudents(classId);
                return;
            }
            
            let scoresheetHTML = `
                <div class="scoresheet">
                    <h3>üìä ${testData.subject} - ${testData.topic}</h3>
                    <p><strong>Type:</strong> ${testData.type} | <strong>Total Marks:</strong> ${testData.totalMarks} | <strong>Date:</strong> ${testData.date}</p>
                    
                    <div class="scores-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Obtained Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentClass.students.map(student => `
                                    <tr>
                                        <td>${student.name}</td>
                                        <td><input type="number" id="marks_${student.id}" max="${testData.totalMarks}" min="0" onchange="calculateGrade(${student.id}, ${testData.totalMarks})"></td>
                                        <td><span id="percentage_${student.id}">-</span></td>
                                        <td><span id="grade_${student.id}">-</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveScoresheet(${classId}, ${JSON.stringify(testData).replace(/"/g, '&quot;')})" class="save-btn">üíæ Save Test Results</button>
                        <button onclick="openClass(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = scoresheetHTML;
        }

        function calculateGrade(studentId, totalMarks) {
            const obtainedMarks = document.getElementById(`marks_${studentId}`).value;
            if (obtainedMarks) {
                const percentage = Math.round((obtainedMarks / totalMarks) * 100);
                document.getElementById(`percentage_${studentId}`).textContent = percentage + '%';
                
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                
                document.getElementById(`grade_${studentId}`).textContent = grade;
            }
        }

        // EXERCISE CHECKLIST (7 TASKS) SYSTEM
        function createExerciseChecklist(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            
            if (currentClass.students.length === 0) {
                alert('Please add students first!');
                addStudents(classId);
                return;
            }
            
            const exercises = [
                'Reading Comprehension', 
                'Writing Task', 
                'Vocabulary', 
                'Grammar Exercise', 
                'Speaking/Oral', 
                'Problem Solving', 
                'Creative Work'
            ];
            
            let checklistHTML = `
                <div class="exercise-checklist">
                    <h3>‚úÖ ${testData.subject} - ${testData.topic}</h3>
                    <p><strong>Type:</strong> Exercise Checklist | <strong>Date:</strong> ${testData.date}</p>
                    
                    <div class="checklist-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    ${exercises.map(exercise => `<th>${exercise}</th>`).join('')}
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentClass.students.map(student => `
                                    <tr>
                                        <td>${student.name}</td>
                                        ${exercises.map((exercise, index) => `
                                            <td><input type="checkbox" id="exercise_${student.id}_${index}" onchange="updateExerciseTotal(${student.id})"></td>
                                        `).join('')}
                                        <td><span id="total_${student.id}">0/7</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveExerciseChecklist(${classId}, ${JSON.stringify(testData).replace(/"/g, '&quot;')})" class="save-btn">üíæ Save Exercise Results</button>
                        <button onclick="openClass(${classId})" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = checklistHTML;
        }

        function updateExerciseTotal(studentId) {
            let checkedCount = 0;
            for (let i = 0; i < 7; i++) {
                const checkbox = document.getElementById(`exercise_${studentId}_${i}`);
                if (checkbox && checkbox.checked) {
                    checkedCount++;
                }
            }
            document.getElementById(`total_${studentId}`).textContent = `${checkedCount}/7`;
        }

        // SAVE SCORESHEET FUNCTIONS
        function saveScoresheet(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            // Collect all scores
            const scores = [];
            currentClass.students.forEach(student => {
                const obtainedMarks = document.getElementById(`marks_${student.id}`)?.value || 0;
                const percentage = Math.round((obtainedMarks / testData.totalMarks) * 100);
                let grade = 'F';
                if (percentage >= 90) grade = 'A+';
                else if (percentage >= 80) grade = 'A';
                else if (percentage >= 70) grade = 'B';
                else if (percentage >= 60) grade = 'C';
                else if (percentage >= 50) grade = 'D';
                
                scores.push({
                    studentId: student.id,
                    studentName: student.name,
                    obtainedMarks: parseInt(obtainedMarks) || 0,
                    percentage: percentage,
                    grade: grade
                });
            });
            
            testData.scores = scores;
            
            // Add scoresheet to class
            if (!currentClass.scoresheets) {
                currentClass.scoresheets = [];
            }
            currentClass.scoresheets.push(testData);
            
            // Save to localStorage
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            alert('‚úÖ Test scores saved successfully!');
            openClass(classId);
        }

        function saveExerciseChecklist(classId, testData) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === classId);
            const currentClass = classes[classIndex];
            
            // Collect exercise results
            const exerciseResults = [];
            currentClass.students.forEach(student => {
                let checkedCount = 0;
                const exercises = [];
                
                for (let i = 0; i < 7; i++) {
                    const checkbox = document.getElementById(`exercise_${student.id}_${i}`);
                    const isChecked = checkbox && checkbox.checked;
                    exercises.push(isChecked);
                    if (isChecked) checkedCount++;
                }
                
                exerciseResults.push({
                    studentId: student.id,
                    studentName: student.name,
                    exercises: exercises,
                    total: `${checkedCount}/7`,
                    completionRate: Math.round((checkedCount / 7) * 100) + '%'
                });
            });
            
            testData.exerciseResults = exerciseResults;
            
            // Add to class scoresheets
            if (!currentClass.scoresheets) {
                currentClass.scoresheets = [];
            }
            currentClass.scoresheets.push(testData);
            
            // Save to localStorage
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            alert('‚úÖ Exercise checklist saved successfully!');
            openClass(classId);
        }

        function viewTestResults(classId, testId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const test = currentClass.scoresheets.find(t => t.id === testId);
            
            if (!test) {
                alert('Test not found!');
                return;
            }
            
            let resultsHTML = '';
            if (test.assessmentType === 'marks') {
                resultsHTML = `
                    <div class="test-results">
                        <h3>üìä ${test.subject} - ${test.topic} Results</h3>
                        <p><strong>Type:</strong> ${test.type} | <strong>Date:</strong> ${test.date}</p>
                        
                        <div class="results-summary">
                            <h4>Class Performance:</h4>
                            <p>Average: ${calculateClassAverage(test.scores)}% | Highest: ${getHighestScore(test.scores)}% | Lowest: ${getLowestScore(test.scores)}%</p>
                        </div>
                        
                        <table class="results-table">
                            <thead>
                                <tr><th>Student</th><th>Marks</th><th>Percentage</th><th>Grade</th></tr>
                            </thead>
                            <tbody>
                                ${test.scores.map(score => `
                                    <tr>
                                        <td>${score.studentName}</td>
                                        <td>${score.obtainedMarks}/${test.totalMarks}</td>
                                        <td>${score.percentage}%</td>
                                        <td class="grade-${score.grade.toLowerCase()}">${score.grade}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <button onclick="openClass(${classId})" class="btn btn-secondary">Back to Class</button>
                    </div>
                `;
            } else {
                resultsHTML = `
                    <div class="exercise-results">
                        <h3>‚úÖ ${test.subject} - ${test.topic} Results</h3>
                        <p><strong>Type:</strong> Exercise Checklist | <strong>Date:</strong> ${test.date}</p>
                        
                        <table class="results-table">
                            <thead>
                                <tr><th>Student</th><th>Completed Tasks</th><th>Completion Rate</th></tr>
                            </thead>
                            <tbody>
                                ${test.exerciseResults.map(result => `
                                    <tr>
                                        <td>${result.studentName}</td>
                                        <td>${result.total}</td>
                                        <td>${result.completionRate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <button onclick="openClass(${classId})" class="btn btn-secondary">Back to Class</button>
                    </div>
                `;
            }
            
            document.getElementById('classDetails').innerHTML = resultsHTML;
        }

        function calculateClassAverage(scores) {
            if (scores.length === 0) return 0;
            const total = scores.reduce((sum, score) => sum + score.percentage, 0);
            return Math.round(total / scores.length);
        }

        function getHighestScore(scores) {
            return scores.length > 0 ? Math.max(...scores.map(s => s.percentage)) : 0;
        }

        function getLowestScore(scores) {
            return scores.length > 0 ? Math.min(...scores.map(s => s.percentage)) : 0;
        }
        
        // COMPREHENSIVE STUDENT REPORTING SYSTEM
        function viewStudentProgress(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const reportsHTML = `
                <div class="student-reports-menu">
                    <h3>üìä Reports for ${student.name}</h3>
                    
                    <div class="reports-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                        
                        <div class="report-card" style="border: 2px solid #007bff; padding: 20px; border-radius: 8px; background: #f0f8ff;">
                            <h4>üìù Individual Test Reports</h4>
                            <p>View printable report for each test</p>
                            <button onclick="viewIndividualTestReports(${classId}, ${studentId})" 
                                style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                View Tests
                            </button>
                        </div>
                        
                        <div class="report-card" style="border: 2px solid #28a745; padding: 20px; border-radius: 8px; background: #f0fff4;">
                            <h4>üìÖ Weekly Progress</h4>
                            <p>Last 7 days performance</p>
                            <button onclick="printWeeklyReport(${classId}, ${studentId})" 
                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                Print Weekly
                            </button>
                        </div>
                        
                        <div class="report-card" style="border: 2px solid #ffc107; padding: 20px; border-radius: 8px; background: #fffef0;">
                            <h4>üìÜ Monthly Progress</h4>
                            <p>This month's performance</p>
                            <button onclick="printMonthlyReport(${classId}, ${studentId})" 
                                style="background: #ffc107; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                Print Monthly
                            </button>
                        </div>
                        
                        <div class="report-card" style="border: 2px solid #dc3545; padding: 20px; border-radius: 8px; background: #fff5f5;">
                            <h4>üìä Yearly Progress</h4>
                            <p>Complete year performance</p>
                            <button onclick="printYearlyReport(${classId}, ${studentId})" 
                                style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                Print Yearly
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="viewAllStudents(${classId})" 
                            style="background: #6c757d; color: white; padding: 15px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                            ‚¨ÖÔ∏è Back to Students
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = reportsHTML;
        }
        
        // INDIVIDUAL TEST REPORTS
        function viewIndividualTestReports(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            if (!currentClass.scoresheets || currentClass.scoresheets.length === 0) {
                alert('No tests have been created yet!');
                viewStudentProgress(classId, studentId);
                return;
            }
            
            let testsHTML = `
                <div class="individual-tests">
                    <h3>üìù Test Reports for ${student.name}</h3>
                    
                    <div class="tests-list" style="margin: 20px 0;">
            `;
            
            currentClass.scoresheets.forEach(test => {
                let studentResult = null;
                
                if (test.assessmentType === 'marks') {
                    studentResult = test.scores.find(s => s.studentId === studentId);
                } else {
                    studentResult = test.exerciseResults.find(r => r.studentId === studentId);
                }
                
                if (studentResult) {
                    testsHTML += `
                        <div class="test-item" style="border: 2px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: white;">
                            <h4>${test.subject} - ${test.topic}</h4>
                            <p><strong>Type:</strong> ${test.type} | <strong>Date:</strong> ${test.date}</p>
                            ${test.assessmentType === 'marks' ? 
                                `<p><strong>Result:</strong> ${studentResult.obtainedMarks}/${test.totalMarks} (${studentResult.percentage}%) - Grade: ${studentResult.grade}</p>` :
                                `<p><strong>Result:</strong> ${studentResult.total} tasks completed (${studentResult.completionRate})</p>`
                            }
                            <button onclick="printIndividualTestReport(${classId}, ${studentId}, ${test.id})" 
                                style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                üñ®Ô∏è Print Test Report
                            </button>
                        </div>
                    `;
                }
            });
            
            testsHTML += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="viewStudentProgress(${classId}, ${studentId})" 
                            style="background: #6c757d; color: white; padding: 15px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                            ‚¨ÖÔ∏è Back to Reports Menu
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('classDetails').innerHTML = testsHTML;
        }
        
        // PRINT INDIVIDUAL TEST REPORT
        function printIndividualTestReport(classId, studentId, testId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            const test = currentClass.scoresheets.find(t => t.id === testId);
            
            let studentResult = null;
            if (test.assessmentType === 'marks') {
                studentResult = test.scores.find(s => s.studentId === studentId);
            } else {
                studentResult = test.exerciseResults.find(r => r.studentId === studentId);
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Test Report - ${student.name}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 40px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #007bff;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #007bff;
                            margin: 10px 0;
                        }
                        .info-section {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 10px 0;
                            padding: 8px;
                        }
                        .result-box {
                            background: #e7f3ff;
                            border: 2px solid #007bff;
                            padding: 30px;
                            text-align: center;
                            border-radius: 8px;
                            margin: 30px 0;
                        }
                        .result-box h2 {
                            color: #007bff;
                            font-size: 48px;
                            margin: 10px 0;
                        }
                        .footer {
                            margin-top: 50px;
                            border-top: 2px solid #ddd;
                            padding-top: 20px;
                            text-align: center;
                            color: #666;
                        }
                        .no-print {
                            text-align: center;
                            margin: 20px 0;
                        }
                        .print-btn {
                            background: #007bff;
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üéì USTAAD DOST</h1>
                        <h2>Individual Test Report</h2>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <strong>Student Name:</strong>
                            <span>${student.name}</span>
                        </div>
                        <div class="info-row">
                            <strong>Class:</strong>
                            <span>${currentClass.name}</span>
                        </div>
                        <div class="info-row">
                            <strong>Father's Name:</strong>
                            <span>${student.fatherName || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <strong>Subject:</strong>
                            <span>${test.subject}</span>
                        </div>
                        <div class="info-row">
                            <strong>Test Topic:</strong>
                            <span>${test.topic}</span>
                        </div>
                        <div class="info-row">
                            <strong>Test Type:</strong>
                            <span>${test.type}</span>
                        </div>
                        <div class="info-row">
                            <strong>Test Date:</strong>
                            <span>${test.date}</span>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        ${test.assessmentType === 'marks' ? `
                            <h3>Test Result</h3>
                            <h2>${studentResult.obtainedMarks} / ${test.totalMarks}</h2>
                            <h3>Percentage: ${studentResult.percentage}%</h3>
                            <h2>Grade: ${studentResult.grade}</h2>
                        ` : `
                            <h3>Exercise Completion</h3>
                            <h2>${studentResult.total}</h2>
                            <h3>Completion Rate: ${studentResult.completionRate}</h3>
                        `}
                    </div>
                    
                    <div class="footer">
                        <p><strong>Teacher's Signature: _______________</strong></p>
                        <p>USTAAD DOST - Pakistani Teacher Assistant App</p>
                    </div>
                    
                    <div class="no-print">
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
                        <button class="print-btn" onclick="window.close()" style="background: #6c757d; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // PRINT WEEKLY PROGRESS REPORT
        function printWeeklyReport(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const weeklyTests = getStudentTestsInPeriod(currentClass, studentId, weekAgo, new Date());
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Weekly Report - ${student.name}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 40px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #28a745;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 { color: #28a745; margin: 10px 0; }
                        .info-box {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 15px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: left;
                        }
                        th {
                            background: #28a745;
                            color: white;
                        }
                        .summary {
                            background: #e7f7ef;
                            border: 2px solid #28a745;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .footer {
                            margin-top: 40px;
                            border-top: 2px solid #ddd;
                            padding-top: 20px;
                            text-align: center;
                            color: #666;
                        }
                        .print-btn {
                            background: #28a745;
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üéì USTAAD DOST</h1>
                        <h2>Weekly Progress Report</h2>
                        <p>Period: ${weekAgo.toLocaleDateString()} to ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Student:</strong> ${student.name}</p>
                        <p><strong>Class:</strong> ${currentClass.name}</p>
                        <p><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</p>
                    </div>
                    
                    <h3>üìä Tests This Week</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Topic</th>
                                <th>Result</th>
                                <th>Grade/Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${weeklyTests.length > 0 ? weeklyTests.map(test => `
                                <tr>
                                    <td>${test.date}</td>
                                    <td>${test.subject}</td>
                                    <td>${test.topic}</td>
                                    <td>${test.result}</td>
                                    <td>${test.gradeOrStatus}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" style="text-align:center;">No tests recorded this week</td></tr>'}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <h3>üìà Weekly Summary</h3>
                        <p><strong>Total Tests:</strong> ${weeklyTests.length}</p>
                        <p><strong>Average Performance:</strong> ${calculateAveragePerformance(weeklyTests)}%</p>
                        <p><strong>Teacher's Comments:</strong> _______________________________</p>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Teacher's Signature: _______________</strong></p>
                        <p>USTAAD DOST - Pakistani Teacher Assistant App</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin: 20px 0;">
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
                        <button class="print-btn" onclick="window.close()" style="background: #6c757d; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // PRINT MONTHLY PROGRESS REPORT
        function printMonthlyReport(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            
            const monthlyTests = getStudentTestsInPeriod(currentClass, studentId, monthAgo, new Date());
            const subjectWisePerformance = calculateSubjectWisePerformance(monthlyTests);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Monthly Report - ${student.name}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 40px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #ffc107;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 { color: #ffc107; margin: 10px 0; }
                        .info-box {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 15px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: left;
                        }
                        th {
                            background: #ffc107;
                            color: #333;
                        }
                        .summary {
                            background: #fffef0;
                            border: 2px solid #ffc107;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .subject-performance {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .subject-card {
                            background: white;
                            border: 1px solid #ddd;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .footer {
                            margin-top: 40px;
                            border-top: 2px solid #ddd;
                            padding-top: 20px;
                            text-align: center;
                            color: #666;
                        }
                        .print-btn {
                            background: #ffc107;
                            color: #333;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üéì USTAAD DOST</h1>
                        <h2>Monthly Progress Report</h2>
                        <p>Period: ${monthAgo.toLocaleDateString()} to ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Student:</strong> ${student.name}</p>
                        <p><strong>Class:</strong> ${currentClass.name}</p>
                        <p><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${student.contact || 'N/A'}</p>
                    </div>
                    
                    <div class="summary">
                        <h3>üìà Monthly Summary</h3>
                        <p><strong>Total Tests:</strong> ${monthlyTests.length}</p>
                        <p><strong>Overall Average:</strong> ${calculateAveragePerformance(monthlyTests)}%</p>
                    </div>
                    
                    <h3>üìö Subject-wise Performance</h3>
                    <div class="subject-performance">
                        ${subjectWisePerformance.map(subj => `
                            <div class="subject-card">
                                <h4>${subj.subject}</h4>
                                <p><strong>${subj.average}%</strong></p>
                                <p>${subj.count} test(s)</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>üìä All Tests This Month</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Topic</th>
                                <th>Result</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlyTests.length > 0 ? monthlyTests.map(test => `
                                <tr>
                                    <td>${test.date}</td>
                                    <td>${test.subject}</td>
                                    <td>${test.topic}</td>
                                    <td>${test.result}</td>
                                    <td>${test.gradeOrStatus}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" style="text-align:center;">No tests recorded this month</td></tr>'}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Teacher's Signature: _______________</strong></p>
                        <p><strong>Parent's Signature: _______________</strong></p>
                        <p>USTAAD DOST - Pakistani Teacher Assistant App</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin: 20px 0;">
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
                        <button class="print-btn" onclick="window.close()" style="background: #6c757d; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // PRINT YEARLY PROGRESS REPORT
        function printYearlyReport(classId, studentId) {
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const currentClass = classes.find(c => c.id === classId);
            const student = currentClass.students.find(s => s.id === studentId);
            
            const yearAgo = new Date();
            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
            
            const yearlyTests = getStudentTestsInPeriod(currentClass, studentId, yearAgo, new Date());
            const subjectWisePerformance = calculateSubjectWisePerformance(yearlyTests);
            const quarterlyBreakdown = calculateQuarterlyPerformance(yearlyTests);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Yearly Report - ${student.name}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            @page { size: A4; margin: 15mm; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 40px;
                            max-width: 900px;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #dc3545;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 { color: #dc3545; margin: 10px 0; }
                        .info-box {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 15px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            text-align: left;
                        }
                        th {
                            background: #dc3545;
                            color: white;
                        }
                        .summary {
                            background: #fff5f5;
                            border: 2px solid #dc3545;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .subject-performance {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .subject-card {
                            background: white;
                            border: 1px solid #ddd;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .quarterly-section {
                            margin: 30px 0;
                        }
                        .footer {
                            margin-top: 40px;
                            border-top: 2px solid #ddd;
                            padding-top: 20px;
                            text-align: center;
                            color: #666;
                        }
                        .print-btn {
                            background: #dc3545;
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 5px;
                            font-size: 16px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üéì USTAAD DOST</h1>
                        <h2>Yearly Progress Report</h2>
                        <p>Academic Year: ${yearAgo.getFullYear()} - ${new Date().getFullYear()}</p>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Student:</strong> ${student.name}</p>
                        <p><strong>Class:</strong> ${currentClass.name}</p>
                        <p><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</p>
                        <p><strong>Mother's Name:</strong> ${student.motherName || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${student.contact || 'N/A'}</p>
                    </div>
                    
                    <div class="summary">
                        <h3>üìà Annual Summary</h3>
                        <p><strong>Total Tests Completed:</strong> ${yearlyTests.length}</p>
                        <p><strong>Overall Average:</strong> ${calculateAveragePerformance(yearlyTests)}%</p>
                        <p><strong>Highest Score:</strong> ${getStudentHighestScore(yearlyTests)}%</p>
                        <p><strong>Lowest Score:</strong> ${getStudentLowestScore(yearlyTests)}%</p>
                    </div>
                    
                    <h3>üìö Subject-wise Annual Performance</h3>
                    <div class="subject-performance">
                        ${subjectWisePerformance.map(subj => `
                            <div class="subject-card">
                                <h4>${subj.subject}</h4>
                                <p><strong>${subj.average}%</strong></p>
                                <p>${subj.count} test(s)</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="quarterly-section">
                        <h3>üìÖ Quarterly Performance Trend</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Quarter</th>
                                    <th>Tests</th>
                                    <th>Average</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${quarterlyBreakdown.map(q => `
                                    <tr>
                                        <td>${q.quarter}</td>
                                        <td>${q.count}</td>
                                        <td>${q.average}%</td>
                                        <td>${q.trend}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="summary">
                        <h3>üìù Teacher's Annual Assessment</h3>
                        <p><strong>Strengths:</strong> _______________________________</p>
                        <p><strong>Areas for Improvement:</strong> _______________________________</p>
                        <p><strong>Overall Remarks:</strong> _______________________________</p>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Class Teacher's Signature: _______________</strong></p>
                        <p><strong>Head Teacher's Signature: _______________</strong></p>
                        <p><strong>Parent's Signature: _______________</strong></p>
                        <p>USTAAD DOST - Pakistani Teacher Assistant App</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin: 20px 0;">
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
                        <button class="print-btn" onclick="window.close()" style="background: #6c757d; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // HELPER FUNCTIONS FOR REPORTS
        function getStudentTestsInPeriod(currentClass, studentId, startDate, endDate) {
            const tests = [];
            
            if (!currentClass.scoresheets) return tests;
            
            currentClass.scoresheets.forEach(test => {
                const testDate = new Date(test.date);
                if (testDate >= startDate && testDate <= endDate) {
                    let studentResult = null;
                    
                    if (test.assessmentType === 'marks') {
                        studentResult = test.scores.find(s => s.studentId === studentId);
                        if (studentResult) {
                            tests.push({
                                date: test.date,
                                subject: test.subject,
                                topic: test.topic,
                                result: `${studentResult.obtainedMarks}/${test.totalMarks}`,
                                gradeOrStatus: studentResult.grade,
                                percentage: studentResult.percentage
                            });
                        }
                    } else {
                        studentResult = test.exerciseResults.find(r => r.studentId === studentId);
                        if (studentResult) {
                            tests.push({
                                date: test.date,
                                subject: test.subject,
                                topic: test.topic,
                                result: studentResult.total,
                                gradeOrStatus: studentResult.completionRate,
                                percentage: parseInt(studentResult.completionRate) || 0
                            });
                        }
                    }
                }
            });
            
            return tests;
        }
        
        function calculateAveragePerformance(tests) {
            if (tests.length === 0) return 0;
            const total = tests.reduce((sum, test) => sum + (test.percentage || 0), 0);
            return Math.round(total / tests.length);
        }
        
        function calculateSubjectWisePerformance(tests) {
            const subjects = {};
            
            tests.forEach(test => {
                if (!subjects[test.subject]) {
                    subjects[test.subject] = { total: 0, count: 0 };
                }
                subjects[test.subject].total += test.percentage || 0;
                subjects[test.subject].count++;
            });
            
            return Object.keys(subjects).map(subject => ({
                subject: subject,
                average: Math.round(subjects[subject].total / subjects[subject].count),
                count: subjects[subject].count
            }));
        }
        
        function calculateQuarterlyPerformance(tests) {
            const quarters = [
                { name: 'Q1 (Jan-Mar)', months: [0,1,2], tests: [] },
                { name: 'Q2 (Apr-Jun)', months: [3,4,5], tests: [] },
                { name: 'Q3 (Jul-Sep)', months: [6,7,8], tests: [] },
                { name: 'Q4 (Oct-Dec)', months: [9,10,11], tests: [] }
            ];
            
            tests.forEach(test => {
                const testDate = new Date(test.date);
                const month = testDate.getMonth();
                const quarter = quarters.find(q => q.months.includes(month));
                if (quarter) quarter.tests.push(test);
            });
            
            return quarters.map((q, i) => {
                const avg = calculateAveragePerformance(q.tests);
                const prevQuarter = i > 0 ? quarters[i-1] : null;
                const prevAvg = prevQuarter ? calculateAveragePerformance(prevQuarter.tests) : avg;
                const trend = avg > prevAvg ? '‚Üë Improving' : avg < prevAvg ? '‚Üì Needs Attention' : '‚Üí Stable';
                
                return {
                    quarter: q.name,
                    count: q.tests.length,
                    average: avg,
                    trend: trend
                };
            });
        }
        
        function getStudentHighestScore(tests) {
            if (tests.length === 0) return 0;
            return Math.max(...tests.map(t => t.percentage || 0));
        }
        
        function getStudentLowestScore(tests) {
            if (tests.length === 0) return 0;
            return Math.min(...tests.map(t => t.percentage || 0));
        }
        
        // Picture upload functionality for student lists
        function manualEntry() {
            document.getElementById('pictureUpload').style.display = 'none';
            document.getElementById('bulkImportSection').style.display = 'none';
            document.getElementById('manualStudentForm').style.display = 'block';
        }
        
        function uploadPicture() {
            document.getElementById('manualStudentForm').style.display = 'none';
            document.getElementById('bulkImportSection').style.display = 'none';
            document.getElementById('pictureUpload').style.display = 'block';
        }
        
        function bulkImport() {
            document.getElementById('manualStudentForm').style.display = 'none';
            document.getElementById('pictureUpload').style.display = 'none';
            document.getElementById('bulkImportSection').style.display = 'block';
            
            // Load classes into dropdown
            const classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const select = document.getElementById('bulkImportClassSelect');
            select.innerHTML = '<option value="">-- Select Class --</option>';
            
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                select.appendChild(option);
            });
        }
        
        function cancelBulkImport() {
            document.getElementById('bulkImportSection').style.display = 'none';
            document.getElementById('bulkNamesList').value = '';
        }
        
        function processBulkImport() {
            const selectedClassId = parseInt(document.getElementById('bulkImportClassSelect').value);
            
            if (!selectedClassId) {
                alert('‚ö†Ô∏è Pehle class select karein!');
                return;
            }
            
            const namesList = document.getElementById('bulkNamesList').value;
            if (!namesList.trim()) {
                alert('‚ö†Ô∏è Please enter at least one student name.');
                return;
            }
            
            // Split by newlines and filter empty lines
            const names = namesList.split('\n').map(n => n.trim()).filter(n => n.length > 0);
            
            if (names.length === 0) {
                alert('‚ö†Ô∏è No valid names found.');
                return;
            }
            
            // Get current class
            let classes = JSON.parse(localStorage.getItem('teacherClasses') || '[]');
            const classIndex = classes.findIndex(c => c.id === selectedClassId);
            
            if (classIndex === -1) {
                alert('‚ö†Ô∏è Class not found!');
                return;
            }
            
            // Add each student
            let addedCount = 0;
            names.forEach((name, index) => {
                const newStudent = {
                    id: Date.now() + index,
                    name: name,
                    rollNumber: '', // Can be filled later
                    guardian: '',
                    cnic: '',
                    phone: ''
                };
                
                classes[classIndex].students.push(newStudent);
                addedCount++;
            });
            
            // Save back to localStorage
            localStorage.setItem('teacherClasses', JSON.stringify(classes));
            
            alert(`‚úÖ Successfully added ${addedCount} students to ${classes[classIndex].name}!`);
            
            // Clear and close
            document.getElementById('bulkNamesList').value = '';
            document.getElementById('bulkImportClassSelect').value = '';
            document.getElementById('bulkImportSection').style.display = 'none';
            
            // Refresh class list
            loadExistingClasses();
        }
        
        function extractNamesFromImage() {
            const fileInput = document.getElementById('studentListImage');
            const file = fileInput.files[0];
            
            if (file) {
                // Show loading state
                document.getElementById('extractBtn').textContent = 'üîÑ Processing...';
                document.getElementById('extractBtn').disabled = true;
                
                // Use backend API to extract text from image
                processStudentListImage(file);
            } else {
                alert('Please select an image file first.');
            }
        }
        
        async function processStudentListImage(imageFile) {
            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', imageFile);
                
                // Call backend API for name extraction
                const response = await fetch('/grading/extract-names', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.names) {
                    displayExtractedNames(data.names);
                    
                    // Show success message
                    const container = document.getElementById('extractedNames');
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px;';
                    successMsg.textContent = data.message;
                    container.insertBefore(successMsg, container.firstChild);
                } else {
                    throw new Error(data.error || 'Failed to extract names');
                }
                
            } catch (error) {
                console.error('Name extraction error:', error);
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0;';
                errorMsg.innerHTML = `
                    <strong>‚ö†Ô∏è Extraction Failed:</strong> ${error.message}<br>
                    <small>Note: This feature uses AI vision to extract names. Make sure the image contains clear, readable text with student names.</small>
                `;
                document.getElementById('extractedNames').appendChild(errorMsg);
                
                // No fallback - only use real OCR results
            } finally {
                // Reset button
                document.getElementById('extractBtn').textContent = 'üîç Extract Names';
                document.getElementById('extractBtn').disabled = false;
            }
        }
        
        function displayExtractedNames(names) {
            const container = document.getElementById('extractedNames');
            container.innerHTML = `
                <h4>‚úÖ Extracted Student Names:</h4>
                <p class="instruction-text">Review and edit the names below, then save to your class:</p>
                <div class="student-list">
                    ${names.map((name, index) => `
                        <div class="student-name-row">
                            <input type="text" value="${name}" class="student-name-input" data-index="${index}">
                            <button class="btn-remove" onclick="removeStudentName(${index})" title="Remove">‚ùå</button>
                        </div>
                    `).join('')}
                </div>
                <div class="extracted-actions">
                    <button class="btn btn-success" onclick="saveStudentList()">üíæ Save to Class</button>
                    <button class="btn btn-secondary" onclick="addMoreNames()">‚ûï Add More</button>
                    <button class="btn btn-warning" onclick="clearExtracted()">üóëÔ∏è Clear All</button>
                </div>
            `;
            container.style.display = 'block';
        }
        
        function removeStudentName(index) {
            const row = document.querySelector(`[data-index="${index}"]`).closest('.student-name-row');
            row.remove();
        }
        
        function addMoreNames() {
            const studentList = document.querySelector('.student-list');
            const newIndex = Date.now(); // Use timestamp as unique index
            const newRow = document.createElement('div');
            newRow.className = 'student-name-row';
            newRow.innerHTML = `
                <input type="text" value="" class="student-name-input" data-index="${newIndex}" placeholder="Enter student name">
                <button class="btn-remove" onclick="removeStudentName(${newIndex})" title="Remove">‚ùå</button>
            `;
            studentList.appendChild(newRow);
        }
        
        function saveStudentList() {
            const inputs = document.querySelectorAll('.student-name-input');
            const names = Array.from(inputs).map(input => input.value.trim()).filter(name => name.length > 0);
            
            if (names.length === 0) {
                alert('Please add at least one student name.');
                return;
            }
            
            // Simulate saving to database
            alert(`Successfully saved ${names.length} students to class:\n\n${names.join('\n')}\n\nThis feature will be integrated with the database soon!`);
            
            // Clear the extracted names
            clearExtracted();
        }
        
        function clearExtracted() {
            document.getElementById('extractedNames').innerHTML = '';
            document.getElementById('extractedNames').style.display = 'none';
            document.getElementById('studentListImage').value = '';
            document.getElementById('extractBtn').style.display = 'none';
        }
        
        // Handle file selection and page initialization
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('studentListImage');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const fileName = e.target.files[0].name;
                        document.querySelector('.upload-dropzone p').textContent = `üìé Selected: ${fileName}`;
                        document.getElementById('extractBtn').style.display = 'block';
                    }
                });
            }
            
            // Initialize classes display
            loadExistingClasses();
        });
    </script>
</body>
</html>// Cache buster: 1759205854
