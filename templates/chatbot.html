{% extends "base.html" %}

{% block title %}U-DOST - Pakistani Teacher Assistant{% endblock %}

{% block content %}
<div class="chatbot-page">
    <h1>üåü U-DOST - Pakistani Teacher Assistant üáµüá∞‚ú®</h1>
    
    <div class="chat-container">
        <div class="chat-header" id="chatHeader">
            <div class="chat-breadcrumb" id="chatBreadcrumb" style="display: none;">
                <span class="breadcrumb-text"></span>
                <button class="btn-back" onclick="sendMessage('menu')">‚Üê Back to Menu</button>
            </div>
            <div class="chat-navigation" id="chatNavigation" style="display: none;">
                <span class="navigation-text"></span>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>üåü <strong>ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ! Hello!</strong> üåü</p>
                    <p>I'm <strong>U-DOST</strong> ü§ñ‚ú® - Your friendly Pakistani teacher assistant! I'm here to help you create engaging lesson plans, teaching strategies, activities, and assessments for Pakistani primary education (grades 1-5).</p>
                    <p>Type <strong>"hi"</strong> or <strong>"hello"</strong> to see all the ways I can support your teaching! üìöüáµüá∞</p>
                </div>
            </div>
        </div>
        
        <div class="chat-suggestions" id="chatSuggestions" style="display: none;">
            <div class="suggestions-label">Suggestions:</div>
            <div class="suggestions-list" id="suggestionsList"></div>
        </div>
        
        <div class="chat-input-container">
            <!-- File Upload Area -->
            <div class="file-upload-area" id="fileUploadArea" style="display: none;">
                <div class="uploaded-files" id="uploadedFiles"></div>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìé</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-info">Images, PDFs, and text files up to 12MB</div>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.docx" style="display: none;">
                </div>
            </div>
            
            <!-- Voice Recording Area -->
            <div class="voice-recording-area" id="voiceArea" style="display: none;">
                <div class="voice-controls">
                    <button id="recordButton" class="btn btn-record">üé§ Record</button>
                    <button id="stopButton" class="btn btn-stop" style="display: none;">‚èπÔ∏è Stop</button>
                    <button id="playButton" class="btn btn-play" style="display: none;">‚ñ∂Ô∏è Play</button>
                    <button id="sendVoiceButton" class="btn btn-send-voice" style="display: none;">üì§ Send Voice Message</button>
                    <button id="clearRecordingButton" class="btn btn-clear" style="display: none;">üóëÔ∏è Clear</button>
                </div>
                
                <!-- Speech Recognition Controls -->
                <div class="speech-recognition-controls" style="margin-top: 15px;">
                    <button id="speechRecognitionButton" class="btn btn-speech" title="Speech to Text">üéôÔ∏è Speech to Text</button>
                    <select id="languageSelect" class="language-selector">
                        <option value="en-US">English (US)</option>
                        <option value="ur-PK">Urdu (Pakistan)</option>
                        <option value="en-GB">English (UK)</option>
                    </select>
                    <button id="toggleTTSButton" class="btn btn-tts" title="Enable/Disable Text-to-Speech">üîä TTS</button>
                </div>
                <div class="speech-status" id="speechStatus"></div>
                <div class="recording-status" id="recordingStatus"></div>
                <audio id="audioPlayback" controls style="display: none;"></audio>
            </div>
            
            <!-- Camera Capture Area -->
            <div class="camera-capture-area" id="cameraArea" style="display: none;">
                <div class="camera-preview">
                    <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
                    <canvas id="photoCanvas" style="display: none;"></canvas>
                    <div class="captured-photo" id="capturedPhoto" style="display: none;">
                        <img id="capturedImage" alt="Captured photo">
                    </div>
                </div>
                <div class="camera-controls">
                    <button id="startCameraButton" class="btn btn-camera">üì∑ Start Camera</button>
                    <button id="captureButton" class="btn btn-capture" style="display: none;">üì∏ Capture</button>
                    <button id="retakeButton" class="btn btn-retake" style="display: none;">üîÑ Retake</button>
                    <button id="useCapturedButton" class="btn btn-use" style="display: none;">‚úÖ Use Photo</button>
                    <button id="stopCameraButton" class="btn btn-stop-camera" style="display: none;">‚ùå Close Camera</button>
                </div>
                <div class="camera-status" id="cameraStatus"></div>
            </div>
            
            <!-- Main Input Area -->
            <div class="main-input-area">
                <div class="input-controls">
                    <button id="toggleFileButton" class="btn btn-attach" title="Attach Files">üìé</button>
                    <button id="toggleCameraButton" class="btn btn-camera" title="Take Photo">üì∑</button>
                    <button id="toggleVoiceButton" class="btn btn-voice" title="Voice Message">üé§</button>
                </div>
                <input type="text" id="chatInput" placeholder="Type your message here..." autocomplete="off">
                <button id="sendButton" class="btn btn-primary">Send</button>
            </div>
        </div>
        
        <div class="quick-actions" id="quickActions">
            <button class="quick-btn" onclick="sendMessage('menu')">Main Menu</button>
            <button class="quick-btn" onclick="sendMessage('help')">Help</button>
        </div>
    </div>
    
</div>

<script>
// Wait for the page to load completely
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');

    function addMessage(content, isUser = false) {
        if (!chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'user-message' : 'bot-message';
        
        if (typeof content === 'string') {
            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'üòä' : 'ü§ñ'}</div>
                <div class="message-content">
                    <div class="message-text"></div>
                    ${!isUser ? '<button class="speak-button" onclick="speakText(this.previousElementSibling.textContent)" title="Read aloud">üîä</button>' : ''}
                </div>
            `;
            // Render with markdown-like formatting
            const textDiv = messageDiv.querySelector('.message-text');
            textDiv.innerHTML = formatMarkdownLike(content);
            
            // Auto-speak bot responses if TTS is enabled
            if (!isUser && isTTSEnabled) {
                setTimeout(() => speakText(content), 500);
            }
        } else if (content.is_markdown) {
            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text"></div>
                    <button class="speak-button" onclick="speakText(this.previousElementSibling.textContent)" title="Read aloud">üîä</button>
                </div>
            `;
            // Render markdown content
            const textDiv = messageDiv.querySelector('.message-text');
            textDiv.innerHTML = formatMarkdownLike(content.message);
            
            // Auto-speak bot responses if TTS is enabled
            if (isTTSEnabled) {
                setTimeout(() => speakText(content.message), 500);
            }
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${formatBotResponse(content)}
                    <button class="speak-button" onclick="speakText(this.querySelector('.message-content').textContent)" title="Read aloud">üîä</button>
                </div>
            `;
            
            // Auto-speak bot responses if TTS is enabled
            if (isTTSEnabled && content.message) {
                setTimeout(() => speakText(content.message), 500);
            }
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatBotResponse(response) {
        // Validate response object
        if (!response || typeof response !== 'object') {
            return '<p>Error: Invalid response format</p>';
        }
        
        let html = '';
        
        // Add title if present and valid - use formatMarkdownLike for safe HTML
        if (response.title && typeof response.title === 'string') {
            const cleanTitle = response.title.trim();
            if (cleanTitle) {
                html += `<h4 class="response-title">${formatMarkdownLike(cleanTitle)}</h4>`;
            }
        }
        
        // Add main message with validation - use formatMarkdownLike for safe HTML
        const message = response.message || 'No response';
        if (typeof message === 'string') {
            const cleanMessage = message.trim();
            if (cleanMessage) {
                html += `<div class="message-content">${formatMarkdownLike(cleanMessage)}</div>`;
            }
        }
        
        // Generate unique ID for options container to prevent conflicts
        let optionsContainerId = null;
        if (response.options && Array.isArray(response.options) && response.options.length > 0) {
            optionsContainerId = 'options-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            html += `<div class="response-options" id="${optionsContainerId}"></div>`;
        }
        
        // Handle navigation and breadcrumbs
        updateNavigation(response);
        
        // Handle suggestions
        updateSuggestions(response.suggestions);
        
        // Add return to menu button if specified
        if (response.return_to_menu) {
            html += '<div class="response-actions">';
            html += '<button class="action-btn" onclick="sendMessage(\'menu\')">Return to Main Menu</button>';
            html += '</div>';
        }
        
        // After HTML is set, safely create option buttons with the specific container
        if (optionsContainerId) {
            setTimeout(() => createSafeOptionButtons(response.options, optionsContainerId), 0);
        }
        
        return html;
    }
    
    function createSafeOptionButtons(options, containerId) {
        const container = document.getElementById(containerId);
        if (!container || !options || !Array.isArray(options)) return;
        
        container.innerHTML = ''; // Clear existing buttons
        
        options.forEach(option => {
            if (option && typeof option === 'string') {
                const cleanOption = option.trim();
                if (cleanOption) {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = cleanOption; // Safe text content
                    button.onclick = () => sendMessage(cleanOption);
                    container.appendChild(button);
                }
            }
        });
    }
    
    function updateNavigation(response) {
        const breadcrumb = document.getElementById('chatBreadcrumb');
        const navigation = document.getElementById('chatNavigation');
        
        if (response.breadcrumb) {
            breadcrumb.querySelector('.breadcrumb-text').textContent = response.breadcrumb;
            breadcrumb.style.display = 'flex';
        } else {
            breadcrumb.style.display = 'none';
        }
        
        if (response.navigation) {
            navigation.querySelector('.navigation-text').textContent = response.navigation;
            navigation.style.display = 'block';
        } else {
            navigation.style.display = 'none';
        }
    }
    
    function updateSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('chatSuggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        
        // Validate suggestions is an array before processing
        if (suggestions && Array.isArray(suggestions) && suggestions.length > 0) {
            suggestionsList.innerHTML = '';
            suggestions.forEach(suggestion => {
                if (suggestion && typeof suggestion === 'string') {
                    const cleanSuggestion = suggestion.trim();
                    if (cleanSuggestion) {
                        const suggestionBtn = document.createElement('button');
                        suggestionBtn.className = 'suggestion-btn';
                        suggestionBtn.textContent = cleanSuggestion; // Safe text content
                        suggestionBtn.onclick = () => sendMessage(cleanSuggestion);
                        suggestionsList.appendChild(suggestionBtn);
                    }
                }
            });
            suggestionsContainer.style.display = 'block';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    // Simple markdown-like formatting function
    function formatMarkdownLike(text) {
        if (!text || typeof text !== 'string') return '';
        
        // Clean and normalize text first to prevent corruption
        text = text.trim();
        
        // Escape HTML first for security
        text = text.replace(/&/g, '&amp;')
                   .replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;')
                   .replace(/"/g, '&quot;')
                   .replace(/'/g, '&#39;');
        
        // Convert markdown-like formatting
        text = text
            // Bold: **text** or __text__
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/__(.*?)__/g, '<strong>$1</strong>')
            
            // Italic: *text* or _text_
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/_(.*?)_/g, '<em>$1</em>')
            
            // Code blocks: ```code```
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
            
            // Inline code: `code`
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            
            // Line breaks
            .replace(/\n/g, '<br>')
            
            // Lists (simple detection)
            .replace(/^[\s]*[-*+]\s+(.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            
            // Headers: # ## ### 
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>');
        
        return text;
    }
    
    // Inline input functions removed - using main chatbox instead

    // Voice recording variables
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let currentAudioId = null;
    let uploadedFiles = [];
    
    // Camera variables
    let cameraStream = null;
    let capturedPhotoBlob = null;
    
    // Make sendMessage globally available with multimodal support

    window.sendMessage = async function(message = null, inputType = 'text') {
        const messageText = message || (chatInput ? chatInput.value.trim() : '');
        if (!messageText && !currentAudioId && uploadedFiles.length === 0) return;
        
        // Detect language for better processing
        const detectedLanguage = messageText ? detectLanguage(messageText) : 'english';
        
        // Track enhanced chat interaction with PostHog
        if (typeof posthog !== 'undefined') {
            posthog.capture('chat_message_sent', {
                message_length: messageText.length,
                has_files: uploadedFiles.length > 0,
                has_audio: !!currentAudioId,
                input_type: inputType,
                detected_language: detectedLanguage,
                message_type: messageText.startsWith('üî¢') ? 'assessment' : 
                             messageText.startsWith('üí¨') ? 'free_chat' :
                             messageText.startsWith('üìö') ? 'subject_selection' : 'general'
            });
        }
        
        // Enhanced display message with input type indicators
        let displayMessage = messageText;
        
        // Add input type indicators for better UX
        if (inputType === 'voice') {
            displayMessage = `üé§ ${messageText}`;
        } else if (inputType === 'image' && uploadedFiles.length > 0) {
            displayMessage = `üì∑ ${messageText || 'Image uploaded for analysis'}`;
        } else if (inputType === 'file' && uploadedFiles.length > 0) {
            displayMessage = `üìé ${messageText || 'Document uploaded for analysis'}`;
        }
        
        if (currentAudioId && inputType !== 'voice') displayMessage += " üé§ + Voice";
        if (uploadedFiles.length > 0 && !inputType.includes('file')) {
            displayMessage += ` üìé ${uploadedFiles.length} file(s)`;
        }
        
        // Show language detection feedback
        if (detectedLanguage === 'urdu') {
            displayMessage += ' (Urdu detected)';
        }
        
        addMessage(displayMessage, true);
        if (!message && chatInput) chatInput.value = '';
        
        // Enhanced request payload with multi-modal support
        const requestPayload = { 
            message: messageText,
            input_type: inputType,
            file_ids: uploadedFiles.map(f => f.file_id),
            audio_id: currentAudioId,
            language_detected: detectedLanguage,
            has_files: uploadedFiles.length > 0,
            has_audio: !!currentAudioId,
            file_types: uploadedFiles.map(f => f.type),
            session_context: {
                grade: window.currentGrade || 1,
                subject: window.currentSubject || 'English',
                activity_type: window.currentActivityType || 'activities'
            }
        };
        
        let requestResponse = null;
        
        try {
            requestResponse = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestPayload)
            });
            
            if (!requestResponse.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await requestResponse.json();
            addMessage(data);
            
            // Provide contextual feedback based on input type
            if (inputType === 'voice' && detectedLanguage === 'urdu') {
                setTimeout(() => {
                    addMessage('üåü Urdu samajh aa gayi! Main aap ki madad kar sakti hun. (I understood your Urdu!)');
                }, 1000);
            } else if (inputType === 'image' && uploadedFiles.length > 0) {
                setTimeout(() => {
                    addMessage('üñºÔ∏è Image dekh kar main teaching suggestions de sakti hun! (I can provide teaching suggestions after seeing the image!)');
                }, 1000);
            }
            
            // Clear uploaded files and audio after sending
            clearUploads();
            
        } catch (error) {
            console.error('Chat error:', error);
            console.error('Failed request details:', {
                url: '/chat',
                payload: requestPayload,
                response_status: requestResponse ? requestResponse.status : 'No response'
            });
            addMessage('Sorry, I encountered an error. Please try again. If this continues, the AI services may need proper API keys.');
        }
    };
    
    function clearUploads() {
        uploadedFiles = [];
        currentAudioId = null;
        updateUploadDisplay();
        hideFileArea();
        hideVoiceArea();
        clearRecording();
    }
    
    // File upload functions
    function showFileArea() {
        document.getElementById('fileUploadArea').style.display = 'block';
    }
    
    function hideFileArea() {
        document.getElementById('fileUploadArea').style.display = 'none';
    }
    
    function showVoiceArea() {
        document.getElementById('voiceArea').style.display = 'block';
    }
    
    function hideVoiceArea() {
        document.getElementById('voiceArea').style.display = 'none';
    }
    
    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/upload_file', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            
            const result = await response.json();
            uploadedFiles.push(result);
            updateUploadDisplay();
            
        } catch (error) {
            console.error('File upload error:', error);
            alert('Failed to upload file: ' + file.name);
        }
    }
    
    function updateUploadDisplay() {
        const container = document.getElementById('uploadedFiles');
        container.innerHTML = '';
        
        uploadedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            
            // Create file info span safely
            const fileInfoSpan = document.createElement('span');
            fileInfoSpan.className = 'file-info';
            
            // Add file icon and name safely with textContent
            const fileIcon = file.type === 'image' ? 'üñºÔ∏è' : 'üìÑ';
            fileInfoSpan.textContent = `${fileIcon} ${file.original_name}`;
            
            // Add file size info
            const sizeSmall = document.createElement('small');
            sizeSmall.textContent = ` (${formatFileSize(file.size)})`;
            fileInfoSpan.appendChild(sizeSmall);
            
            // Create remove button safely
            const removeButton = document.createElement('button');
            removeButton.className = 'btn-remove';
            removeButton.textContent = '‚ùå';
            removeButton.onclick = () => removeFile(index);
            
            // Append both elements
            fileDiv.appendChild(fileInfoSpan);
            fileDiv.appendChild(removeButton);
            container.appendChild(fileDiv);
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    window.removeFile = function(index) {
        uploadedFiles.splice(index, 1);
        updateUploadDisplay();
        if (uploadedFiles.length === 0) {
            hideFileArea();
        }
    };
    
    // Speech Recognition Variables
    let speechRecognition = null;
    let isListening = false;
    let isTTSEnabled = true;
    let speechSynthesis = window.speechSynthesis;
    
    // Initialize Speech Recognition
    function initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            
            speechRecognition.continuous = false;
            speechRecognition.interimResults = true;
            speechRecognition.maxAlternatives = 1;
            
            // Default to English
            speechRecognition.lang = 'en-US';
            
            speechRecognition.onstart = function() {
                isListening = true;
                document.getElementById('speechStatus').textContent = 'üéôÔ∏è Listening... Speak now!';
                document.getElementById('speechRecognitionButton').style.background = '#ff4444';
                document.getElementById('speechRecognitionButton').textContent = '‚èπÔ∏è Stop Listening';
            };
            
            speechRecognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show interim results
                if (interimTranscript) {
                    document.getElementById('speechStatus').textContent = `üéôÔ∏è Hearing: "${interimTranscript}"`;
                }
                
                // When final result is available
                if (finalTranscript) {
                    const chatInput = document.getElementById('chatInput');
                    chatInput.value = finalTranscript.trim();
                    
                    // Auto-detect language and provide feedback
                    const detectedLang = detectLanguage(finalTranscript);
                    document.getElementById('speechStatus').textContent = `‚úÖ "${finalTranscript}" (${detectedLang === 'urdu' ? 'Urdu detected' : 'English detected'})`;
                    
                    // Auto-send after brief delay or let user review
                    setTimeout(() => {
                        document.getElementById('speechStatus').textContent = '‚úÖ Ready to send or continue speaking...';
                    }, 2000);
                }
            };
            
            speechRecognition.onerror = function(event) {
                let errorMessage = 'Speech recognition error: ';
                switch(event.error) {
                    case 'no-speech':
                        errorMessage += 'No speech detected. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage += 'No microphone found. Please check your microphone.';
                        break;
                    case 'not-allowed':
                        errorMessage += 'Microphone permission denied. Please allow microphone access.';
                        break;
                    case 'network':
                        errorMessage += 'Network error. Please check your internet connection.';
                        break;
                    default:
                        errorMessage += event.error;
                }
                document.getElementById('speechStatus').textContent = '‚ùå ' + errorMessage;
                resetSpeechButton();
            };
            
            speechRecognition.onend = function() {
                isListening = false;
                resetSpeechButton();
                if (document.getElementById('speechStatus').textContent.includes('Listening')) {
                    document.getElementById('speechStatus').textContent = 'üéôÔ∏è Speech recognition ended. Click to start again.';
                }
            };
        } else {
            document.getElementById('speechStatus').textContent = '‚ùå Speech recognition not supported in this browser.';
        }
    }
    
    // Language Detection Function
    function detectLanguage(text) {
        // Simple Urdu detection based on common patterns
        const urduPatterns = [
            /[\u0600-\u06FF]/, // Arabic/Urdu script
            /\b(mujhe|mein|ke|ki|ka|hai|hain|chahiye|kya|kaise|kahan|main|aap|ap|hum|un|ye|wo|se|tak|par|liye|sath|bhi|agar|lekin|phir|ab|yahan|wahan)\b/i
        ];
        
        for (let pattern of urduPatterns) {
            if (pattern.test(text)) {
                return 'urdu';
            }
        }
        return 'english';
    }
    
    // Text-to-Speech Functions
    function speakText(text, language = 'en-US') {
        if (!isTTSEnabled || !speechSynthesis) return;
        
        // Cancel any ongoing speech
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Configure voice based on detected/selected language
        if (language.includes('ur') || detectLanguage(text) === 'urdu') {
            // Try to find Urdu voice, fallback to English
            const voices = speechSynthesis.getVoices();
            const urduVoice = voices.find(voice => 
                voice.lang.includes('ur') || 
                voice.name.toLowerCase().includes('urdu') ||
                voice.lang.includes('hi') // Hindi as fallback for Urdu
            );
            if (urduVoice) {
                utterance.voice = urduVoice;
                utterance.lang = urduVoice.lang;
            } else {
                utterance.lang = 'en-US'; // Fallback to English
            }
        } else {
            utterance.lang = language;
            const voices = speechSynthesis.getVoices();
            const englishVoice = voices.find(voice => voice.lang.includes('en'));
            if (englishVoice) {
                utterance.voice = englishVoice;
            }
        }
        
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 0.8;
        
        speechSynthesis.speak(utterance);
    }
    
    // Speech Recognition Control Functions
    function toggleSpeechRecognition() {
        if (!speechRecognition) {
            initializeSpeechRecognition();
            return;
        }
        
        if (isListening) {
            speechRecognition.stop();
        } else {
            // Update language from selector
            const selectedLang = document.getElementById('languageSelect').value;
            speechRecognition.lang = selectedLang;
            
            document.getElementById('speechStatus').textContent = `üéôÔ∏è Starting ${selectedLang.includes('ur') ? 'Urdu' : 'English'} speech recognition...`;
            speechRecognition.start();
        }
    }
    
    function resetSpeechButton() {
        isListening = false;
        document.getElementById('speechRecognitionButton').style.background = '';
        document.getElementById('speechRecognitionButton').textContent = 'üéôÔ∏è Speech to Text';
    }
    
    function toggleTTS() {
        isTTSEnabled = !isTTSEnabled;
        const button = document.getElementById('toggleTTSButton');
        if (isTTSEnabled) {
            button.textContent = 'üîä TTS ON';
            button.style.background = '#4CAF50';
        } else {
            button.textContent = 'üîá TTS OFF';
            button.style.background = '#f44336';
            speechSynthesis.cancel(); // Stop any ongoing speech
        }
    }

    // Voice recording functions
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await uploadAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            
            document.getElementById('recordButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'inline-block';
            document.getElementById('recordingStatus').textContent = 'üî¥ Recording...';
            
        } catch (error) {
            console.error('Recording error:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            document.getElementById('recordButton').style.display = 'inline-block';
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('recordingStatus').textContent = '‚è≥ Processing...';
        }
    }
    
    async function uploadAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        try {
            const response = await fetch('/upload_audio', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Audio upload failed');
            }
            
            const result = await response.json();
            currentAudioId = result.audio_id;
            
            // Show playback controls
            const audioUrl = `/media/${result.audio_id}`;
            const audioElement = document.getElementById('audioPlayback');
            audioElement.src = audioUrl;
            audioElement.style.display = 'block';
            
            document.getElementById('playButton').style.display = 'inline-block';
            document.getElementById('sendVoiceButton').style.display = 'inline-block';
            document.getElementById('clearRecordingButton').style.display = 'inline-block';
            document.getElementById('recordingStatus').textContent = `‚úÖ ${result.transcription ? '"' + result.transcription + '"' : 'Voice message ready to send'}`;
            
        } catch (error) {
            console.error('Audio upload error:', error);
            document.getElementById('recordingStatus').textContent = '‚ùå Upload failed';
        }
    }
    
    function clearRecording() {
        currentAudioId = null;
        audioBlob = null;
        document.getElementById('audioPlayback').style.display = 'none';
        document.getElementById('playButton').style.display = 'none';
        document.getElementById('sendVoiceButton').style.display = 'none';
        document.getElementById('clearRecordingButton').style.display = 'none';
        document.getElementById('recordingStatus').textContent = '';
        document.getElementById('recordButton').style.display = 'inline-block';
    }
    
    function sendVoiceMessage() {
        if (currentAudioId) {
            // Send the voice message using the existing sendMessage function
            window.sendMessage();
            // Close the voice area after sending
            hideVoiceArea();
        }
    }

    // Camera functions
    function showCameraArea() {
        document.getElementById('cameraArea').style.display = 'block';
        hideFileArea();
        hideVoiceArea();
    }
    
    function hideFileArea() {
        document.getElementById('fileUploadArea').style.display = 'none';
    }
    
    function hideVoiceArea() {
        document.getElementById('voiceArea').style.display = 'none';
    }
    
    function hideCameraArea() {
        document.getElementById('cameraArea').style.display = 'none';
        stopCamera();
    }
    
    async function startCamera() {
        // Check if camera is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('cameraStatus').textContent = 'Camera not available. Please use HTTPS or a supported browser.';
            return;
        }
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment', // Try back camera first
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            
            const video = document.getElementById('cameraPreview');
            video.srcObject = cameraStream;
            video.style.display = 'block';
            
            // Update buttons
            document.getElementById('startCameraButton').style.display = 'none';
            document.getElementById('captureButton').style.display = 'inline-block';
            document.getElementById('stopCameraButton').style.display = 'inline-block';
            
            document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
            
        } catch (error) {
            console.error('Camera access error:', error);
            // Try front camera if back camera fails
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', // Front camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                video.style.display = 'block';
                
                // Update buttons
                document.getElementById('startCameraButton').style.display = 'none';
                document.getElementById('captureButton').style.display = 'inline-block';
                document.getElementById('stopCameraButton').style.display = 'inline-block';
                
                document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
                
            } catch (secondError) {
                console.error('Camera access failed:', secondError);
                document.getElementById('cameraStatus').textContent = 'Camera access denied or not available';
            }
        }
    }
    
    function capturePhoto() {
        const video = document.getElementById('cameraPreview');
        const canvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const capturedImage = document.getElementById('capturedImage');
        
        // Check if video is ready
        if (video.videoWidth === 0 || video.videoHeight === 0) {
            document.getElementById('cameraStatus').textContent = 'Camera not ready yet. Please wait...';
            return;
        }
        
        // Set canvas size to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw video frame to canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob
        canvas.toBlob(function(blob) {
            capturedPhotoBlob = blob;
            
            // Show captured image
            const imageUrl = URL.createObjectURL(blob);
            capturedImage.src = imageUrl;
            capturedPhoto.style.display = 'block';
            video.style.display = 'none';
            
            // Update buttons
            document.getElementById('captureButton').style.display = 'none';
            document.getElementById('retakeButton').style.display = 'inline-block';
            document.getElementById('useCapturedButton').style.display = 'inline-block';
            
            document.getElementById('cameraStatus').textContent = 'Photo captured! Use it or retake.';
        }, 'image/jpeg', 0.8);
    }
    
    function retakePhoto() {
        // Clear captured photo
        capturedPhotoBlob = null;
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('cameraPreview').style.display = 'block';
        
        // Update buttons
        document.getElementById('retakeButton').style.display = 'none';
        document.getElementById('useCapturedButton').style.display = 'none';
        document.getElementById('captureButton').style.display = 'inline-block';
        
        document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
    }
    
    async function useCapturedPhoto() {
        if (!capturedPhotoBlob) return;
        
        try {
            // Create a file from the blob
            const file = new File([capturedPhotoBlob], `camera_capture_${Date.now()}.jpg`, {
                type: 'image/jpeg'
            });
            
            // Upload the captured photo
            await uploadFile(file);
            
            // Close camera and reset
            stopCamera();
            hideCameraArea();
            
        } catch (error) {
            console.error('Failed to upload captured photo:', error);
            document.getElementById('cameraStatus').textContent = 'Failed to upload photo. Please try again.';
        }
    }
    
    function stopCamera() {
        if (cameraStream) {
            const tracks = cameraStream.getTracks();
            tracks.forEach(track => track.stop());
            cameraStream = null;
        }
        
        // Clean up video stream
        const video = document.getElementById('cameraPreview');
        if (video.srcObject) {
            video.srcObject = null;
        }
        
        // Clean up captured image URL
        const capturedImage = document.getElementById('capturedImage');
        if (capturedImage.src && capturedImage.src.startsWith('blob:')) {
            URL.revokeObjectURL(capturedImage.src);
        }
        
        // Reset UI
        document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('startCameraButton').style.display = 'inline-block';
        document.getElementById('captureButton').style.display = 'none';
        document.getElementById('retakeButton').style.display = 'none';
        document.getElementById('useCapturedButton').style.display = 'none';
        document.getElementById('stopCameraButton').style.display = 'none';
        
        // Clear captured photo
        capturedPhotoBlob = null;
        document.getElementById('cameraStatus').textContent = '';
    }

    // Set up event listeners
    if (sendButton) {
        sendButton.addEventListener('click', function() {
            window.sendMessage();
        });
    }

    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.sendMessage();
            }
        });
        
        // Focus on input when page loads
        chatInput.focus();
    }
    
    // File upload event listeners
    const toggleFileButton = document.getElementById('toggleFileButton');
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    
    if (toggleFileButton) {
        toggleFileButton.addEventListener('click', function() {
            const fileArea = document.getElementById('fileUploadArea');
            if (fileArea.style.display === 'none') {
                showFileArea();
            } else {
                hideFileArea();
            }
        });
    }
    
    if (uploadZone) {
        uploadZone.addEventListener('click', function() {
            fileInput.click();
        });
        
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => uploadFile(file));
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => uploadFile(file));
            e.target.value = ''; // Clear input for reuse
        });
    }
    
    // Voice recording event listeners
    const toggleVoiceButton = document.getElementById('toggleVoiceButton');
    const recordButton = document.getElementById('recordButton');
    const stopButton = document.getElementById('stopButton');
    const playButton = document.getElementById('playButton');
    const sendVoiceButton = document.getElementById('sendVoiceButton');
    const clearRecordingButton = document.getElementById('clearRecordingButton');
    
    if (toggleVoiceButton) {
        toggleVoiceButton.addEventListener('click', function() {
            const voiceArea = document.getElementById('voiceArea');
            if (voiceArea.style.display === 'none') {
                showVoiceArea();
            } else {
                hideVoiceArea();
            }
        });
    }
    
    if (recordButton) {
        recordButton.addEventListener('click', startRecording);
    }
    
    if (stopButton) {
        stopButton.addEventListener('click', stopRecording);
    }
    
    if (playButton) {
        playButton.addEventListener('click', function() {
            const audio = document.getElementById('audioPlayback');
            audio.play();
        });
    }
    
    if (sendVoiceButton) {
        sendVoiceButton.addEventListener('click', sendVoiceMessage);
    }
    
    if (clearRecordingButton) {
        clearRecordingButton.addEventListener('click', clearRecording);
    }
    
    // Speech Recognition Event Listeners
    const speechRecognitionButton = document.getElementById('speechRecognitionButton');
    const toggleTTSButton = document.getElementById('toggleTTSButton');
    const languageSelect = document.getElementById('languageSelect');
    
    if (speechRecognitionButton) {
        speechRecognitionButton.addEventListener('click', toggleSpeechRecognition);
    }
    
    if (toggleTTSButton) {
        toggleTTSButton.addEventListener('click', toggleTTS);
    }
    
    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            if (speechRecognition) {
                speechRecognition.lang = this.value;
            }
        });
    }
    
    // Initialize speech recognition on page load
    initializeSpeechRecognition();
    
    // Camera capture event listeners
    const toggleCameraButton = document.getElementById('toggleCameraButton');
    const startCameraButton = document.getElementById('startCameraButton');
    const captureButton = document.getElementById('captureButton');
    const retakeButton = document.getElementById('retakeButton');
    const useCapturedButton = document.getElementById('useCapturedButton');
    const stopCameraButton = document.getElementById('stopCameraButton');
    
    if (toggleCameraButton) {
        toggleCameraButton.addEventListener('click', function() {
            const cameraArea = document.getElementById('cameraArea');
            if (cameraArea.style.display === 'none') {
                showCameraArea();
            } else {
                hideCameraArea();
            }
        });
    }
    
    if (startCameraButton) {
        startCameraButton.addEventListener('click', startCamera);
    }
    
    if (captureButton) {
        captureButton.addEventListener('click', capturePhoto);
    }
    
    if (retakeButton) {
        retakeButton.addEventListener('click', retakePhoto);
    }
    
    if (useCapturedButton) {
        useCapturedButton.addEventListener('click', useCapturedPhoto);
    }
    
    if (stopCameraButton) {
        stopCameraButton.addEventListener('click', stopCamera);
    }
});
</script>

<style>
/* Main Chatbot Page Layout */
.chatbot-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 15px;
    width: 100%;
}

.chatbot-page h1 {
    text-align: center;
    color: #8b4d7a;
    margin-bottom: 30px;
    font-size: 2.5em;
}

.chat-container {
    background: linear-gradient(135deg, #fff0f5, #f0f8ff);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(255, 182, 193, 0.3);
    padding: 20px;
    min-height: 60vh;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.chat-header {
    margin-bottom: 20px;
}

.chat-breadcrumb {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 215, 0, 0.2);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.breadcrumb-text {
    font-weight: 600;
    color: #8b4d7a;
}

.btn-back {
    background: #ffd700;
    color: #8b4d7a;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
}

.chat-navigation {
    background: rgba(135, 206, 235, 0.2);
    padding: 10px 15px;
    border-radius: 10px;
    color: #4682b4;
    font-weight: 600;
}

.chat-messages {
    flex: 1;
    padding: 15px 0;
    overflow-y: auto;
    max-height: 40vh;
    margin-bottom: 15px;
    min-height: 200px;
}

.bot-message, .user-message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    gap: 15px;
}

.bot-message {
    justify-content: flex-start;
}

.user-message {
    flex-direction: row-reverse;
    justify-content: flex-end;
    margin-left: auto;
    margin-right: 0;
    width: fit-content;
    max-width: 80%;
}

.message-avatar {
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message-content {
    background: white;
    padding: 15px 20px;
    border-radius: 15px;
    max-width: 70%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid #ffb6c1;
    width: fit-content;
}

.user-message .message-content {
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
    border: 2px solid #ffd700;
    color: #8b4d7a;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
}

.response-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.option-btn {
    background: linear-gradient(135deg, #87ceeb, #b0e0e6);
    color: #4682b4;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.option-btn:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #6bb6ff, #87ceeb);
}

.response-actions {
    margin-top: 15px;
}

.action-btn {
    background: #ffd700;
    color: #8b4d7a;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.action-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
}

.chat-input-container {
    margin-top: 15px;
    position: relative;
    z-index: 10;
}

.chat-suggestions {
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    border: 2px solid #ffb6c1;
}

.suggestions-label {
    font-weight: 600;
    color: #8b4d7a;
    margin-bottom: 10px;
}

.suggestions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-btn {
    background: rgba(255, 215, 0, 0.3);
    color: #8b4d7a;
    border: 1px solid #ffd700;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.suggestion-btn:hover {
    background: #ffd700;
    transform: scale(1.05);
}

.quick-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
}

.quick-btn {
    background: rgba(255, 182, 193, 0.3);
    color: #8b4d7a;
    border: 2px solid #ffb6c1;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.quick-btn:hover {
    background: #ffb6c1;
    transform: scale(1.05);
}

/* File Upload Styles */
.file-upload-area {
    margin-bottom: 15px;
    padding: 15px;
    border: 2px dashed #ffb6c1;
    border-radius: 10px;
    background: linear-gradient(135deg, #fff0f5, #fffacd);
}

.uploaded-files {
    margin-bottom: 10px;
}

.uploaded-file {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 5px;
    border: 1px solid #ffb6c1;
}

.file-info {
    flex: 1;
    color: #8b4d7a;
}

.file-info small {
    color: #666;
    margin-left: 5px;
}

.btn-remove {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 3px;
}

.btn-remove:hover {
    background: rgba(255, 0, 0, 0.1);
}

.upload-zone {
    text-align: center;
    padding: 20px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-zone:hover, .upload-zone.drag-over {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.upload-icon {
    font-size: 24px;
    margin-bottom: 10px;
}

.upload-text {
    font-size: 16px;
    color: #8b4d7a;
    margin-bottom: 5px;
}

.upload-info {
    font-size: 12px;
    color: #666;
}

/* Voice Recording Styles */
.voice-recording-area {
    margin-bottom: 15px;
    padding: 15px;
    border: 2px solid #87ceeb;
    border-radius: 10px;
    background: linear-gradient(135deg, #e6f3ff, #f0f8ff);
}

.voice-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.btn-record, .btn-stop, .btn-play, .btn-clear, .btn-send-voice {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-record {
    background: #4CAF50;
    color: white;
}

.btn-record:hover {
    background: #45a049;
}

.btn-stop {
    background: #f44336;
    color: white;
}

.btn-stop:hover {
    background: #da190b;
}

.btn-play {
    background: #2196F3;
    color: white;
}

.btn-play:hover {
    background: #0b7dda;
}

.btn-clear {
    background: #9E9E9E;
    color: white;
}

.btn-clear:hover {
    background: #757575;
}

.btn-send-voice {
    background: #4CAF50;
    color: white;
    font-weight: bold;
    border: 2px solid #4CAF50;
}

.btn-send-voice:hover {
    background: #45a049;
    border-color: #45a049;
    transform: scale(1.05);
}

.recording-status {
    font-size: 14px;
    color: #4682b4;
    margin-bottom: 10px;
}

/* Main Input Area Styles */
.main-input-area {
    display: flex;
    gap: 10px;
    align-items: center;
}

.input-controls {
    display: flex;
    gap: 5px;
}

.btn-attach, .btn-voice, .btn-camera {
    padding: 8px;
    border: 2px solid #ffb6c1;
    border-radius: 5px;
    background: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-attach:hover, .btn-voice:hover, .btn-camera:hover {
    background: #ffb6c1;
    transform: scale(1.1);
}

#chatInput {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #ffb6c1;
    border-radius: 25px;
    font-size: 16px;
    outline: none;
    min-width: 200px;
    background: white;
}

#chatInput:focus {
    border-color: #ffd700;
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
}

#sendButton {
    padding: 10px 20px;
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
    border: none;
    border-radius: 20px;
    color: #8b4d7a;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

#sendButton:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(255, 182, 193, 0.3);
}

/* Audio controls styling */
#audioPlayback {
    width: 100%;
    margin-top: 10px;
}

/* Responsive design */
@media (max-width: 768px) {
    .chatbot-page {
        padding: 10px;
        max-width: 100%;
    }
    
    .chat-container {
        padding: 15px;
        min-height: 50vh;
    }
    
    .chat-messages {
        max-height: 35vh;
    }
    
    .main-input-area {
        flex-direction: column;
        gap: 10px;
    }
    
    .input-controls {
        justify-content: center;
        width: 100%;
    }
    
    #chatInput {
        width: 100%;
        min-width: auto;
    }
    
    .voice-controls, .camera-controls {
        justify-content: center;
    }
}

/* Speech Recognition Styling */
.speech-recognition-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
    padding: 10px;
    background: rgba(135, 206, 235, 0.1);
    border-radius: 8px;
    margin-bottom: 10px;
}

.language-selector {
    padding: 8px 12px;
    border: 2px solid #87CEEB;
    border-radius: 5px;
    background: white;
    color: #4682b4;
    font-size: 14px;
    cursor: pointer;
}

.language-selector:focus {
    outline: none;
    border-color: #4682b4;
}

.btn-speech {
    background: #87CEEB !important;
    color: #4682b4 !important;
    border: 2px solid #87CEEB !important;
    transition: all 0.3s ease;
}

.btn-speech:hover {
    background: #4682b4 !important;
    color: white !important;
}

.btn-tts {
    background: #32CD32 !important;
    color: white !important;
    border: 2px solid #32CD32 !important;
    transition: all 0.3s ease;
}

.btn-tts:hover {
    background: #228B22 !important;
}

.speech-status {
    color: #4682b4;
    font-size: 14px;
    font-style: italic;
    margin: 5px 0;
    text-align: center;
    min-height: 20px;
}

.speak-button {
    background: rgba(135, 206, 235, 0.2);
    border: 1px solid #87CEEB;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 14px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.speak-button:hover {
    background: #87CEEB;
    transform: scale(1.1);
}

/* Camera capture styling */
.camera-capture-area {
    background: #f8f9ff;
    border: 2px dashed #ffb6c1;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    text-align: center;
}

.camera-preview {
    margin-bottom: 15px;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0f0f0;
    border-radius: 8px;
    overflow: hidden;
}

#cameraPreview {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
}

.captured-photo img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.camera-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.camera-controls .btn {
    padding: 8px 12px;
    border: 2px solid #ffb6c1;
    border-radius: 5px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.camera-controls .btn:hover {
    background: #ffb6c1;
    transform: scale(1.05);
}

.btn-capture {
    background: #4CAF50 !important;
    color: white !important;
    border-color: #4CAF50 !important;
}

.btn-capture:hover {
    background: #45a049 !important;
}

.btn-use {
    background: #2196F3 !important;
    color: white !important;
    border-color: #2196F3 !important;
}

.btn-use:hover {
    background: #1976D2 !important;
}

.btn-retake {
    background: #FF9800 !important;
    color: white !important;
    border-color: #FF9800 !important;
}

.btn-retake:hover {
    background: #F57C00 !important;
}

.btn-stop-camera {
    background: #f44336 !important;
    color: white !important;
    border-color: #f44336 !important;
}

.btn-stop-camera:hover {
    background: #d32f2f !important;
}

.camera-status {
    color: #666;
    font-size: 14px;
    font-style: italic;
    margin-top: 10px;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--warm-white);
    margin: 5% auto;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-xl);
    position: relative;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-content h2 {
    color: var(--soft-blue-dark);
    margin-bottom: 20px;
    text-align: center;
}

.close {
    color: var(--gray-400);
    float: right;
    font-size: 28px;
    font-weight: bold;
    position: absolute;
    right: 20px;
    top: 15px;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: var(--danger);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--gray-700);
    font-weight: 600;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--sage-green-light);
    border-radius: 10px;
    font-size: 16px;
    font-family: inherit;
    transition: all 0.3s ease;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--soft-blue);
    box-shadow: 0 0 0 3px rgba(168, 213, 232, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-group small {
    display: block;
    color: var(--gray-500);
    font-size: 0.875rem;
    margin-top: 5px;
}

.form-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.form-buttons .btn {
    flex: 1;
    padding: 15px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.form-buttons .btn-primary {
    background: linear-gradient(135deg, var(--sage-green), var(--soft-blue));
    color: white;
}

.form-buttons .btn-secondary {
    background: var(--warm-cream);
    color: var(--gray-700);
    border: 2px solid var(--sage-green-light);
}

.form-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.form-buttons .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 600px) {
    .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: 20px;
    }
    
    .form-buttons {
        flex-direction: column;
    }
}

</style>
{% endblock %}