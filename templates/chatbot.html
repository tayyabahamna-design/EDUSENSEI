{% extends "base.html" %}

{% block title %}AI Teaching Assistant - Tutor's Assistant{% endblock %}

{% block content %}
<div class="chatbot-page">
    <h1>ü§ñüíñ AI Teaching Assistant üåà‚ú®</h1>
    
    <div class="chat-container">
        <div class="chat-header" id="chatHeader">
            <div class="chat-breadcrumb" id="chatBreadcrumb" style="display: none;">
                <span class="breadcrumb-text"></span>
                <button class="btn-back" onclick="sendMessage('menu')">‚Üê Back to Menu</button>
            </div>
            <div class="chat-navigation" id="chatNavigation" style="display: none;">
                <span class="navigation-text"></span>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>Hello! I'm your helpful AI assistant! üíñ I'm here to help you with coding, writing, analysis, creative tasks, general questions, and much more! üåü</p>
                    <p>Type <strong>"hi"</strong> or <strong>"hello"</strong> to get started and see all the ways I can help you! ‚ú®</p>
                </div>
            </div>
        </div>
        
        <div class="chat-suggestions" id="chatSuggestions" style="display: none;">
            <div class="suggestions-label">Suggestions:</div>
            <div class="suggestions-list" id="suggestionsList"></div>
        </div>
        
        <div class="chat-input-container">
            <!-- File Upload Area -->
            <div class="file-upload-area" id="fileUploadArea" style="display: none;">
                <div class="uploaded-files" id="uploadedFiles"></div>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìé</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-info">Images, PDFs, and text files up to 12MB</div>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.docx" style="display: none;">
                </div>
            </div>
            
            <!-- Voice Recording Area -->
            <div class="voice-recording-area" id="voiceArea" style="display: none;">
                <div class="voice-controls">
                    <button id="recordButton" class="btn btn-record">üé§ Record</button>
                    <button id="stopButton" class="btn btn-stop" style="display: none;">‚èπÔ∏è Stop</button>
                    <button id="playButton" class="btn btn-play" style="display: none;">‚ñ∂Ô∏è Play</button>
                    <button id="sendVoiceButton" class="btn btn-send-voice" style="display: none;">üì§ Send Voice Message</button>
                    <button id="clearRecordingButton" class="btn btn-clear" style="display: none;">üóëÔ∏è Clear</button>
                </div>
                <div class="recording-status" id="recordingStatus"></div>
                <audio id="audioPlayback" controls style="display: none;"></audio>
            </div>
            
            <!-- Camera Capture Area -->
            <div class="camera-capture-area" id="cameraArea" style="display: none;">
                <div class="camera-preview">
                    <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
                    <canvas id="photoCanvas" style="display: none;"></canvas>
                    <div class="captured-photo" id="capturedPhoto" style="display: none;">
                        <img id="capturedImage" alt="Captured photo">
                    </div>
                </div>
                <div class="camera-controls">
                    <button id="startCameraButton" class="btn btn-camera">üì∑ Start Camera</button>
                    <button id="captureButton" class="btn btn-capture" style="display: none;">üì∏ Capture</button>
                    <button id="retakeButton" class="btn btn-retake" style="display: none;">üîÑ Retake</button>
                    <button id="useCapturedButton" class="btn btn-use" style="display: none;">‚úÖ Use Photo</button>
                    <button id="stopCameraButton" class="btn btn-stop-camera" style="display: none;">‚ùå Close Camera</button>
                </div>
                <div class="camera-status" id="cameraStatus"></div>
            </div>
            
            <!-- Main Input Area -->
            <div class="main-input-area">
                <div class="input-controls">
                    <button id="toggleFileButton" class="btn btn-attach" title="Attach Files">üìé</button>
                    <button id="toggleCameraButton" class="btn btn-camera" title="Take Photo">üì∑</button>
                    <button id="toggleVoiceButton" class="btn btn-voice" title="Voice Message">üé§</button>
                </div>
                <input type="text" id="chatInput" placeholder="Type your message here..." autocomplete="off">
                <button id="sendButton" class="btn btn-primary">Send</button>
            </div>
        </div>
        
        <div class="quick-actions" id="quickActions">
            <button class="quick-btn" onclick="sendMessage('menu')">Main Menu</button>
            <button class="quick-btn" onclick="sendMessage('help')">Help</button>
        </div>
    </div>
    
</div>

<script>
// Wait for the page to load completely
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');

    function addMessage(content, isUser = false) {
        if (!chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'user-message' : 'bot-message';
        
        if (typeof content === 'string') {
            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'üòä' : 'ü§ñ'}</div>
                <div class="message-content">
                    <p></p>
                </div>
            `;
            // Set content safely to prevent XSS
            messageDiv.querySelector('.message-content p').textContent = content;
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${formatBotResponse(content)}
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatBotResponse(response) {
        let html = '';
        
        // Add title if present
        if (response.title) {
            html += `<h4 class="response-title">${response.title}</h4>`;
        }
        
        // Add main message
        html += `<p>${response.message || 'No response'}</p>`;
        
        // Add options buttons
        if (response.options && response.options.length > 0) {
            html += '<div class="response-options">';
            response.options.forEach(option => {
                html += `<button class="option-btn" onclick="sendMessage('${option.replace(/'/g, "\\'")}')">${option}</button>`;
            });
            html += '</div>';
        }
        
        // Removed inline input field - use main chatbox instead
        
        // Handle navigation and breadcrumbs
        updateNavigation(response);
        
        // Handle suggestions
        updateSuggestions(response.suggestions);
        
        // Add return to menu button if specified
        if (response.return_to_menu) {
            html += '<div class="response-actions">';
            html += '<button class="action-btn" onclick="sendMessage(\'menu\')">Return to Main Menu</button>';
            html += '</div>';
        }
        
        return html;
    }
    
    function updateNavigation(response) {
        const breadcrumb = document.getElementById('chatBreadcrumb');
        const navigation = document.getElementById('chatNavigation');
        
        if (response.breadcrumb) {
            breadcrumb.querySelector('.breadcrumb-text').textContent = response.breadcrumb;
            breadcrumb.style.display = 'flex';
        } else {
            breadcrumb.style.display = 'none';
        }
        
        if (response.navigation) {
            navigation.querySelector('.navigation-text').textContent = response.navigation;
            navigation.style.display = 'block';
        } else {
            navigation.style.display = 'none';
        }
    }
    
    function updateSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('chatSuggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        
        if (suggestions && suggestions.length > 0) {
            suggestionsList.innerHTML = '';
            suggestions.forEach(suggestion => {
                const suggestionBtn = document.createElement('button');
                suggestionBtn.className = 'suggestion-btn';
                suggestionBtn.textContent = suggestion;
                suggestionBtn.onclick = () => sendMessage(suggestion);
                suggestionsList.appendChild(suggestionBtn);
            });
            suggestionsContainer.style.display = 'block';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    // Inline input functions removed - using main chatbox instead

    // Voice recording variables
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let currentAudioId = null;
    let uploadedFiles = [];
    
    // Camera variables
    let cameraStream = null;
    let capturedPhotoBlob = null;
    
    // Make sendMessage globally available with multimodal support
    window.sendMessage = async function(message = null) {
        const messageText = message || (chatInput ? chatInput.value.trim() : '');
        if (!messageText && !currentAudioId && uploadedFiles.length === 0) return;
        
        // Show what's being sent
        let displayMessage = messageText;
        if (currentAudioId) displayMessage += " üé§ Voice message";
        if (uploadedFiles.length > 0) displayMessage += ` üìé ${uploadedFiles.length} file(s)`;
        
        addMessage(displayMessage, true);
        if (!message && chatInput) chatInput.value = '';
        
        try {
            const payload = { 
                message: messageText,
                file_ids: uploadedFiles.map(f => f.file_id),
                audio_id: currentAudioId
            };
            
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            addMessage(data);
            
            // Clear uploaded files and audio after sending
            clearUploads();
            
        } catch (error) {
            console.error('Chat error:', error);
            addMessage('Sorry, I encountered an error. Please try again.');
        }
    };
    
    function clearUploads() {
        uploadedFiles = [];
        currentAudioId = null;
        updateUploadDisplay();
        hideFileArea();
        hideVoiceArea();
        clearRecording();
    }
    
    // File upload functions
    function showFileArea() {
        document.getElementById('fileUploadArea').style.display = 'block';
    }
    
    function hideFileArea() {
        document.getElementById('fileUploadArea').style.display = 'none';
    }
    
    function showVoiceArea() {
        document.getElementById('voiceArea').style.display = 'block';
    }
    
    function hideVoiceArea() {
        document.getElementById('voiceArea').style.display = 'none';
    }
    
    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/upload_file', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            
            const result = await response.json();
            uploadedFiles.push(result);
            updateUploadDisplay();
            
        } catch (error) {
            console.error('File upload error:', error);
            alert('Failed to upload file: ' + file.name);
        }
    }
    
    function updateUploadDisplay() {
        const container = document.getElementById('uploadedFiles');
        container.innerHTML = '';
        
        uploadedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            fileDiv.innerHTML = `
                <span class="file-info">
                    ${file.type === 'image' ? 'üñºÔ∏è' : 'üìÑ'} ${file.original_name}
                    <small>(${formatFileSize(file.size)})</small>
                </span>
                <button class="btn-remove" onclick="removeFile(${index})">‚ùå</button>
            `;
            container.appendChild(fileDiv);
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    window.removeFile = function(index) {
        uploadedFiles.splice(index, 1);
        updateUploadDisplay();
        if (uploadedFiles.length === 0) {
            hideFileArea();
        }
    };
    
    // Voice recording functions
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await uploadAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            
            document.getElementById('recordButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'inline-block';
            document.getElementById('recordingStatus').textContent = 'üî¥ Recording...';
            
        } catch (error) {
            console.error('Recording error:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            document.getElementById('recordButton').style.display = 'inline-block';
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('recordingStatus').textContent = '‚è≥ Processing...';
        }
    }
    
    async function uploadAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        try {
            const response = await fetch('/upload_audio', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Audio upload failed');
            }
            
            const result = await response.json();
            currentAudioId = result.audio_id;
            
            // Show playback controls
            const audioUrl = `/media/${result.audio_id}`;
            const audioElement = document.getElementById('audioPlayback');
            audioElement.src = audioUrl;
            audioElement.style.display = 'block';
            
            document.getElementById('playButton').style.display = 'inline-block';
            document.getElementById('sendVoiceButton').style.display = 'inline-block';
            document.getElementById('clearRecordingButton').style.display = 'inline-block';
            document.getElementById('recordingStatus').textContent = `‚úÖ ${result.transcription ? '"' + result.transcription + '"' : 'Voice message ready to send'}`;
            
        } catch (error) {
            console.error('Audio upload error:', error);
            document.getElementById('recordingStatus').textContent = '‚ùå Upload failed';
        }
    }
    
    function clearRecording() {
        currentAudioId = null;
        audioBlob = null;
        document.getElementById('audioPlayback').style.display = 'none';
        document.getElementById('playButton').style.display = 'none';
        document.getElementById('sendVoiceButton').style.display = 'none';
        document.getElementById('clearRecordingButton').style.display = 'none';
        document.getElementById('recordingStatus').textContent = '';
        document.getElementById('recordButton').style.display = 'inline-block';
    }
    
    function sendVoiceMessage() {
        if (currentAudioId) {
            // Send the voice message using the existing sendMessage function
            window.sendMessage();
            // Close the voice area after sending
            hideVoiceArea();
        }
    }

    // Camera functions
    function showCameraArea() {
        document.getElementById('cameraArea').style.display = 'block';
        hideFileArea();
        hideVoiceArea();
    }
    
    function hideFileArea() {
        document.getElementById('fileUploadArea').style.display = 'none';
    }
    
    function hideVoiceArea() {
        document.getElementById('voiceArea').style.display = 'none';
    }
    
    function hideCameraArea() {
        document.getElementById('cameraArea').style.display = 'none';
        stopCamera();
    }
    
    async function startCamera() {
        // Check if camera is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('cameraStatus').textContent = 'Camera not available. Please use HTTPS or a supported browser.';
            return;
        }
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment', // Try back camera first
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            
            const video = document.getElementById('cameraPreview');
            video.srcObject = cameraStream;
            video.style.display = 'block';
            
            // Update buttons
            document.getElementById('startCameraButton').style.display = 'none';
            document.getElementById('captureButton').style.display = 'inline-block';
            document.getElementById('stopCameraButton').style.display = 'inline-block';
            
            document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
            
        } catch (error) {
            console.error('Camera access error:', error);
            // Try front camera if back camera fails
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', // Front camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                video.style.display = 'block';
                
                // Update buttons
                document.getElementById('startCameraButton').style.display = 'none';
                document.getElementById('captureButton').style.display = 'inline-block';
                document.getElementById('stopCameraButton').style.display = 'inline-block';
                
                document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
                
            } catch (secondError) {
                console.error('Camera access failed:', secondError);
                document.getElementById('cameraStatus').textContent = 'Camera access denied or not available';
            }
        }
    }
    
    function capturePhoto() {
        const video = document.getElementById('cameraPreview');
        const canvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const capturedImage = document.getElementById('capturedImage');
        
        // Check if video is ready
        if (video.videoWidth === 0 || video.videoHeight === 0) {
            document.getElementById('cameraStatus').textContent = 'Camera not ready yet. Please wait...';
            return;
        }
        
        // Set canvas size to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw video frame to canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob
        canvas.toBlob(function(blob) {
            capturedPhotoBlob = blob;
            
            // Show captured image
            const imageUrl = URL.createObjectURL(blob);
            capturedImage.src = imageUrl;
            capturedPhoto.style.display = 'block';
            video.style.display = 'none';
            
            // Update buttons
            document.getElementById('captureButton').style.display = 'none';
            document.getElementById('retakeButton').style.display = 'inline-block';
            document.getElementById('useCapturedButton').style.display = 'inline-block';
            
            document.getElementById('cameraStatus').textContent = 'Photo captured! Use it or retake.';
        }, 'image/jpeg', 0.8);
    }
    
    function retakePhoto() {
        // Clear captured photo
        capturedPhotoBlob = null;
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('cameraPreview').style.display = 'block';
        
        // Update buttons
        document.getElementById('retakeButton').style.display = 'none';
        document.getElementById('useCapturedButton').style.display = 'none';
        document.getElementById('captureButton').style.display = 'inline-block';
        
        document.getElementById('cameraStatus').textContent = 'Camera ready - tap capture to take photo';
    }
    
    async function useCapturedPhoto() {
        if (!capturedPhotoBlob) return;
        
        try {
            // Create a file from the blob
            const file = new File([capturedPhotoBlob], `camera_capture_${Date.now()}.jpg`, {
                type: 'image/jpeg'
            });
            
            // Upload the captured photo
            await uploadFile(file);
            
            // Close camera and reset
            stopCamera();
            hideCameraArea();
            
        } catch (error) {
            console.error('Failed to upload captured photo:', error);
            document.getElementById('cameraStatus').textContent = 'Failed to upload photo. Please try again.';
        }
    }
    
    function stopCamera() {
        if (cameraStream) {
            const tracks = cameraStream.getTracks();
            tracks.forEach(track => track.stop());
            cameraStream = null;
        }
        
        // Clean up video stream
        const video = document.getElementById('cameraPreview');
        if (video.srcObject) {
            video.srcObject = null;
        }
        
        // Clean up captured image URL
        const capturedImage = document.getElementById('capturedImage');
        if (capturedImage.src && capturedImage.src.startsWith('blob:')) {
            URL.revokeObjectURL(capturedImage.src);
        }
        
        // Reset UI
        document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('startCameraButton').style.display = 'inline-block';
        document.getElementById('captureButton').style.display = 'none';
        document.getElementById('retakeButton').style.display = 'none';
        document.getElementById('useCapturedButton').style.display = 'none';
        document.getElementById('stopCameraButton').style.display = 'none';
        
        // Clear captured photo
        capturedPhotoBlob = null;
        document.getElementById('cameraStatus').textContent = '';
    }

    // Set up event listeners
    if (sendButton) {
        sendButton.addEventListener('click', function() {
            window.sendMessage();
        });
    }

    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.sendMessage();
            }
        });
        
        // Focus on input when page loads
        chatInput.focus();
    }
    
    // File upload event listeners
    const toggleFileButton = document.getElementById('toggleFileButton');
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    
    if (toggleFileButton) {
        toggleFileButton.addEventListener('click', function() {
            const fileArea = document.getElementById('fileUploadArea');
            if (fileArea.style.display === 'none') {
                showFileArea();
            } else {
                hideFileArea();
            }
        });
    }
    
    if (uploadZone) {
        uploadZone.addEventListener('click', function() {
            fileInput.click();
        });
        
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => uploadFile(file));
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => uploadFile(file));
            e.target.value = ''; // Clear input for reuse
        });
    }
    
    // Voice recording event listeners
    const toggleVoiceButton = document.getElementById('toggleVoiceButton');
    const recordButton = document.getElementById('recordButton');
    const stopButton = document.getElementById('stopButton');
    const playButton = document.getElementById('playButton');
    const sendVoiceButton = document.getElementById('sendVoiceButton');
    const clearRecordingButton = document.getElementById('clearRecordingButton');
    
    if (toggleVoiceButton) {
        toggleVoiceButton.addEventListener('click', function() {
            const voiceArea = document.getElementById('voiceArea');
            if (voiceArea.style.display === 'none') {
                showVoiceArea();
            } else {
                hideVoiceArea();
            }
        });
    }
    
    if (recordButton) {
        recordButton.addEventListener('click', startRecording);
    }
    
    if (stopButton) {
        stopButton.addEventListener('click', stopRecording);
    }
    
    if (playButton) {
        playButton.addEventListener('click', function() {
            const audio = document.getElementById('audioPlayback');
            audio.play();
        });
    }
    
    if (sendVoiceButton) {
        sendVoiceButton.addEventListener('click', sendVoiceMessage);
    }
    
    if (clearRecordingButton) {
        clearRecordingButton.addEventListener('click', clearRecording);
    }
    
    // Camera capture event listeners
    const toggleCameraButton = document.getElementById('toggleCameraButton');
    const startCameraButton = document.getElementById('startCameraButton');
    const captureButton = document.getElementById('captureButton');
    const retakeButton = document.getElementById('retakeButton');
    const useCapturedButton = document.getElementById('useCapturedButton');
    const stopCameraButton = document.getElementById('stopCameraButton');
    
    if (toggleCameraButton) {
        toggleCameraButton.addEventListener('click', function() {
            const cameraArea = document.getElementById('cameraArea');
            if (cameraArea.style.display === 'none') {
                showCameraArea();
            } else {
                hideCameraArea();
            }
        });
    }
    
    if (startCameraButton) {
        startCameraButton.addEventListener('click', startCamera);
    }
    
    if (captureButton) {
        captureButton.addEventListener('click', capturePhoto);
    }
    
    if (retakeButton) {
        retakeButton.addEventListener('click', retakePhoto);
    }
    
    if (useCapturedButton) {
        useCapturedButton.addEventListener('click', useCapturedPhoto);
    }
    
    if (stopCameraButton) {
        stopCameraButton.addEventListener('click', stopCamera);
    }
});
</script>

<style>
/* Main Chatbot Page Layout */
.chatbot-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 15px;
    width: 100%;
}

.chatbot-page h1 {
    text-align: center;
    color: #8b4d7a;
    margin-bottom: 30px;
    font-size: 2.5em;
}

.chat-container {
    background: linear-gradient(135deg, #fff0f5, #f0f8ff);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(255, 182, 193, 0.3);
    padding: 20px;
    min-height: 60vh;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.chat-header {
    margin-bottom: 20px;
}

.chat-breadcrumb {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 215, 0, 0.2);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.breadcrumb-text {
    font-weight: 600;
    color: #8b4d7a;
}

.btn-back {
    background: #ffd700;
    color: #8b4d7a;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
}

.chat-navigation {
    background: rgba(135, 206, 235, 0.2);
    padding: 10px 15px;
    border-radius: 10px;
    color: #4682b4;
    font-weight: 600;
}

.chat-messages {
    flex: 1;
    padding: 15px 0;
    overflow-y: auto;
    max-height: 40vh;
    margin-bottom: 15px;
    min-height: 200px;
}

.bot-message, .user-message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    gap: 15px;
}

.bot-message {
    justify-content: flex-start;
}

.user-message {
    flex-direction: row-reverse;
    justify-content: flex-end;
    margin-left: auto;
    margin-right: 0;
    width: fit-content;
    max-width: 80%;
}

.message-avatar {
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message-content {
    background: white;
    padding: 15px 20px;
    border-radius: 15px;
    max-width: 70%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid #ffb6c1;
    width: fit-content;
}

.user-message .message-content {
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
    border: 2px solid #ffd700;
    color: #8b4d7a;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
}

.response-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.option-btn {
    background: linear-gradient(135deg, #87ceeb, #b0e0e6);
    color: #4682b4;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.option-btn:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #6bb6ff, #87ceeb);
}

.response-actions {
    margin-top: 15px;
}

.action-btn {
    background: #ffd700;
    color: #8b4d7a;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.action-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
}

.chat-input-container {
    margin-top: 15px;
    position: relative;
    z-index: 10;
}

.chat-suggestions {
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    border: 2px solid #ffb6c1;
}

.suggestions-label {
    font-weight: 600;
    color: #8b4d7a;
    margin-bottom: 10px;
}

.suggestions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-btn {
    background: rgba(255, 215, 0, 0.3);
    color: #8b4d7a;
    border: 1px solid #ffd700;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.suggestion-btn:hover {
    background: #ffd700;
    transform: scale(1.05);
}

.quick-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
}

.quick-btn {
    background: rgba(255, 182, 193, 0.3);
    color: #8b4d7a;
    border: 2px solid #ffb6c1;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.quick-btn:hover {
    background: #ffb6c1;
    transform: scale(1.05);
}

/* File Upload Styles */
.file-upload-area {
    margin-bottom: 15px;
    padding: 15px;
    border: 2px dashed #ffb6c1;
    border-radius: 10px;
    background: linear-gradient(135deg, #fff0f5, #fffacd);
}

.uploaded-files {
    margin-bottom: 10px;
}

.uploaded-file {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 5px;
    border: 1px solid #ffb6c1;
}

.file-info {
    flex: 1;
    color: #8b4d7a;
}

.file-info small {
    color: #666;
    margin-left: 5px;
}

.btn-remove {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 3px;
}

.btn-remove:hover {
    background: rgba(255, 0, 0, 0.1);
}

.upload-zone {
    text-align: center;
    padding: 20px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-zone:hover, .upload-zone.drag-over {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.upload-icon {
    font-size: 24px;
    margin-bottom: 10px;
}

.upload-text {
    font-size: 16px;
    color: #8b4d7a;
    margin-bottom: 5px;
}

.upload-info {
    font-size: 12px;
    color: #666;
}

/* Voice Recording Styles */
.voice-recording-area {
    margin-bottom: 15px;
    padding: 15px;
    border: 2px solid #87ceeb;
    border-radius: 10px;
    background: linear-gradient(135deg, #e6f3ff, #f0f8ff);
}

.voice-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.btn-record, .btn-stop, .btn-play, .btn-clear, .btn-send-voice {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-record {
    background: #4CAF50;
    color: white;
}

.btn-record:hover {
    background: #45a049;
}

.btn-stop {
    background: #f44336;
    color: white;
}

.btn-stop:hover {
    background: #da190b;
}

.btn-play {
    background: #2196F3;
    color: white;
}

.btn-play:hover {
    background: #0b7dda;
}

.btn-clear {
    background: #9E9E9E;
    color: white;
}

.btn-clear:hover {
    background: #757575;
}

.btn-send-voice {
    background: #4CAF50;
    color: white;
    font-weight: bold;
    border: 2px solid #4CAF50;
}

.btn-send-voice:hover {
    background: #45a049;
    border-color: #45a049;
    transform: scale(1.05);
}

.recording-status {
    font-size: 14px;
    color: #4682b4;
    margin-bottom: 10px;
}

/* Main Input Area Styles */
.main-input-area {
    display: flex;
    gap: 10px;
    align-items: center;
}

.input-controls {
    display: flex;
    gap: 5px;
}

.btn-attach, .btn-voice, .btn-camera {
    padding: 8px;
    border: 2px solid #ffb6c1;
    border-radius: 5px;
    background: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-attach:hover, .btn-voice:hover, .btn-camera:hover {
    background: #ffb6c1;
    transform: scale(1.1);
}

#chatInput {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #ffb6c1;
    border-radius: 25px;
    font-size: 16px;
    outline: none;
    min-width: 200px;
    background: white;
}

#chatInput:focus {
    border-color: #ffd700;
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
}

#sendButton {
    padding: 10px 20px;
    background: linear-gradient(135deg, #ffb6c1, #ffd700);
    border: none;
    border-radius: 20px;
    color: #8b4d7a;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

#sendButton:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(255, 182, 193, 0.3);
}

/* Audio controls styling */
#audioPlayback {
    width: 100%;
    margin-top: 10px;
}

/* Responsive design */
@media (max-width: 768px) {
    .chatbot-page {
        padding: 10px;
        max-width: 100%;
    }
    
    .chat-container {
        padding: 15px;
        min-height: 50vh;
    }
    
    .chat-messages {
        max-height: 35vh;
    }
    
    .main-input-area {
        flex-direction: column;
        gap: 10px;
    }
    
    .input-controls {
        justify-content: center;
        width: 100%;
    }
    
    #chatInput {
        width: 100%;
        min-width: auto;
    }
    
    .voice-controls, .camera-controls {
        justify-content: center;
    }
}

/* Camera capture styling */
.camera-capture-area {
    background: #f8f9ff;
    border: 2px dashed #ffb6c1;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    text-align: center;
}

.camera-preview {
    margin-bottom: 15px;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0f0f0;
    border-radius: 8px;
    overflow: hidden;
}

#cameraPreview {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
}

.captured-photo img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.camera-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.camera-controls .btn {
    padding: 8px 12px;
    border: 2px solid #ffb6c1;
    border-radius: 5px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.camera-controls .btn:hover {
    background: #ffb6c1;
    transform: scale(1.05);
}

.btn-capture {
    background: #4CAF50 !important;
    color: white !important;
    border-color: #4CAF50 !important;
}

.btn-capture:hover {
    background: #45a049 !important;
}

.btn-use {
    background: #2196F3 !important;
    color: white !important;
    border-color: #2196F3 !important;
}

.btn-use:hover {
    background: #1976D2 !important;
}

.btn-retake {
    background: #FF9800 !important;
    color: white !important;
    border-color: #FF9800 !important;
}

.btn-retake:hover {
    background: #F57C00 !important;
}

.btn-stop-camera {
    background: #f44336 !important;
    color: white !important;
    border-color: #f44336 !important;
}

.btn-stop-camera:hover {
    background: #d32f2f !important;
}

.camera-status {
    color: #666;
    font-size: 14px;
    font-style: italic;
    margin-top: 10px;
}

</style>
{% endblock %}