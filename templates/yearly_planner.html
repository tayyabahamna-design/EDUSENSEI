<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yearly Planner - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]);var n=t;if("undefined"!=typeof e){for(var p=0;p<o.length-1;p++)n[o[p]]=n[o[p]]||{},n=n[o[p]];n[o[o.length-1]]=i}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getGroups create_alias get_distinct_id get_session_id capture_pageview capture_pageleave register_for_session unregister_for_session".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        
        // Initialize PostHog with delay to ensure script loads
        setTimeout(function() {
            try {
                if (typeof posthog !== 'undefined' && posthog.init) {
                    posthog.init('{{ posthog_key }}', {
                        api_host: '{{ posthog_host }}'
                    });
                    console.log('PostHog initialized successfully');
                } else {
                    throw new Error('PostHog not loaded');
                }
            } catch (error) {
                console.log('PostHog initialization failed:', error);
                window.posthog = {
                    capture: function() { console.log('PostHog tracking:', arguments); },
                    identify: function() { console.log('PostHog identify:', arguments); }
                };
            }
        }, 1000);
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üìÖ Yearly Planner</h1>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">üè† Dashboard</a>
                <a href="{{ url_for('grading_buddy') }}" class="nav-link">üìä Grading Buddy</a>
                <a href="{{ url_for('chatbot') }}" class="nav-link">ü§ñ U-Dost Chat</a>
                <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                <a href="#" onclick="logout()" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="planner-container">
            <div class="welcome-section">
                <h1>üìÖ Yearly Planner</h1>
                <p class="welcome-subtitle">Create your teaching schedule in 3 simple steps</p>
            </div>
            
            <!-- Step 1: Select Teaching Details -->
            <div class="step-1" id="step1">
                <h3>Step 1: Select Your Teaching Details</h3>
                
                <div class="selection-area">
                    <div class="form-group">
                        <label for="teacherGrade">Select Grade:</label>
                        <select id="teacherGrade" class="form-control">
                            <option value="">Choose Grade</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Your Subjects:</label>
                        <div class="subject-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="english" value="English"> English
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="math" value="Math"> Math
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="urdu" value="Urdu"> Urdu
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="islamiyat" value="Islamiyat"> Islamiyat
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="science" value="Science"> Science
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="social" value="Social Studies"> Social Studies
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="gk" value="General Knowledge"> General Knowledge
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="createWeeklyTemplate()" class="btn btn-primary next-btn">Create Weekly Template</button>
                </div>
            </div>
            
            <!-- Step 2: Weekly Template (Hidden initially) -->
            <div id="weeklyTemplate" style="display:none;"></div>
            
            <!-- Step 3: Yearly Calendar (Hidden initially) -->
            <div id="yearlyCalendar" style="display:none;"></div>
        </div>
    </main>

    <script>
        // Common session management function
        function getCurrentUser() {
            const savedUser = localStorage.getItem('ustaadDostUser');
            return savedUser ? JSON.parse(savedUser) : null;
        }
        
        function logout() {
            console.log("Logging out user..."); // Debug log
            localStorage.removeItem('ustaadDostUser');
            sessionStorage.clear();
            console.log("Local session data cleared"); // Debug log
            window.location.href = '/logout';
        }
        
        // STEP 2 - WEEKLY TEMPLATE CREATION
        function createWeeklyTemplate() {
            const selectedGrade = document.getElementById('teacherGrade').value;
            const selectedSubjects = [];
            
            // Get selected subjects
            const checkboxes = document.querySelectorAll('.subject-checkboxes input:checked');
            checkboxes.forEach(cb => selectedSubjects.push(cb.value));
            
            if (!selectedGrade || selectedSubjects.length === 0) {
                alert('Please select grade and at least one subject!');
                return;
            }
            
            // Hide step 1
            document.getElementById('step1').style.display = 'none';
            
            // Show weekly template builder
            const templateDiv = document.getElementById('weeklyTemplate');
            templateDiv.style.display = 'block';
            templateDiv.innerHTML = `
                <h3>Step 2: Create Your Weekly Schedule</h3>
                <p class="grade-subjects-info">Grade: ${selectedGrade} | Subjects: ${selectedSubjects.join(', ')}</p>
                
                ${addQuickActionsToolbar()}
                
                <div class="weekly-schedule">
                    ${createDaySchedule('Monday', selectedSubjects)}
                    ${createDaySchedule('Tuesday', selectedSubjects)}
                    ${createDaySchedule('Wednesday', selectedSubjects)}
                    ${createDaySchedule('Thursday', selectedSubjects)}
                    ${createDaySchedule('Friday', selectedSubjects)}
                </div>
                
                <div class="action-buttons">
                    <button onclick="goBackToStep1()" class="btn btn-secondary">‚Üê Back to Step 1</button>
                    <button onclick="copyToYear()" class="btn btn-success copy-btn">üìÖ Copy This Week to Entire Year</button>
                </div>
            `;
            
            // Store selected subjects globally for period management
            localStorage.setItem('selectedSubjects', JSON.stringify(selectedSubjects));
        }

        function createDaySchedule(day, subjects) {
            return `
                <div class="day-schedule" style="border: 2px solid #333; padding: 15px; margin: 10px; border-radius: 8px; background: #fafafa;">
                    <h4>${day} Schedule</h4>
                    
                    <div class="periods-container">
                        <div class="period-header" style="margin-bottom: 15px;">
                            <button onclick="addNewPeriod('${day}')" class="add-period-btn" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">‚ûï Add Period</button>
                            <button onclick="resetDaySchedule('${day}')" class="reset-btn" style="background: #ffc107; color: black; padding: 8px 12px; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">üîÑ Reset Day</button>
                        </div>
                        
                        <div id="${day}_periods" class="all-periods">
                            ${createEditablePeriod(day, 1, '08:00', '08:40', subjects)}
                            ${createEditablePeriod(day, 2, '08:40', '09:20', subjects)}
                            ${createEditablePeriod(day, 3, '9:20', '10:00', subjects)}
                            
                            <!-- EDITABLE BREAK TIME -->
                            ${createEditableBreak(day, '10:00', '10:20')}
                            
                            ${createEditablePeriod(day, 4, '10:20', '11:00', subjects)}
                            ${createEditablePeriod(day, 5, '11:00', '11:40', subjects)}
                            ${createEditablePeriod(day, 6, '11:40', '12:20', subjects)}
                            ${createEditablePeriod(day, 7, '12:20', '13:00', subjects)}
                            
                            <!-- LUNCH BREAK -->
                            ${createEditableBreak(day, '13:00', '13:40', 'Lunch')}
                            
                            ${createEditablePeriod(day, 8, '13:40', '14:20', subjects)}
                        </div>
                    </div>
                </div>
            `;
        }

        function createEditablePeriod(day, periodNumber, startTime, endTime, subjects) {
            return `
                <div class="period-row" id="${day}_period${periodNumber}_container" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    <div class="period-info" style="flex: 1;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Period ${periodNumber}:</label>
                        
                        <div class="time-inputs" style="margin: 5px 0;">
                            <input type="time" id="${day}_period${periodNumber}_start" value="${startTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            <span style="margin: 0 5px;">to</span>
                            <input type="time" id="${day}_period${periodNumber}_end" value="${endTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                        
                        <select id="${day}_period${periodNumber}_subject" style="width: 150px; margin: 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            <option value="">Select Subject</option>
                            ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="period-actions" style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="deletePeriod('${day}', ${periodNumber})" class="delete-btn" style="background: #dc3545; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        <button onclick="duplicatePeriod('${day}', ${periodNumber})" class="duplicate-btn" style="background: #007bff; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã</button>
                    </div>
                </div>
            `;
        }

        function createEditableBreak(day, startTime, endTime, breakType = 'Break') {
            return `
                <div class="break-row" id="${day}_${breakType.toLowerCase()}_container" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7;">
                    <div class="break-info" style="flex: 1;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">${breakType} Time:</label>
                        
                        <div class="time-inputs" style="margin: 5px 0;">
                            <input type="time" id="${day}_${breakType.toLowerCase()}_start" value="${startTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            <span style="margin: 0 5px;">to</span>
                            <input type="time" id="${day}_${breakType.toLowerCase()}_end" value="${endTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                    </div>
                    
                    <div class="break-actions">
                        <button onclick="deleteBreak('${day}', '${breakType.toLowerCase()}')" class="delete-btn" style="background: #fd7e14; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function goBackToStep1() {
            document.getElementById('step1').style.display = 'block';
            document.getElementById('weeklyTemplate').style.display = 'none';
            document.getElementById('yearlyCalendar').style.display = 'none';
        }

        // PERIOD MANAGEMENT FUNCTIONS
        function addNewPeriod(day) {
            const periodsContainer = document.getElementById(`${day}_periods`);
            const currentPeriods = periodsContainer.querySelectorAll('.period-row').length;
            const newPeriodNumber = currentPeriods + 1;
            
            // Get available subjects
            const subjects = JSON.parse(localStorage.getItem('selectedSubjects') || '["English", "Math", "Urdu", "Islamiyat", "Science", "Social Studies", "General Knowledge"]');
            
            const newPeriodHTML = createEditablePeriod(day, newPeriodNumber, '14:20', '15:00', subjects);
            periodsContainer.innerHTML += newPeriodHTML;
            
            alert(`‚úÖ New period added to ${day}!`);
        }

        function deletePeriod(day, periodNumber) {
            if (confirm(`Delete Period ${periodNumber} from ${day}?`)) {
                const periodContainer = document.getElementById(`${day}_period${periodNumber}_container`);
                if (periodContainer) {
                    periodContainer.remove();
                    alert(`‚úÖ Period ${periodNumber} deleted from ${day}!`);
                }
            }
        }

        function duplicatePeriod(day, periodNumber) {
            const originalPeriod = document.getElementById(`${day}_period${periodNumber}_container`);
            if (originalPeriod) {
                const periodsContainer = document.getElementById(`${day}_periods`);
                const allPeriods = periodsContainer.querySelectorAll('.period-row').length;
                const newPeriodNumber = allPeriods + 1;
                
                // Get original values
                const startTime = document.getElementById(`${day}_period${periodNumber}_start`).value;
                const endTime = document.getElementById(`${day}_period${periodNumber}_end`).value;
                const subject = document.getElementById(`${day}_period${periodNumber}_subject`).value;
                
                // Create duplicate
                const subjects = JSON.parse(localStorage.getItem('selectedSubjects') || '["English", "Math", "Urdu", "Islamiyat", "Science", "Social Studies", "General Knowledge"]');
                const duplicateHTML = createEditablePeriod(day, newPeriodNumber, startTime, endTime, subjects);
                periodsContainer.innerHTML += duplicateHTML;
                
                // Set the subject
                setTimeout(() => {
                    if (subject) {
                        document.getElementById(`${day}_period${newPeriodNumber}_subject`).value = subject;
                    }
                }, 100);
                
                alert(`‚úÖ Period duplicated on ${day}!`);
            }
        }

        function deleteBreak(day, breakType) {
            if (confirm(`Delete ${breakType} time from ${day}?`)) {
                const breakContainer = document.getElementById(`${day}_${breakType}_container`);
                if (breakContainer) {
                    breakContainer.remove();
                    alert(`‚úÖ ${breakType} deleted from ${day}!`);
                }
            }
        }

        function resetDaySchedule(day) {
            if (confirm(`Reset entire ${day} schedule to default?`)) {
                const subjects = JSON.parse(localStorage.getItem('selectedSubjects') || '["English", "Math", "Urdu"]');
                const periodsContainer = document.getElementById(`${day}_periods`);
                
                periodsContainer.innerHTML = `
                    ${createEditablePeriod(day, 1, '08:00', '08:40', subjects)}
                    ${createEditablePeriod(day, 2, '08:40', '09:20', subjects)}
                    ${createEditablePeriod(day, 3, '9:20', '10:00', subjects)}
                    ${createEditableBreak(day, '10:00', '10:20')}
                    ${createEditablePeriod(day, 4, '10:20', '11:00', subjects)}
                    ${createEditablePeriod(day, 5, '11:00', '11:40', subjects)}
                    ${createEditablePeriod(day, 6, '11:40', '12:20', subjects)}
                    ${createEditablePeriod(day, 7, '12:20', '13:00', subjects)}
                    ${createEditableBreak(day, '13:00', '13:40', 'Lunch')}
                    ${createEditablePeriod(day, 8, '13:40', '14:20', subjects)}
                `;
                
                alert(`‚úÖ ${day} schedule reset to default!`);
            }
        }

        // QUICK ACTIONS FUNCTIONS
        function addQuickActionsToolbar() {
            return `
                <div class="quick-actions" style="background: #e9ecef; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #dee2e6;">
                    <h5 style="margin-bottom: 10px; color: #495057;">‚ö° Quick Actions:</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="addBreakToAllDays()" class="quick-btn" style="background: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">üïê Add Break to All Days</button>
                        <button onclick="addPeriodToAllDays()" class="quick-btn" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">‚ûï Add Period to All Days</button>
                        <button onclick="copyMondayToAll()" class="quick-btn" style="background: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">üìã Copy Monday to All Days</button>
                        <button onclick="clearAllSchedules()" class="quick-btn" style="background: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">üóëÔ∏è Clear All Schedules</button>
                    </div>
                </div>
            `;
        }

        function addPeriodToAllDays() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            days.forEach(day => addNewPeriod(day));
            alert('‚úÖ New period added to all days!');
        }

        function addBreakToAllDays() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            days.forEach(day => {
                const periodsContainer = document.getElementById(`${day}_periods`);
                const newBreakHTML = createEditableBreak(day, '3:00', '3:15', 'Evening');
                periodsContainer.innerHTML += newBreakHTML;
            });
            alert('‚úÖ Evening break added to all days!');
        }

        function copyMondayToAll() {
            if (confirm('Copy Monday schedule to all other days?')) {
                const mondayPeriods = document.querySelectorAll('#Monday_periods .period-row');
                const mondayBreaks = document.querySelectorAll('#Monday_periods .break-row');
                const subjects = JSON.parse(localStorage.getItem('selectedSubjects') || '["English", "Math", "Urdu"]');
                
                const days = ['Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                
                days.forEach(day => {
                    const dayContainer = document.getElementById(`${day}_periods`);
                    
                    // Copy all periods from Monday
                    let newHTML = '';
                    mondayPeriods.forEach((period, index) => {
                        const periodNum = index + 1;
                        const startTime = document.getElementById(`Monday_period${periodNum}_start`)?.value || '08:00';
                        const endTime = document.getElementById(`Monday_period${periodNum}_end`)?.value || '08:40';
                        const subject = document.getElementById(`Monday_period${periodNum}_subject`)?.value || '';
                        
                        newHTML += createEditablePeriod(day, periodNum, startTime, endTime, subjects);
                    });
                    
                    // Copy breaks from Monday
                    mondayBreaks.forEach(breakEl => {
                        const breakId = breakEl.id.split('_')[1]; // get break type
                        const startTime = document.getElementById(`Monday_${breakId}_start`)?.value || '10:00';
                        const endTime = document.getElementById(`Monday_${breakId}_end`)?.value || '10:20';
                        const breakType = breakId.charAt(0).toUpperCase() + breakId.slice(1);
                        
                        newHTML += createEditableBreak(day, startTime, endTime, breakType);
                    });
                    
                    dayContainer.innerHTML = newHTML;
                    
                    // Set subject values after DOM update
                    setTimeout(() => {
                        mondayPeriods.forEach((period, index) => {
                            const periodNum = index + 1;
                            const subject = document.getElementById(`Monday_period${periodNum}_subject`)?.value;
                            if (subject) {
                                const daySubjectSelect = document.getElementById(`${day}_period${periodNum}_subject`);
                                if (daySubjectSelect) {
                                    daySubjectSelect.value = subject;
                                }
                            }
                        });
                    }, 100);
                });
                
                alert('‚úÖ Monday schedule copied to all days!');
            }
        }

        function clearAllSchedules() {
            if (confirm('Clear all schedules? This will remove all periods and breaks from all days.')) {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                days.forEach(day => {
                    const dayContainer = document.getElementById(`${day}_periods`);
                    dayContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6c757d;">No periods scheduled</p>';
                });
                alert('‚úÖ All schedules cleared!');
            }
        }

        // STEP 3 - COPY TO ENTIRE YEAR (ENHANCED)
        function copyToYear() {
            const weeklySchedule = {};
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            days.forEach(day => {
                const daySchedule = {
                    periods: [],
                    breaks: []
                };
                
                // Get all periods for this day
                const periodRows = document.querySelectorAll(`#${day}_periods .period-row`);
                periodRows.forEach((row, index) => {
                    const periodNum = index + 1;
                    const startTimeEl = document.getElementById(`${day}_period${periodNum}_start`);
                    const endTimeEl = document.getElementById(`${day}_period${periodNum}_end`);
                    const subjectEl = document.getElementById(`${day}_period${periodNum}_subject`);
                    
                    if (startTimeEl && endTimeEl) {
                        const startTime = startTimeEl.value;
                        const endTime = endTimeEl.value;
                        const subject = subjectEl ? subjectEl.value : '';
                        
                        if (startTime && endTime) {
                            daySchedule.periods.push({
                                number: periodNum,
                                startTime: startTime,
                                endTime: endTime,
                                subject: subject || 'Free Period'
                            });
                        }
                    }
                });
                
                // Get break times
                const breakRows = document.querySelectorAll(`#${day}_periods .break-row`);
                breakRows.forEach(breakRow => {
                    const breakId = breakRow.id.split('_')[1]; // get break type
                    const startTimeEl = document.getElementById(`${day}_${breakId}_start`);
                    const endTimeEl = document.getElementById(`${day}_${breakId}_end`);
                    
                    if (startTimeEl && endTimeEl) {
                        const startTime = startTimeEl.value;
                        const endTime = endTimeEl.value;
                        const breakType = breakId.charAt(0).toUpperCase() + breakId.slice(1);
                        
                        if (startTime && endTime) {
                            daySchedule.breaks.push({ 
                                type: breakType, 
                                start: startTime, 
                                end: endTime 
                            });
                        }
                    }
                });
                
                weeklySchedule[day] = daySchedule;
            });
            
            // Get grade and subjects info
            const selectedGrade = document.getElementById('teacherGrade').value;
            const selectedSubjects = JSON.parse(localStorage.getItem('selectedSubjects') || '[]');
            
            // Save complete schedule
            localStorage.setItem('yearlyPlan', JSON.stringify({
                grade: selectedGrade,
                subjects: selectedSubjects,
                schedule: weeklySchedule,
                createdDate: new Date().toISOString()
            }));
            
            const totalPeriods = Object.values(weeklySchedule).reduce((total, day) => total + day.periods.length, 0);
            alert(`‚úÖ Complete schedule with ${Object.keys(weeklySchedule).length} days and ${totalPeriods} total periods copied to entire year!`);
            
            showYearlyCalendar();
        }

        function showYearlyCalendar() {
            // Hide other steps
            document.getElementById('step1').style.display = 'none';
            document.getElementById('weeklyTemplate').style.display = 'none';
            
            // Show yearly calendar
            const calendarDiv = document.getElementById('yearlyCalendar');
            calendarDiv.style.display = 'block';
            
            const savedPlan = JSON.parse(localStorage.getItem('yearlyPlan'));
            
            calendarDiv.innerHTML = `
                <div class="yearly-calendar">
                    <h3>üìÖ Your Yearly Schedule</h3>
                    <p class="plan-info">Grade ${savedPlan.grade} | Subjects: ${savedPlan.subjects.join(', ')}</p>
                    <p class="calendar-instruction">Click any week to edit individual days:</p>
                    
                    <div class="calendar-grid">
                        ${generateWeekButtons()}
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="goBackToStep1()" class="btn btn-secondary">‚Üê Start Over</button>
                        <button onclick="downloadSchedule()" class="btn btn-primary">üìÑ Download Schedule</button>
                    </div>
                </div>
            `;
        }

        function generateWeekButtons() {
            let weekButtons = '';
            for (let week = 1; week <= 52; week++) {
                weekButtons += `<div class="week-button" onclick="editWeek(${week})">Week ${week} ‚úèÔ∏è</div>`;
            }
            return weekButtons;
        }

        // WORKING editWeek function
        function editWeek(weekNumber) {
            console.log(`Opening Week ${weekNumber} editor`);
            
            // Get current plan and any saved week overrides
            const yearlyPlan = JSON.parse(localStorage.getItem('yearlyPlan') || '{}');
            const baseSchedule = yearlyPlan.schedule || {};
            const savedWeekData = JSON.parse(localStorage.getItem(`week_${weekNumber}_plan`) || '{}');
            
            // Merge base schedule with saved week overrides
            const weekSchedule = {};
            ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
                weekSchedule[day] = savedWeekData[day] || baseSchedule[day] || {};
            });
            
            // Hide other sections
            document.getElementById('step1').style.display = 'none';
            document.getElementById('weeklyTemplate').style.display = 'none';
            document.getElementById('yearlyCalendar').style.display = 'none';
            
            // Create working week editor
            const weekEditor = `
                <div class="week-editor-container" style="padding: 20px;">
                    <h2>üìù Edit Week ${weekNumber}</h2>
                    <button onclick="showYearlyCalendar()" class="back-btn" style="background: #007bff; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">
                        ‚¨ÖÔ∏è Back to Calendar
                    </button>
                    
                    <div class="edit-days">
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => 
                            createEditableDay(day, weekSchedule[day] || {}, weekNumber)
                        ).join('')}
                    </div>
                    
                    <button onclick="saveWeekEdits(${weekNumber})" style="background: green; color: white; padding: 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                        üíæ Save Week ${weekNumber} Changes
                    </button>
                </div>
            `;
            
            document.querySelector('.planner-container').innerHTML = weekEditor;
        }
        
        function createEditableDay(day, dayData, weekNumber) {
            // Handle both old format (period1, period2, etc.) and new format (periods array)
            const periodsData = dayData.periods || [];
            const breaksData = dayData.breaks || [];
            
            // Convert old format to new format if needed
            if (dayData.period1 && !dayData.periods) {
                for (let i = 1; i <= 8; i++) {
                    if (dayData[`period${i}`]) {
                        periodsData.push({
                            number: i,
                            startTime: getDefaultPeriodTime(i, 'start'),
                            endTime: getDefaultPeriodTime(i, 'end'),
                            subject: dayData[`period${i}`]
                        });
                    }
                }
                if (dayData.breakStart) {
                    breaksData.push({ type: 'Break', start: dayData.breakStart, end: dayData.breakEnd });
                }
            }
            
            // If no periods, use default 8-period structure
            if (periodsData.length === 0) {
                for (let i = 1; i <= 8; i++) {
                    periodsData.push({
                        number: i,
                        startTime: getDefaultPeriodTime(i, 'start'),
                        endTime: getDefaultPeriodTime(i, 'end'),
                        subject: ''
                    });
                }
                breaksData.push(
                    { type: 'Break', start: '10:00', end: '10:20' },
                    { type: 'Lunch', start: '13:00', end: '13:40' }
                );
            }
            
            return `
                <div class="editable-day" style="border: 2px solid #333; margin: 10px; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                    <h3>${day} - Week ${weekNumber}</h3>
                    
                    <div class="enhanced-period-editor">
                        <div class="period-header" style="margin-bottom: 15px;">
                            <button onclick="addNewPeriodToWeekDay('${day}', ${weekNumber})" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">‚ûï Add Period</button>
                            <button onclick="resetWeekDaySchedule('${day}', ${weekNumber})" style="background: #ffc107; color: black; padding: 8px 12px; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">üîÑ Reset Day</button>
                        </div>
                        
                        <div id="edit_${weekNumber}_${day}_periods_container">
                            ${periodsData.map(period => `
                                <div class="edit-period-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                                    <div style="flex: 1;">
                                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Period ${period.number}:</label>
                                        
                                        <div style="margin: 5px 0;">
                                            <input type="time" id="edit_${weekNumber}_${day}_period${period.number}_start" value="${period.startTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                            <span style="margin: 0 5px;">to</span>
                                            <input type="time" id="edit_${weekNumber}_${day}_period${period.number}_end" value="${period.endTime}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                        </div>
                                        
                                        <select id="edit_${weekNumber}_${day}_period${period.number}_subject" style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                            <option value="">Select Subject</option>
                                            <option value="English" ${period.subject === 'English' ? 'selected' : ''}>English</option>
                                            <option value="Math" ${period.subject === 'Math' ? 'selected' : ''}>Math</option>
                                            <option value="Urdu" ${period.subject === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                            <option value="Science" ${period.subject === 'Science' ? 'selected' : ''}>Science</option>
                                            <option value="Islamiyat" ${period.subject === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                            <option value="Social Studies" ${period.subject === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                            <option value="General Knowledge" ${period.subject === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 5px;">
                                        <button onclick="deleteWeekPeriod('${day}', ${weekNumber}, ${period.number})" style="background: #dc3545; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                                        <button onclick="duplicateWeekPeriod('${day}', ${weekNumber}, ${period.number})" style="background: #007bff; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã</button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${breaksData.map(breakItem => `
                                <div class="edit-break-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7;">
                                    <div style="flex: 1;">
                                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">${breakItem.type} Time:</label>
                                        
                                        <div style="margin: 5px 0;">
                                            <input type="time" id="edit_${weekNumber}_${day}_${breakItem.type.toLowerCase()}_start" value="${breakItem.start}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                            <span style="margin: 0 5px;">to</span>
                                            <input type="time" id="edit_${weekNumber}_${day}_${breakItem.type.toLowerCase()}_end" value="${breakItem.end}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <button onclick="deleteWeekBreak('${day}', ${weekNumber}, '${breakItem.type.toLowerCase()}')" style="background: #fd7e14; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getDefaultPeriodTime(periodNumber, type) {
            const times = {
                1: { start: '08:00', end: '08:40' },
                2: { start: '08:40', end: '09:20' },
                3: { start: '09:20', end: '10:00' },
                4: { start: '10:20', end: '11:00' },
                5: { start: '11:00', end: '11:40' },
                6: { start: '11:40', end: '12:20' },
                7: { start: '12:20', end: '13:00' },
                8: { start: '13:40', end: '14:20' }
            };
            return times[periodNumber] ? times[periodNumber][type] : '08:00';
        }
        
        // Additional functions for week editing
        function addNewPeriodToWeekDay(day, weekNumber) {
            const container = document.getElementById(`edit_${weekNumber}_${day}_periods_container`);
            const currentPeriods = container.querySelectorAll('.edit-period-row').length;
            const newPeriodNumber = currentPeriods + 1;
            
            const newPeriodHTML = `
                <div class="edit-period-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    <div style="flex: 1;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">Period ${newPeriodNumber}:</label>
                        
                        <div style="margin: 5px 0;">
                            <input type="time" id="edit_${weekNumber}_${day}_period${newPeriodNumber}_start" value="14:20" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            <span style="margin: 0 5px;">to</span>
                            <input type="time" id="edit_${weekNumber}_${day}_period${newPeriodNumber}_end" value="15:00" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        </div>
                        
                        <select id="edit_${weekNumber}_${day}_period${newPeriodNumber}_subject" style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            <option value="">Select Subject</option>
                            <option value="English">English</option>
                            <option value="Math">Math</option>
                            <option value="Urdu">Urdu</option>
                            <option value="Science">Science</option>
                            <option value="Islamiyat">Islamiyat</option>
                            <option value="Social Studies">Social Studies</option>
                            <option value="General Knowledge">General Knowledge</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="deleteWeekPeriod('${day}', ${weekNumber}, ${newPeriodNumber})" style="background: #dc3545; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        <button onclick="duplicateWeekPeriod('${day}', ${weekNumber}, ${newPeriodNumber})" style="background: #007bff; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã</button>
                    </div>
                </div>
            `;
            
            container.innerHTML += newPeriodHTML;
            alert(`‚úÖ New period added to ${day}!`);
        }
        
        function deleteWeekPeriod(day, weekNumber, periodNumber) {
            if (confirm(`Delete Period ${periodNumber} from ${day}?`)) {
                const periodRow = document.querySelector(`#edit_${weekNumber}_${day}_periods_container .edit-period-row:nth-child(${periodNumber})`);
                if (periodRow) {
                    periodRow.remove();
                    alert(`‚úÖ Period ${periodNumber} deleted!`);
                }
            }
        }
        
        function duplicateWeekPeriod(day, weekNumber, periodNumber) {
            const startTimeEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNumber}_start`);
            const endTimeEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNumber}_end`);
            const subjectEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNumber}_subject`);
            
            if (startTimeEl && endTimeEl && subjectEl) {
                const container = document.getElementById(`edit_${weekNumber}_${day}_periods_container`);
                const currentPeriods = container.querySelectorAll('.edit-period-row').length;
                const newPeriodNumber = currentPeriods + 1;
                
                const newPeriodHTML = `
                    <div class="edit-period-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                        <div style="flex: 1;">
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Period ${newPeriodNumber}:</label>
                            
                            <div style="margin: 5px 0;">
                                <input type="time" id="edit_${weekNumber}_${day}_period${newPeriodNumber}_start" value="${startTimeEl.value}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                <span style="margin: 0 5px;">to</span>
                                <input type="time" id="edit_${weekNumber}_${day}_period${newPeriodNumber}_end" value="${endTimeEl.value}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                            
                            <select id="edit_${weekNumber}_${day}_period${newPeriodNumber}_subject" style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${subjectEl.value === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${subjectEl.value === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${subjectEl.value === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${subjectEl.value === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${subjectEl.value === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${subjectEl.value === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${subjectEl.value === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="deleteWeekPeriod('${day}', ${weekNumber}, ${newPeriodNumber})" style="background: #dc3545; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                            <button onclick="duplicateWeekPeriod('${day}', ${weekNumber}, ${newPeriodNumber})" style="background: #007bff; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã</button>
                        </div>
                    </div>
                `;
                
                container.innerHTML += newPeriodHTML;
                alert(`‚úÖ Period duplicated on ${day}!`);
            }
        }
        
        function deleteWeekBreak(day, weekNumber, breakType) {
            if (confirm(`Delete ${breakType} time from ${day}?`)) {
                const breakRow = document.querySelector(`#edit_${weekNumber}_${day}_periods_container .edit-break-row`);
                if (breakRow) {
                    breakRow.remove();
                    alert(`‚úÖ ${breakType} break deleted!`);
                }
            }
        }
        
        function resetWeekDaySchedule(day, weekNumber) {
            if (confirm(`Reset ${day} schedule to default 8-period structure?`)) {
                const container = document.getElementById(`edit_${weekNumber}_${day}_periods_container`);
                
                let resetHTML = '';
                for (let i = 1; i <= 8; i++) {
                    const times = getDefaultPeriodTime(i);
                    resetHTML += `
                        <div class="edit-period-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div style="flex: 1;">
                                <label style="font-weight: bold; margin-bottom: 5px; display: block;">Period ${i}:</label>
                                
                                <div style="margin: 5px 0;">
                                    <input type="time" id="edit_${weekNumber}_${day}_period${i}_start" value="${times.start}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                    <span style="margin: 0 5px;">to</span>
                                    <input type="time" id="edit_${weekNumber}_${day}_period${i}_end" value="${times.end}" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                </div>
                                
                                <select id="edit_${weekNumber}_${day}_period${i}_subject" style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                    <option value="">Select Subject</option>
                                    <option value="English">English</option>
                                    <option value="Math">Math</option>
                                    <option value="Urdu">Urdu</option>
                                    <option value="Science">Science</option>
                                    <option value="Islamiyat">Islamiyat</option>
                                    <option value="Social Studies">Social Studies</option>
                                    <option value="General Knowledge">General Knowledge</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <button onclick="deleteWeekPeriod('${day}', ${weekNumber}, ${i})" style="background: #dc3545; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                                <button onclick="duplicateWeekPeriod('${day}', ${weekNumber}, ${i})" style="background: #007bff; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã</button>
                            </div>
                        </div>
                    `;
                }
                
                // Add default breaks
                resetHTML += `
                    <div class="edit-break-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7;">
                        <div style="flex: 1;">
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Break Time:</label>
                            
                            <div style="margin: 5px 0;">
                                <input type="time" id="edit_${weekNumber}_${day}_break_start" value="10:00" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                <span style="margin: 0 5px;">to</span>
                                <input type="time" id="edit_${weekNumber}_${day}_break_end" value="10:20" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                        </div>
                        
                        <div>
                            <button onclick="deleteWeekBreak('${day}', ${weekNumber}, 'break')" style="background: #fd7e14; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="edit-break-row" style="display: flex; align-items: center; margin: 8px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7;">
                        <div style="flex: 1;">
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Lunch Time:</label>
                            
                            <div style="margin: 5px 0;">
                                <input type="time" id="edit_${weekNumber}_${day}_lunch_start" value="13:00" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                                <span style="margin: 0 5px;">to</span>
                                <input type="time" id="edit_${weekNumber}_${day}_lunch_end" value="13:40" style="margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                            </div>
                        </div>
                        
                        <div>
                            <button onclick="deleteWeekBreak('${day}', ${weekNumber}, 'lunch')" style="background: #fd7e14; color: white; padding: 5px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = resetHTML;
                alert(`‚úÖ ${day} schedule reset to default 8-period structure!`);
            }
        }
                        
        }
        
        function saveWeekEdits(weekNumber) {
            console.log(`Saving Week ${weekNumber} edits`);
            
            const editedWeek = {};
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            days.forEach(day => {
                const daySchedule = {
                    periods: [],
                    breaks: []
                };
                
                // Get all periods for this day
                const periodRows = document.querySelectorAll(`#edit_${weekNumber}_${day}_periods_container .edit-period-row`);
                periodRows.forEach((row, index) => {
                    const periodNum = index + 1;
                    const startTimeEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNum}_start`);
                    const endTimeEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNum}_end`);
                    const subjectEl = document.getElementById(`edit_${weekNumber}_${day}_period${periodNum}_subject`);
                    
                    if (startTimeEl && endTimeEl) {
                        const startTime = startTimeEl.value;
                        const endTime = endTimeEl.value;
                        const subject = subjectEl ? subjectEl.value : '';
                        
                        if (startTime && endTime) {
                            daySchedule.periods.push({
                                number: periodNum,
                                startTime: startTime,
                                endTime: endTime,
                                subject: subject || 'Free Period'
                            });
                        }
                    }
                });
                
                // Get break times
                const breakRows = document.querySelectorAll(`#edit_${weekNumber}_${day}_periods_container .edit-break-row`);
                breakRows.forEach(breakRow => {
                    const inputs = breakRow.querySelectorAll('input[type="time"]');
                    if (inputs.length >= 2) {
                        const startTime = inputs[0].value;
                        const endTime = inputs[1].value;
                        const label = breakRow.querySelector('label').textContent;
                        const breakType = label.replace(' Time:', '');
                        
                        if (startTime && endTime) {
                            daySchedule.breaks.push({ 
                                type: breakType, 
                                start: startTime, 
                                end: endTime 
                            });
                        }
                    }
                });
                
                editedWeek[day] = daySchedule;
            });
            
            // Save this specific week
            localStorage.setItem(`week_${weekNumber}_plan`, JSON.stringify(editedWeek));
            
            const totalPeriods = Object.values(editedWeek).reduce((total, day) => total + day.periods.length, 0);
            alert(`‚úÖ Week ${weekNumber} saved successfully with ${totalPeriods} total periods!`);
            
            // Show yearly calendar
            showYearlyCalendar();
        }

        function formatScheduleForDisplay(schedule) {
            let display = '';
            Object.keys(schedule).forEach(day => {
                display += `\\n${day}:\\n`;
                Object.keys(schedule[day]).forEach(period => {
                    if (schedule[day][period]) {
                        display += `  ${period}: ${schedule[day][period]}\\n`;
                    }
                });
            });
            return display;
        }

        function downloadSchedule() {
            downloadYearlyPlan();
        }
        
        // Add PDF generation functionality
        function downloadYearlyPlan() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get saved plan
            const yearlyPlan = JSON.parse(localStorage.getItem('yearlyPlan') || '{}');
            const schedule = yearlyPlan.schedule || {};
            
            if (!yearlyPlan.grade) {
                alert('No yearly plan found! Please create a plan first.');
                return;
            }
            
            // Generate PDF content
            doc.setFontSize(20);
            doc.text('Yearly Teaching Plan', 20, 30);
            
            doc.setFontSize(14);
            doc.text(`Grade: ${yearlyPlan.grade}`, 20, 45);
            doc.text(`Subjects: ${yearlyPlan.subjects.join(', ')}`, 20, 55);
            doc.text(`Created: ${new Date(yearlyPlan.createdDate).toLocaleDateString()}`, 20, 65);
            
            doc.setFontSize(12);
            let yPosition = 85;
            
            Object.keys(schedule).forEach(day => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`${day}:`, 20, yPosition);
                doc.setFont(undefined, 'normal');
                
                doc.text(`Period 1 (8:00-8:40): ${schedule[day].period1 || 'Not assigned'}`, 30, yPosition + 10);
                doc.text(`Period 2 (8:40-9:20): ${schedule[day].period2 || 'Not assigned'}`, 30, yPosition + 20);
                doc.text(`Period 3 (9:20-10:00): ${schedule[day].period3 || 'Not assigned'}`, 30, yPosition + 30);
                doc.text(`Break: ${schedule[day].breakStart || '10:00'} - ${schedule[day].breakEnd || '10:20'}`, 30, yPosition + 40);
                doc.text(`Period 4 (After Break): ${schedule[day].period4 || 'Not assigned'}`, 30, yPosition + 50);
                doc.text(`Period 5 (Last Period): ${schedule[day].period5 || 'Not assigned'}`, 30, yPosition + 60);
                
                yPosition += 80;
            });
            
            // Download PDF
            doc.save(`Yearly_Teaching_Plan_Grade_${yearlyPlan.grade}.pdf`);
            alert('‚úÖ Yearly plan downloaded as PDF!');
        }

        // Load existing plan if available
        document.addEventListener('DOMContentLoaded', function() {
            const savedPlan = localStorage.getItem('yearlyPlan');
            if (savedPlan) {
                const planData = JSON.parse(savedPlan);
                
                // Add a "View Existing Plan" button
                const welcomeSection = document.querySelector('.welcome-section');
                welcomeSection.innerHTML += `
                    <div class="existing-plan-notice">
                        <p>üìã You have an existing yearly plan for Grade ${planData.grade}</p>
                        <button onclick="showYearlyCalendar()" class="btn btn-success">View Your Schedule</button>
                        <button onclick="clearPlan()" class="btn btn-secondary">Start Fresh</button>
                    </div>
                `;
            }
        });

        function clearPlan() {
            if (confirm('Are you sure you want to delete your existing yearly plan and start fresh?')) {
                localStorage.removeItem('yearlyPlan');
                location.reload();
            }
        }
    </script>
    
    <style>
        :root {
            --soft-blue: #6c9bd1;
            --sage-green: #9cbc88;
            --warm-pink: #f4a6cd;
            --sunny-yellow: #ffd93d;
            --lavender: #b19cd9;
            --mint-green: #98e4d6;
            --peach: #ffab91;
            --light-gray: #f5f5f5;
            --border-gray: #e0e0e0;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--soft-blue), var(--sage-green));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .nav-title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .nav-welcome {
            font-weight: 500;
        }
        
        .logout-link {
            background-color: rgba(255,255,255,0.2);
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .planner-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .welcome-section h1 {
            color: var(--soft-blue);
            margin-bottom: 0.5rem;
        }
        
        .welcome-subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .step-1 {
            background: var(--light-gray);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .step-1 h3 {
            color: var(--sage-green);
            margin-bottom: 1.5rem;
        }
        
        .selection-area {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--soft-blue);
        }
        
        .subject-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .checkbox-label:hover {
            background: var(--mint-green);
        }
        
        .checkbox-label input {
            margin-right: 0.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--soft-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a87c4;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--border-gray);
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .btn-success {
            background: var(--sage-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #8aaa76;
            transform: translateY(-2px);
        }
        
        .next-btn {
            width: 100%;
            margin-top: 1rem;
        }
        
        .weekly-schedule {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .day-schedule {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .day-schedule h4 {
            color: var(--sage-green);
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: var(--light-gray);
            border-radius: 6px;
        }
        
        .periods {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .period-slot {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .period-slot label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }
        
        .period-select {
            padding: 0.5rem;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .break-time {
            text-align: center;
            padding: 0.5rem;
            background: var(--peach);
            border-radius: 6px;
            margin: 0.5rem 0;
        }
        
        .break-time p {
            margin: 0;
            font-weight: 500;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .grade-subjects-info {
            text-align: center;
            background: var(--mint-green);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        
        .yearly-calendar {
            background: var(--light-gray);
            padding: 2rem;
            border-radius: 12px;
        }
        
        .yearly-calendar h3 {
            color: var(--sage-green);
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .plan-info {
            text-align: center;
            background: var(--sunny-yellow);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .calendar-instruction {
            text-align: center;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }
        
        .week-button {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .week-button:hover {
            background: var(--soft-blue);
            color: white;
            transform: translateY(-2px);
        }
        
        .existing-plan-notice {
            background: var(--warm-pink);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }
        
        .existing-plan-notice p {
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .existing-plan-notice .btn {
            margin: 0 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: var(--mint-green);
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0 1rem;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .weekly-schedule {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>