<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yearly Planner - USTAAD DOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]);var n=t;if("undefined"!=typeof e){for(var p=0;p<o.length-1;p++)n[o[p]]=n[o[p]]||{},n=n[o[p]];n[o[o.length-1]]=i}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getGroups create_alias get_distinct_id get_session_id capture_pageview capture_pageleave register_for_session unregister_for_session".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        
        // Initialize PostHog with delay to ensure script loads
        setTimeout(function() {
            try {
                if (typeof posthog !== 'undefined' && posthog.init) {
                    posthog.init('{{ posthog_key }}', {
                        api_host: '{{ posthog_host }}'
                    });
                    console.log('PostHog initialized successfully');
                } else {
                    throw new Error('PostHog not loaded');
                }
            } catch (error) {
                console.log('PostHog initialization failed:', error);
                window.posthog = {
                    capture: function() { console.log('PostHog tracking:', arguments); },
                    identify: function() { console.log('PostHog identify:', arguments); }
                };
            }
        }, 1000);
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üìÖ Yearly Planner</h1>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">üè† Dashboard</a>
                <a href="{{ url_for('grading_buddy') }}" class="nav-link">üìä Grading Buddy</a>
                <a href="{{ url_for('chatbot') }}" class="nav-link">ü§ñ U-Dost Chat</a>
                <span class="nav-welcome">Welcome, {{ session.user_name }}!</span>
                <a href="#" onclick="logout()" class="nav-link logout-link">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="planner-container">
            <div class="welcome-section">
                <h1>üìÖ Yearly Planner</h1>
                <p class="welcome-subtitle">Create your teaching schedule in 3 simple steps</p>
            </div>
            
            <!-- Step 1: Select Teaching Details -->
            <div class="step-1" id="step1">
                <h3>Step 1: Select Your Teaching Details</h3>
                
                <div class="selection-area">
                    <div class="form-group">
                        <label for="teacherGrade">Select Grade:</label>
                        <select id="teacherGrade" class="form-control">
                            <option value="">Choose Grade</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Your Subjects:</label>
                        <div class="subject-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="english" value="English"> English
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="math" value="Math"> Math
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="urdu" value="Urdu"> Urdu
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="islamiyat" value="Islamiyat"> Islamiyat
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="science" value="Science"> Science
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="social" value="Social Studies"> Social Studies
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="gk" value="General Knowledge"> General Knowledge
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="createWeeklyTemplate()" class="btn btn-primary next-btn">Create Weekly Template</button>
                </div>
            </div>
            
            <!-- Step 2: Weekly Template (Hidden initially) -->
            <div id="weeklyTemplate" style="display:none;"></div>
            
            <!-- Step 3: Yearly Calendar (Hidden initially) -->
            <div id="yearlyCalendar" style="display:none;"></div>
        </div>
    </main>

    <script>
        // Common session management function
        function getCurrentUser() {
            const savedUser = localStorage.getItem('ustaadDostUser');
            return savedUser ? JSON.parse(savedUser) : null;
        }
        
        function logout() {
            console.log("Logging out user..."); // Debug log
            localStorage.removeItem('ustaadDostUser');
            sessionStorage.clear();
            console.log("Local session data cleared"); // Debug log
            window.location.href = '/logout';
        }
        
        // STEP 2 - WEEKLY TEMPLATE CREATION
        function createWeeklyTemplate() {
            const selectedGrade = document.getElementById('teacherGrade').value;
            const selectedSubjects = [];
            
            // Get selected subjects
            const checkboxes = document.querySelectorAll('.subject-checkboxes input:checked');
            checkboxes.forEach(cb => selectedSubjects.push(cb.value));
            
            if (!selectedGrade || selectedSubjects.length === 0) {
                alert('Please select grade and at least one subject!');
                return;
            }
            
            // Hide step 1
            document.getElementById('step1').style.display = 'none';
            
            // Show weekly template builder
            const templateDiv = document.getElementById('weeklyTemplate');
            templateDiv.style.display = 'block';
            templateDiv.innerHTML = `
                <h3>Step 2: Create Your Weekly Schedule</h3>
                <p class="grade-subjects-info">Grade: ${selectedGrade} | Subjects: ${selectedSubjects.join(', ')}</p>
                
                <div class="weekly-schedule">
                    ${createDaySchedule('Monday', selectedSubjects)}
                    ${createDaySchedule('Tuesday', selectedSubjects)}
                    ${createDaySchedule('Wednesday', selectedSubjects)}
                    ${createDaySchedule('Thursday', selectedSubjects)}
                    ${createDaySchedule('Friday', selectedSubjects)}
                </div>
                
                <div class="action-buttons">
                    <button onclick="goBackToStep1()" class="btn btn-secondary">‚Üê Back to Step 1</button>
                    <button onclick="copyToYear()" class="btn btn-success copy-btn">üìÖ Copy This Week to Entire Year</button>
                </div>
            `;
        }

        function createDaySchedule(day, subjects) {
            return `
                <div class="day-schedule" style="border: 1px solid #ccc; padding: 10px; margin: 10px;">
                    <h4>${day}</h4>
                    <div class="periods">
                        <div class="period-row">
                            <label>Period 1 (8:00-8:40):</label>
                            <select id="${day}_period1" style="width: 150px;">
                                <option value="">Select Subject</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="period-row">
                            <label>Period 2 (8:40-9:20):</label>
                            <select id="${day}_period2" style="width: 150px;">
                                <option value="">Select Subject</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="period-row">
                            <label>Period 3 (9:20-10:00):</label>
                            <select id="${day}_period3" style="width: 150px;">
                                <option value="">Select Subject</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- WORKING BREAK TIME EDITOR -->
                        <div class="break-time-editor" style="background: #f0f0f0; padding: 5px; margin: 5px 0;">
                            <label><strong>Break Time:</strong></label><br>
                            <label>Start:</label>
                            <input type="time" id="${day}_breakStart" value="10:00" style="margin: 2px;">
                            <label>End:</label>
                            <input type="time" id="${day}_breakEnd" value="10:20" style="margin: 2px;">
                        </div>
                        
                        <div class="period-row">
                            <label>Period 4 (After Break):</label>
                            <select id="${day}_period4" style="width: 150px;">
                                <option value="">Select Subject</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="period-row">
                            <label>Period 5 (Last Period):</label>
                            <select id="${day}_period5" style="width: 150px;">
                                <option value="">Select Subject</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function goBackToStep1() {
            document.getElementById('step1').style.display = 'block';
            document.getElementById('weeklyTemplate').style.display = 'none';
            document.getElementById('yearlyCalendar').style.display = 'none';
        }

        // STEP 3 - COPY TO ENTIRE YEAR
        function copyToYear() {
            // Get weekly schedule
            const weeklySchedule = {};
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            days.forEach(day => {
                weeklySchedule[day] = {
                    period1: document.getElementById(`${day}_period1`).value,
                    period2: document.getElementById(`${day}_period2`).value,
                    period3: document.getElementById(`${day}_period3`).value,
                    period4: document.getElementById(`${day}_period4`).value,
                    period5: document.getElementById(`${day}_period5`).value,
                    breakStart: document.getElementById(`${day}_breakStart`).value || '10:00',
                    breakEnd: document.getElementById(`${day}_breakEnd`).value || '10:20'
                };
            });
            
            // Get grade and subjects info
            const selectedGrade = document.getElementById('teacherGrade').value;
            const selectedSubjects = [];
            const checkboxes = document.querySelectorAll('.subject-checkboxes input:checked');
            checkboxes.forEach(cb => selectedSubjects.push(cb.value));
            
            // Save to storage
            localStorage.setItem('yearlyPlan', JSON.stringify({
                grade: selectedGrade,
                subjects: selectedSubjects,
                schedule: weeklySchedule,
                createdDate: new Date().toISOString()
            }));
            
            // Show success message
            alert('‚úÖ Weekly plan copied to entire year! You can edit any week individually.');
            
            // Show yearly calendar
            showYearlyCalendar();
        }

        function showYearlyCalendar() {
            // Hide other steps
            document.getElementById('step1').style.display = 'none';
            document.getElementById('weeklyTemplate').style.display = 'none';
            
            // Show yearly calendar
            const calendarDiv = document.getElementById('yearlyCalendar');
            calendarDiv.style.display = 'block';
            
            const savedPlan = JSON.parse(localStorage.getItem('yearlyPlan'));
            
            calendarDiv.innerHTML = `
                <div class="yearly-calendar">
                    <h3>üìÖ Your Yearly Schedule</h3>
                    <p class="plan-info">Grade ${savedPlan.grade} | Subjects: ${savedPlan.subjects.join(', ')}</p>
                    <p class="calendar-instruction">Click any week to edit individual days:</p>
                    
                    <div class="calendar-grid">
                        ${generateWeekButtons()}
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="goBackToStep1()" class="btn btn-secondary">‚Üê Start Over</button>
                        <button onclick="downloadSchedule()" class="btn btn-primary">üìÑ Download Schedule</button>
                    </div>
                </div>
            `;
        }

        function generateWeekButtons() {
            let weekButtons = '';
            for (let week = 1; week <= 52; week++) {
                weekButtons += `<div class="week-button" onclick="editWeek(${week})">Week ${week} ‚úèÔ∏è</div>`;
            }
            return weekButtons;
        }

        // WORKING editWeek function
        function editWeek(weekNumber) {
            console.log(`Opening Week ${weekNumber} editor`);
            
            // Get current plan and any saved week overrides
            const yearlyPlan = JSON.parse(localStorage.getItem('yearlyPlan') || '{}');
            const baseSchedule = yearlyPlan.schedule || {};
            const savedWeekData = JSON.parse(localStorage.getItem(`week_${weekNumber}_plan`) || '{}');
            
            // Merge base schedule with saved week overrides
            const weekSchedule = {};
            ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
                weekSchedule[day] = savedWeekData[day] || baseSchedule[day] || {};
            });
            
            // Hide other sections
            document.getElementById('step1').style.display = 'none';
            document.getElementById('weeklyTemplate').style.display = 'none';
            document.getElementById('yearlyCalendar').style.display = 'none';
            
            // Create working week editor
            const weekEditor = `
                <div class="week-editor-container" style="padding: 20px;">
                    <h2>üìù Edit Week ${weekNumber}</h2>
                    <button onclick="showYearlyCalendar()" class="back-btn" style="background: #007bff; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">
                        ‚¨ÖÔ∏è Back to Calendar
                    </button>
                    
                    <div class="edit-days">
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => 
                            createEditableDay(day, weekSchedule[day] || {}, weekNumber)
                        ).join('')}
                    </div>
                    
                    <button onclick="saveWeekEdits(${weekNumber})" style="background: green; color: white; padding: 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                        üíæ Save Week ${weekNumber} Changes
                    </button>
                </div>
            `;
            
            document.querySelector('.planner-container').innerHTML = weekEditor;
        }
        
        function createEditableDay(day, dayData, weekNumber) {
            return `
                <div class="editable-day" style="border: 2px solid #333; margin: 10px; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                    <h3>${day} - Week ${weekNumber}</h3>
                    
                    <div class="day-periods" style="display: grid; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="width: 120px; font-weight: bold;">Period 1:</label>
                            <select id="edit_${weekNumber}_${day}_period1" style="padding: 5px; width: 150px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${dayData.period1 === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${dayData.period1 === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${dayData.period1 === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${dayData.period1 === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${dayData.period1 === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${dayData.period1 === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${dayData.period1 === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="width: 120px; font-weight: bold;">Period 2:</label>
                            <select id="edit_${weekNumber}_${day}_period2" style="padding: 5px; width: 150px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${dayData.period2 === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${dayData.period2 === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${dayData.period2 === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${dayData.period2 === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${dayData.period2 === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${dayData.period2 === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${dayData.period2 === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="width: 120px; font-weight: bold;">Period 3:</label>
                            <select id="edit_${weekNumber}_${day}_period3" style="padding: 5px; width: 150px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${dayData.period3 === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${dayData.period3 === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${dayData.period3 === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${dayData.period3 === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${dayData.period3 === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${dayData.period3 === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${dayData.period3 === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                        
                        <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Break Time:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label>Start:</label>
                                <input type="time" id="edit_${weekNumber}_${day}_breakStart" value="${dayData.breakStart || '10:00'}" style="padding: 5px;">
                                <label>End:</label>
                                <input type="time" id="edit_${weekNumber}_${day}_breakEnd" value="${dayData.breakEnd || '10:20'}" style="padding: 5px;">
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="width: 120px; font-weight: bold;">Period 4:</label>
                            <select id="edit_${weekNumber}_${day}_period4" style="padding: 5px; width: 150px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${dayData.period4 === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${dayData.period4 === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${dayData.period4 === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${dayData.period4 === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${dayData.period4 === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${dayData.period4 === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${dayData.period4 === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="width: 120px; font-weight: bold;">Period 5:</label>
                            <select id="edit_${weekNumber}_${day}_period5" style="padding: 5px; width: 150px;">
                                <option value="">Select Subject</option>
                                <option value="English" ${dayData.period5 === 'English' ? 'selected' : ''}>English</option>
                                <option value="Math" ${dayData.period5 === 'Math' ? 'selected' : ''}>Math</option>
                                <option value="Urdu" ${dayData.period5 === 'Urdu' ? 'selected' : ''}>Urdu</option>
                                <option value="Science" ${dayData.period5 === 'Science' ? 'selected' : ''}>Science</option>
                                <option value="Islamiyat" ${dayData.period5 === 'Islamiyat' ? 'selected' : ''}>Islamiyat</option>
                                <option value="Social Studies" ${dayData.period5 === 'Social Studies' ? 'selected' : ''}>Social Studies</option>
                                <option value="General Knowledge" ${dayData.period5 === 'General Knowledge' ? 'selected' : ''}>General Knowledge</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function saveWeekEdits(weekNumber) {
            console.log(`Saving Week ${weekNumber} changes`);
            
            // Save individual week data
            const weekData = {};
            ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
                weekData[day] = {
                    period1: document.getElementById(`edit_${weekNumber}_${day}_period1`)?.value || '',
                    period2: document.getElementById(`edit_${weekNumber}_${day}_period2`)?.value || '',
                    period3: document.getElementById(`edit_${weekNumber}_${day}_period3`)?.value || '',
                    period4: document.getElementById(`edit_${weekNumber}_${day}_period4`)?.value || '',
                    period5: document.getElementById(`edit_${weekNumber}_${day}_period5`)?.value || '',
                    breakStart: document.getElementById(`edit_${weekNumber}_${day}_breakStart`)?.value || '10:00',
                    breakEnd: document.getElementById(`edit_${weekNumber}_${day}_breakEnd`)?.value || '10:20'
                };
            });
            
            // Save to localStorage
            localStorage.setItem(`week_${weekNumber}_plan`, JSON.stringify(weekData));
            
            alert(`‚úÖ Week ${weekNumber} saved successfully!`);
            showYearlyCalendar();
        }

        function formatScheduleForDisplay(schedule) {
            let display = '';
            Object.keys(schedule).forEach(day => {
                display += `\\n${day}:\\n`;
                Object.keys(schedule[day]).forEach(period => {
                    if (schedule[day][period]) {
                        display += `  ${period}: ${schedule[day][period]}\\n`;
                    }
                });
            });
            return display;
        }

        function downloadSchedule() {
            downloadYearlyPlan();
        }
        
        // Add PDF generation functionality
        function downloadYearlyPlan() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get saved plan
            const yearlyPlan = JSON.parse(localStorage.getItem('yearlyPlan') || '{}');
            const schedule = yearlyPlan.schedule || {};
            
            if (!yearlyPlan.grade) {
                alert('No yearly plan found! Please create a plan first.');
                return;
            }
            
            // Generate PDF content
            doc.setFontSize(20);
            doc.text('Yearly Teaching Plan', 20, 30);
            
            doc.setFontSize(14);
            doc.text(`Grade: ${yearlyPlan.grade}`, 20, 45);
            doc.text(`Subjects: ${yearlyPlan.subjects.join(', ')}`, 20, 55);
            doc.text(`Created: ${new Date(yearlyPlan.createdDate).toLocaleDateString()}`, 20, 65);
            
            doc.setFontSize(12);
            let yPosition = 85;
            
            Object.keys(schedule).forEach(day => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`${day}:`, 20, yPosition);
                doc.setFont(undefined, 'normal');
                
                doc.text(`Period 1 (8:00-8:40): ${schedule[day].period1 || 'Not assigned'}`, 30, yPosition + 10);
                doc.text(`Period 2 (8:40-9:20): ${schedule[day].period2 || 'Not assigned'}`, 30, yPosition + 20);
                doc.text(`Period 3 (9:20-10:00): ${schedule[day].period3 || 'Not assigned'}`, 30, yPosition + 30);
                doc.text(`Break: ${schedule[day].breakStart || '10:00'} - ${schedule[day].breakEnd || '10:20'}`, 30, yPosition + 40);
                doc.text(`Period 4 (After Break): ${schedule[day].period4 || 'Not assigned'}`, 30, yPosition + 50);
                doc.text(`Period 5 (Last Period): ${schedule[day].period5 || 'Not assigned'}`, 30, yPosition + 60);
                
                yPosition += 80;
            });
            
            // Download PDF
            doc.save(`Yearly_Teaching_Plan_Grade_${yearlyPlan.grade}.pdf`);
            alert('‚úÖ Yearly plan downloaded as PDF!');
        }

        // Load existing plan if available
        document.addEventListener('DOMContentLoaded', function() {
            const savedPlan = localStorage.getItem('yearlyPlan');
            if (savedPlan) {
                const planData = JSON.parse(savedPlan);
                
                // Add a "View Existing Plan" button
                const welcomeSection = document.querySelector('.welcome-section');
                welcomeSection.innerHTML += `
                    <div class="existing-plan-notice">
                        <p>üìã You have an existing yearly plan for Grade ${planData.grade}</p>
                        <button onclick="showYearlyCalendar()" class="btn btn-success">View Your Schedule</button>
                        <button onclick="clearPlan()" class="btn btn-secondary">Start Fresh</button>
                    </div>
                `;
            }
        });

        function clearPlan() {
            if (confirm('Are you sure you want to delete your existing yearly plan and start fresh?')) {
                localStorage.removeItem('yearlyPlan');
                location.reload();
            }
        }
    </script>
    
    <style>
        :root {
            --soft-blue: #6c9bd1;
            --sage-green: #9cbc88;
            --warm-pink: #f4a6cd;
            --sunny-yellow: #ffd93d;
            --lavender: #b19cd9;
            --mint-green: #98e4d6;
            --peach: #ffab91;
            --light-gray: #f5f5f5;
            --border-gray: #e0e0e0;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--soft-blue), var(--sage-green));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .nav-title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .nav-welcome {
            font-weight: 500;
        }
        
        .logout-link {
            background-color: rgba(255,255,255,0.2);
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .planner-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .welcome-section h1 {
            color: var(--soft-blue);
            margin-bottom: 0.5rem;
        }
        
        .welcome-subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .step-1 {
            background: var(--light-gray);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .step-1 h3 {
            color: var(--sage-green);
            margin-bottom: 1.5rem;
        }
        
        .selection-area {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--soft-blue);
        }
        
        .subject-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .checkbox-label:hover {
            background: var(--mint-green);
        }
        
        .checkbox-label input {
            margin-right: 0.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--soft-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a87c4;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--border-gray);
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .btn-success {
            background: var(--sage-green);
            color: white;
        }
        
        .btn-success:hover {
            background: #8aaa76;
            transform: translateY(-2px);
        }
        
        .next-btn {
            width: 100%;
            margin-top: 1rem;
        }
        
        .weekly-schedule {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .day-schedule {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .day-schedule h4 {
            color: var(--sage-green);
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: var(--light-gray);
            border-radius: 6px;
        }
        
        .periods {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .period-slot {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .period-slot label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }
        
        .period-select {
            padding: 0.5rem;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .break-time {
            text-align: center;
            padding: 0.5rem;
            background: var(--peach);
            border-radius: 6px;
            margin: 0.5rem 0;
        }
        
        .break-time p {
            margin: 0;
            font-weight: 500;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .grade-subjects-info {
            text-align: center;
            background: var(--mint-green);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        
        .yearly-calendar {
            background: var(--light-gray);
            padding: 2rem;
            border-radius: 12px;
        }
        
        .yearly-calendar h3 {
            color: var(--sage-green);
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .plan-info {
            text-align: center;
            background: var(--sunny-yellow);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .calendar-instruction {
            text-align: center;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }
        
        .week-button {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .week-button:hover {
            background: var(--soft-blue);
            color: white;
            transform: translateY(-2px);
        }
        
        .existing-plan-notice {
            background: var(--warm-pink);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }
        
        .existing-plan-notice p {
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .existing-plan-notice .btn {
            margin: 0 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: var(--mint-green);
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0 1rem;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .weekly-schedule {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>